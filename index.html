<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏û‡∏¥‡∏ô ‡∏Ñ‡πâ‡∏≤‡∏™‡πà‡∏á-‡∏õ‡∏•‡∏µ‡∏Å POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Kanit', sans-serif; touch-action: manipulation; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .smooth-scroll { -webkit-overflow-scrolling: touch; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .badge-pulse { animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 6px rgba(37, 99, 235, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Navbar -->
    <nav class="bg-gradient-to-r from-blue-700 to-blue-900 text-white p-3 shadow-lg flex justify-between items-center z-30 shrink-0 gap-3">
        <div class="flex items-center gap-2 overflow-hidden shrink-0">
            <div class="bg-white text-blue-700 p-1.5 rounded-full w-9 h-9 flex items-center justify-center font-bold shadow shrink-0">üè™</div>
            <div class="flex flex-col">
                <h1 class="text-lg font-bold tracking-wide whitespace-nowrap truncate hidden sm:block">‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏û‡∏¥‡∏ô</h1>
                <h1 class="text-lg font-bold tracking-wide whitespace-nowrap truncate sm:hidden">‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏û‡∏¥‡∏ô</h1>
                <span id="dateTimeDisplay" class="text-sm sm:text-2xl text-blue-200 font-mono leading-none">...</span>
            </div>
        </div>
        
        <div id="adminToolbar" class="flex gap-2 overflow-x-auto hide-scrollbar smooth-scroll items-center flex-1 justify-end min-w-0">
             <div onclick="toggleStoreStatus()" class="cursor-pointer bg-white/10 hover:bg-white/20 rounded-full px-2 py-1 flex items-center gap-2 transition mr-2 border border-white/20 group">
                <div id="storeToggleBg" class="w-10 h-5 rounded-full relative transition-colors duration-300 shadow-inner flex items-center">
                    <div id="storeToggleDot" class="w-4 h-4 bg-white rounded-full absolute shadow-md transform transition-transform duration-300 left-0.5"></div>
                </div>
                <span id="storeStatusText" class="text-xs font-bold text-white group-hover:text-blue-100 min-w-[35px]">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô</span>
            </div>

            <button onclick="openQRModal()" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-lg text-sm transition border border-white/20 shrink-0 font-bold"><i class="fas fa-qrcode"></i> <span class="hidden sm:inline">QR ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span></button>
            <button onclick="openKitchenModal()" class="relative bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-lg flex items-center gap-2 text-sm transition border border-white/20 whitespace-nowrap shrink-0">
                <i class="fas fa-box-open"></i> <span class="hidden sm:inline">‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á</span>
                <span id="kitchenBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-white hidden badge-pulse shadow-md z-50">0</span>
            </button>
            <button onclick="openSalesModal()" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-lg text-sm transition border border-white/20 shrink-0"><i class="fas fa-chart-line"></i></button>
            <button onclick="openHistoryModal()" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-lg text-sm transition border border-white/20 shrink-0"><i class="fas fa-history"></i></button>
            <button onclick="openAddMenuModal()" class="bg-green-500 hover:bg-green-400 text-white px-3 py-1.5 rounded-lg text-sm shadow-lg font-bold whitespace-nowrap shrink-0 border border-green-600"><i class="fas fa-plus"></i> <span class="hidden sm:inline">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span></button>
        </div>

        <div id="customerToolbar" class="hidden flex items-center justify-end gap-2 flex-1">
             <button onclick="openMyRecentOrder()" class="bg-white/20 hover:bg-white/30 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm flex items-center gap-1 border border-white/30 active:scale-95 transition">
                <i class="fas fa-receipt"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á
            </button>
            
            <div class="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-xs font-bold shadow-sm flex items-center gap-1 animate-pulse"><i class="fas fa-clock"></i> ‡∏£‡∏≠‡∏≠‡∏µ‡∏Å <span id="queueCountDisplay">0</span> ‡∏Ñ‡∏¥‡∏ß</div>
            <span class="bg-white/20 px-3 py-1 rounded-full text-sm font-bold text-white"><i class="fas fa-user mr-1"></i> <span id="customerTableDisplay">...</span></span>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden relative">
        <!-- Left: Menu Area -->
        <div class="flex-1 flex flex-col bg-gray-100 h-full min-w-0">
            <!-- SEARCH BAR -->
            <div class="bg-white p-3 shadow-sm z-20 border-b border-gray-200">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-barcode text-gray-400"></i></div>
                    <input type="text" id="searchInput" onkeyup="searchMenu()" onkeydown="handleSearchKeydown(event)" class="block w-full pl-10 pr-3 py-2.5 border border-gray-200 rounded-xl leading-5 bg-gray-50 text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 sm:text-sm transition shadow-inner" placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...">
                    <div class="absolute inset-y-0 right-0 pr-2 flex items-center"><button onclick="clearSearch()" class="text-gray-400 hover:text-gray-600 p-1 hidden" id="clearSearchBtn"><i class="fas fa-times-circle"></i></button></div>
                </div>
            </div>

            <!-- CATEGORY BAR -->
            <div class="p-2 bg-white shadow-sm border-b border-gray-200 flex gap-2 overflow-x-auto whitespace-nowrap z-10 shrink-0 smooth-scroll hide-scrollbar" id="categoryBar"></div>

            <!-- MENU GRID -->
            <div class="flex-1 overflow-y-auto p-4 pb-24 lg:pb-4 relative custom-scrollbar bg-gray-100" id="menuContainer">
                <div id="loadingMenu" class="absolute inset-0 flex flex-col items-center justify-center bg-white/80 z-20 backdrop-blur-sm hidden"><i class="fas fa-circle-notch fa-spin text-4xl text-blue-500 mb-3"></i><p class="text-gray-500 font-medium animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</p></div>
                <div id="menuGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-3 lg:gap-4 content-start"></div>
                
                <!-- No Results / Error State -->
                <div id="noResults" class="hidden flex flex-col items-center justify-center py-10 text-gray-400 text-center">
                    <i class="fas fa-box-open text-6xl mb-4 text-gray-300"></i>
                    <p class="mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                    <button onclick="fetchMenu()" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-200 transition">
                        <i class="fas fa-sync-alt mr-1"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
            </div>
        </div>

        <!-- Right: Cart Area -->
        <div id="cartPanel" class="hidden lg:flex flex-col w-full lg:w-[400px] bg-white shadow-2xl border-l border-gray-200 z-40 fixed inset-0 lg:static lg:h-auto animate-slide-up lg:animate-none">
            <div class="lg:hidden bg-blue-700 text-white p-4 flex justify-between items-center shadow-md shrink-0"><h2 class="text-xl font-bold"><i class="fas fa-shopping-cart mr-2"></i>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2><button onclick="toggleCart(false)" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-down"></i></button></div>
            
            <!-- Cart Header with Hold/Recall -->
            <div class="hidden lg:flex flex-col bg-blue-50 border-b border-blue-100 shrink-0">
                <div class="p-4 pb-2 flex items-center justify-between">
                     <h2 class="text-lg font-bold text-blue-800 flex items-center gap-2"><i class="fas fa-shopping-cart"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>
                     <span id="cartCountDesktop" class="bg-blue-200 text-blue-800 text-xs font-bold px-2 py-1 rounded-full">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                </div>
                <div class="flex gap-2 px-4 pb-3">
                    <button onclick="holdBill()" class="flex-1 bg-white text-orange-600 border border-orange-200 hover:bg-orange-50 text-xs font-bold py-1.5 rounded-lg transition shadow-sm"><i class="fas fa-pause mr-1"></i> ‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•</button>
                    <button onclick="openRecallModal()" class="flex-1 bg-white text-blue-600 border border-blue-200 hover:bg-blue-50 text-xs font-bold py-1.5 rounded-lg transition shadow-sm"><i class="fas fa-history mr-1"></i> ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ö‡∏¥‡∏•</button>
                </div>
            </div>

            <div id="cartItems" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white"><div class="h-full flex flex-col items-center justify-center text-gray-400 opacity-60"><i class="fas fa-cash-register text-6xl mb-4"></i><p>‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p></div></div>
            <div class="p-5 bg-white border-t border-gray-200 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] shrink-0 pb-safe">
                <div class="flex justify-between items-end mb-4"><span class="text-gray-500 text-sm font-medium">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span><span class="text-3xl font-bold text-blue-600 tracking-tight" id="totalPrice">0 ‡∏ø</span></div>
                <button onclick="handleCheckoutClick()" id="btnOrder" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 text-lg transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none flex justify-center items-center gap-2" disabled><span>‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô</span> <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- Mobile Bottom Bar -->
        <div id="mobileBottomBar" onclick="toggleCart(true)" class="lg:hidden fixed bottom-4 left-4 right-4 bg-gray-900 text-white p-4 rounded-2xl shadow-2xl flex justify-between items-center z-20 cursor-pointer transform transition-all duration-300 translate-y-[150%] active:scale-95 border border-gray-700/50 backdrop-blur-md bg-opacity-95">
            <div class="flex items-center gap-3"><div class="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold shadow-lg ring-2 ring-blue-900" id="mobileCartCount">0</div><div class="flex flex-col"><span class="text-xs text-gray-400">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span class="font-bold text-lg leading-none" id="mobileCartTotal">0 ‡∏ø</span></div></div>
            <div class="flex items-center gap-2 text-blue-400 font-bold text-sm">‡∏î‡∏π‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ <i class="fas fa-chevron-up"></i></div>
        </div>
    </div>

    <!-- Modals -->
    <!-- QR Modal -->
    <div id="qrModal" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop"><div class="bg-gray-800 p-4 text-white flex justify-between items-center"><h3 class="font-bold text-lg"><i class="fas fa-qrcode mr-2"></i>QR ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏±‡πà‡∏á</h3><button onclick="closeModal('qrModal')" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8"><i class="fas fa-times"></i></button></div><div class="p-6 text-center space-y-4"><div id="qrResult" class="flex flex-col items-center pt-2"><img id="qrImage" class="w-56 h-56 border-4 border-white shadow-lg mb-3" src=""><p class="text-sm text-gray-500 mb-2">‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p><a id="qrLink" href="#" target="_blank" class="text-blue-600 text-xs underline break-all">‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå</a></div></div></div></div>
    
    <!-- Recall Bill Modal -->
    <div id="recallModal" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop flex flex-col max-h-[80vh]"><div class="bg-blue-600 p-4 text-white flex justify-between items-center shrink-0"><h3 class="font-bold text-lg"><i class="fas fa-history mr-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•‡πÑ‡∏ß‡πâ</h3><button onclick="closeModal('recallModal')" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8"><i class="fas fa-times"></i></button></div><div id="heldBillsList" class="p-4 overflow-y-auto space-y-2 bg-gray-50 flex-1"></div></div></div>

    <!-- Toast & Alerts -->
    <div id="toast" class="fixed top-5 right-5 z-[100] transform transition-all duration-300 translate-x-[150%] bg-white border-l-4 border-green-500 shadow-2xl rounded-lg p-4 flex items-center gap-3 min-w-[300px]"><div class="bg-green-100 text-green-600 rounded-full w-8 h-8 flex items-center justify-center shrink-0"><i class="fas fa-check"></i></div><div><h4 class="font-bold text-gray-800 text-sm">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h4><p class="text-xs text-gray-500" id="toastMsg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</p></div></div>
    <div id="customAlert" class="fixed inset-0 z-[100] bg-black/70 hidden flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"><div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center animate-pop"><div id="alertIcon" class="text-5xl mb-4"></div><h3 id="alertTitle" class="text-xl font-bold text-gray-800 mb-2"></h3><p id="alertMsg" class="text-gray-500 mb-6 text-sm"></p><button onclick="closeCustomAlert()" class="w-full bg-gray-800 hover:bg-gray-900 text-white py-3 rounded-xl font-bold">‡∏ï‡∏Å‡∏•‡∏á</button></div></div>
    <div id="confirmActionModal" class="fixed inset-0 z-[110] bg-black/70 hidden flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"><div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center animate-pop"><div id="confirmActionIcon" class="text-5xl mb-4 text-red-500"></div><h3 id="confirmActionTitle" class="text-xl font-bold text-gray-800 mb-2"></h3><p id="confirmActionMsg" class="text-gray-500 mb-6 text-sm"></p><div class="flex gap-4"><button onclick="closeModal('confirmActionModal')" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 rounded-xl font-bold transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button id="btnConfirmAction" onclick="" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div></div></div>
    
    <!-- PromptPay Setting Modal -->
    <div id="promptPayModal" class="fixed inset-0 bg-black/60 hidden z-[80] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop">
            <div class="bg-blue-600 p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-cog mr-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</h3>
                <button onclick="closeModal('promptPayModal')" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-center gap-3">
                    <img src="https://promptpay.io/logo.png" class="w-12 h-auto opacity-80" onerror="this.style.display='none'">
                    <div>
                        <p class="text-sm font-bold text-blue-900">‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                        <p class="text-[10px] text-blue-600">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô/Tax ID</p>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-600 text-sm font-bold mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</label>
                    <input type="tel" id="ppInput" class="w-full text-xl font-bold text-center border-2 border-gray-300 rounded-xl p-3 focus:border-blue-500 outline-none tracking-wider text-blue-700 placeholder-gray-300" placeholder="08X-XXX-XXXX">
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="clearPromptPayID()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-500 font-bold py-3 rounded-xl transition">‡∏•‡∏ö / ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                    <button onclick="savePromptPayID()" class="flex-[2] bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Manage QR Modal -->
    <div id="manageQRModal" class="fixed inset-0 bg-black/60 hidden z-[85] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop">
            <div class="bg-gray-800 p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-image mr-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ QR Code</h3>
                <button onclick="closeModal('manageQRModal')" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 text-center space-y-4">
                <div class="bg-gray-100 p-6 rounded-xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center">
                    <div id="mqrStatusIcon" class="text-4xl text-gray-300 mb-2"><i class="fas fa-image"></i></div>
                    <p id="mqrStatusText" class="text-gray-500 font-medium">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                </div>
                
                <div class="flex flex-col gap-3 pt-2">
                    <button onclick="document.getElementById('bankQRInput').click()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition flex justify-center items-center gap-2">
                        <i class="fas fa-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà
                    </button>
                    <button id="btnDeleteQR" onclick="deleteServerQR()" class="w-full bg-red-100 hover:bg-red-200 text-red-600 font-bold py-3 rounded-xl transition hidden">
                        <i class="fas fa-trash-alt mr-1"></i> ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="deliveryNotificationModal" class="fixed inset-0 bg-black/80 hidden z-[120] flex items-center justify-center p-4 backdrop-blur-md animate-fade-in">
        <div class="bg-white rounded-3xl shadow-[0_0_50px_rgba(37,99,235,0.25)] w-full max-w-sm overflow-hidden animate-pop relative">
            <div class="bg-gradient-to-br from-green-400 to-green-600 h-32 flex items-center justify-center relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                <div class="bg-white/20 p-6 rounded-full shadow-lg backdrop-blur-sm animate-bounce">
                    <i class="fas fa-shipping-fast text-5xl text-white"></i>
                </div>
            </div>
            
            <div class="p-8 text-center">
                <h3 class="text-2xl font-extrabold text-gray-800 mb-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏™‡πà‡∏á!</h3>
                <div class="w-16 h-1 bg-green-500 mx-auto rounded-full mb-4"></div>
                <p class="text-gray-500 mb-8 leading-relaxed">‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞</p>
                
                <button onclick="closeModal('deliveryNotificationModal')" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-4 rounded-2xl shadow-lg transition transform active:scale-95 text-lg">
                    ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞ üëç
                </button>
            </div>
        </div>
    </div>

    <div id="storeClosedModal" class="fixed inset-0 bg-gray-900 z-[200] hidden flex items-center justify-center p-6 animate-fade-in bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
        <div class="bg-gray-800/90 backdrop-blur-xl border border-gray-700 rounded-3xl shadow-[0_0_50px_rgba(239,68,68,0.3)] w-full max-w-sm overflow-hidden text-center relative animate-pop">
            <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-32 h-1 bg-red-500 shadow-[0_0_20px_rgba(239,68,68,1)]"></div>
            
            <div class="p-10">
                <div class="w-24 h-24 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner relative">
                    <i class="fas fa-store-slash text-5xl text-gray-400"></i>
                    <div class="absolute -bottom-2 -right-2 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg border-2 border-gray-800">CLOSED</div>
                </div>
                
                <h2 class="text-3xl font-extrabold text-white mb-2 tracking-wide">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß</h2>
                <p class="text-gray-400 mb-8 font-light">‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£<br>‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞</p>
                
                <div class="flex justify-center gap-2">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            </div>
            
            <div class="bg-gray-900/50 p-4 border-t border-gray-700">
                <p class="text-xs text-gray-500">‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏û‡∏¥‡∏ô ‡∏Ñ‡πâ‡∏≤‡∏™‡πà‡∏á-‡∏õ‡∏•‡∏µ‡∏Å</p>
            </div>
        </div>
    </div>
    
    <div id="myOrderModal" class="fixed inset-0 bg-black/60 hidden z-[130] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-pop flex flex-col max-h-[80vh]">
            <div class="bg-blue-600 p-4 text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold"><i class="fas fa-clipboard-list mr-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                <button onclick="closeModal('myOrderModal')" class="bg-white/20 rounded-full w-8 h-8"><i class="fas fa-times"></i></button>
            </div>
            <div id="myOrderContent" class="p-4 overflow-y-auto flex-1 bg-gray-50">
                <p class="text-center text-gray-400 mt-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
            </div>
        </div>
    </div>


    <div id="minOrderModal" class="fixed inset-0 bg-black/80 hidden z-[130] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop text-center relative border border-gray-100">
            <div class="bg-gradient-to-br from-orange-400 to-red-500 h-28 flex items-center justify-center relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>
                <div class="bg-white p-4 rounded-full shadow-lg mt-8 relative z-10">
                    <i class="fas fa-shopping-basket text-4xl text-orange-500"></i>
                    <div class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold w-6 h-6 flex items-center justify-center rounded-full border-2 border-white">!</div>
                </div>
            </div>
            
            <div class="pt-10 pb-8 px-8">
                <h3 class="text-2xl font-extrabold text-gray-800 mb-2">‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100 ‡∏ö‡∏≤‡∏ó</h3>
                <p class="text-gray-500 mb-6 text-sm leading-relaxed">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏°‡∏µ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏™‡πà‡∏á<br>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ 100 ‡∏ö‡∏≤‡∏ó‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏ô‡∏∞‡∏Ñ‡∏∞</p>
                
                <div class="bg-orange-50 rounded-xl p-4 border border-orange-100 mb-6">
                    <p class="text-gray-600 text-xs font-bold uppercase mb-1">‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å</p>
                    <p class="text-orange-600 font-extrabold text-3xl"><span id="diffAmount">0</span> <span class="text-sm text-gray-400">‡∏ö‡∏≤‡∏ó</span></p>
                </div>

                <button onclick="closeModal('minOrderModal')" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                    <i class="fas fa-cart-plus"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°
                </button>
            </div>
        </div>
    </div>



    <div id="confirmOrderModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-end lg:items-center justify-center p-0 lg:p-4 backdrop-blur-sm">
        <div class="bg-white rounded-t-2xl lg:rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up h-[90vh] lg:h-auto flex flex-col">
            <div class="bg-blue-700 p-4 text-white flex justify-between items-center shrink-0"><h3 class="font-bold text-lg"><i class="fas fa-clipboard-check mr-2"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3><button onclick="closeModal('confirmOrderModal')" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8"><i class="fas fa-times"></i></button></div>
            <div class="p-6 overflow-y-auto flex-1">
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-4 max-h-40 overflow-y-auto" id="summaryList"></div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà</label><input type="text" id="tableNo" class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-blue-500 outline-none text-center text-xl font-bold bg-gray-50" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1 ‡∏´‡∏£‡∏∑‡∏≠ A"></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="orderType" onchange="toggleAddressFields()" class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-blue-500 outline-none bg-white font-bold text-gray-700 h-full"><option value="‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô">üõí ‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</option><option value="‡∏™‡πà‡∏á‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà">üõµ ‡∏™‡πà‡∏á‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà</option><option value="‡∏à‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô">üì¶ ‡∏à‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô</option></select></div>
                    </div>
                    <div id="addressSection" class="hidden bg-blue-50 p-3 rounded-xl border border-blue-200 animate-fade-in">
                        <label class="block text-xs font-bold text-blue-800 uppercase mb-2"><i class="fas fa-map-marker-alt text-blue-500"></i> ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
                        <div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] text-gray-500 font-bold">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label><input type="text" id="addrHouseNo" class="w-full border border-blue-200 rounded-lg p-2 focus:border-blue-500 outline-none text-sm bg-white" placeholder="123/45"></div><div><label class="text-[10px] text-gray-500 font-bold">‡∏ã‡∏≠‡∏¢ / ‡∏ñ‡∏ô‡∏ô</label><input type="text" id="addrSoi" class="w-full border border-blue-200 rounded-lg p-2 focus:border-blue-500 outline-none text-sm bg-white" placeholder="‡∏ã‡∏≠‡∏¢ 5"></div></div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea id="orderNote" class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-blue-500 outline-none text-sm" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏™‡πà‡∏ñ‡∏∏‡∏á‡πÅ‡∏¢‡∏Å, ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô..."></textarea></div>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 shrink-0"><button onclick="submitOrder()" id="btnSubmitOrder" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg text-lg flex justify-center items-center gap-2 transition-all active:scale-95"><span class="btn-text">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span> <i class="fas fa-check-circle"></i></button></div>
        </div>
    </div>
    
    <div id="kitchenModal" class="fixed inset-0 bg-gray-100 hidden z-50 flex flex-col animate-slide-up"><div class="bg-orange-600 p-4 text-white flex justify-between items-center shadow-md shrink-0"><h3 class="font-bold text-lg"><i class="fas fa-box mr-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° (‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô)</h3><div class="flex gap-2"><button onclick="fetchOrders()" class="bg-white/20 rounded px-3 py-1"><i class="fas fa-sync-alt"></i></button><button onclick="closeModal('kitchenModal')" class="bg-white/20 rounded px-3 py-1"><i class="fas fa-times"></i></button></div></div><div class="flex-1 overflow-y-auto p-4 bg-gray-100 custom-scrollbar"><div id="kitchenGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-10"></div></div></div>
    
    <!-- Payment Modal (Updated: Dynamic PromptPay) -->
    <div id="paymentModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-end lg:items-center justify-center p-0 lg:p-4 backdrop-blur-sm">
        <div class="bg-white rounded-t-2xl lg:rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-slide-up h-auto flex flex-col max-h-[90vh]">
            <div class="bg-green-600 p-4 text-white flex justify-between items-center shrink-0"><h3 class="font-bold text-lg">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3><button onclick="closeModal('paymentModal')" class="bg-white/20 rounded-full w-8 h-8"><i class="fas fa-times"></i></button></div>
            <div class="p-6 flex-1 overflow-y-auto">
                
                <!-- NEW: Bank QR Code Section with Upload -->
                <div class="mb-6 flex flex-col items-center">
                    <!-- Added id to this container to handle click logic properly -->
                    <div id="qrDisplayContainer" class="bg-white p-3 rounded-xl shadow-md border border-gray-200 text-center relative w-full max-w-xs group cursor-pointer" onclick="handleQRClick()">
                        <!-- Dynamic QR Image -->
                        <div class="relative overflow-hidden rounded-lg bg-gray-50 min-h-[200px] flex items-center justify-center">
                            <img id="bankQRImage" src="https://placehold.co/400x400?text=PromptPay" class="w-full h-auto object-contain max-h-[250px]" alt="QR Code ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô" onerror="this.src='https://placehold.co/400x400?text=PromptPay+Error'">
                            <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300">
                                <span class="text-white font-bold"><i class="fas fa-cog mr-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                            </div>
                        </div>
                        <p class="text-sm font-bold text-gray-600 mt-2" id="ppLabel">‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô (PromptPay)</p>
                        <!-- Hidden file input for uploading custom image if they prefer -->
                        <input type="file" id="bankQRInput" class="hidden" accept="image/*" onchange="uploadBankQRFile(this)">
                    </div>
                    
                    <div class="flex gap-2 mt-2">
                         <button onclick="openPromptPayModal()" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-200 transition">
                            <i class="fas fa-cog mr-1"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå
                        </button>
                        <!-- CHANGED: Click calls checkAndUseOriginalQR() instead of input click -->
                        <button id="btnUseOriginal" onclick="checkAndUseOriginalQR()" class="bg-gray-100 text-gray-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-gray-200 transition flex items-center gap-1">
                            <i class="fas fa-image"></i> <span class="btn-text">‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°</span>
                        </button>
                    </div>
                </div>

                <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà) -->
                <div class="bg-gradient-to-b from-gray-50 to-white p-4 rounded-3xl border-2 border-blue-100 mb-6 text-center shadow-inner relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-blue-500"></div>
                    
                    <!-- ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô) -->
                    <div class="mb-4">
                        <p class="text-gray-500 font-bold text-xs uppercase tracking-widest mb-1">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        <div class="flex items-center justify-center gap-1">
                            <h1 class="text-6xl sm:text-7xl font-bold text-gray-800 tracking-tighter drop-shadow-sm" id="payTotalDisplay">0</h1>
                            <span class="text-2xl text-gray-400 font-bold mt-4">‡∏ø</span>
                        </div>
                    </div>

                    <!-- ‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏±‡πà‡∏ô -->
                    <div class="border-t border-dashed border-gray-300 w-3/4 mx-auto mb-4"></div>

                    <!-- ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÑ‡∏î‡πâ) -->
                    <div>
                        <p class="text-gray-500 font-bold text-xs uppercase tracking-widest mb-1">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</p>
                        <div class="flex items-center justify-center gap-1">
                            <h2 class="text-4xl sm:text-5xl font-bold text-gray-300 transition-all duration-300 transform scale-100" id="changeDisplay">0.00</h2>
                            <span class="text-xl text-gray-300 font-bold mt-2 transition-colors duration-300" id="changeCurrency">‡∏ø</span>
                        </div>
                    </div>
                </div>

                <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏á‡∏¥‡∏ô -->
                <div class="mb-4 relative">
                    <label class="block text-xs font-bold text-blue-600 mb-2 pl-1 uppercase">‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤</label>
                    <div class="relative">
                        <input type="number" id="inputReceived" oninput="calcChange()" onkeydown="checkPaymentEnter(event)" 
                               class="w-full text-4xl font-bold text-right border-2 border-gray-200 rounded-2xl p-4 pr-12 text-blue-600 placeholder-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none transition-all shadow-sm" 
                               placeholder="0">
                        <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 font-bold text-xl">‡∏ø</span>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-2 mb-2">
                    <button onclick="addMoney(20)" class="money-btn bg-gray-50 hover:bg-gray-100 p-2 rounded font-bold text-gray-600 border">20</button>
                    <button onclick="addMoney(50)" class="money-btn bg-gray-50 hover:bg-gray-100 p-2 rounded font-bold text-gray-600 border">50</button>
                    <button onclick="addMoney(100)" class="money-btn bg-gray-50 hover:bg-gray-100 p-2 rounded font-bold text-gray-600 border">100</button>
                    <button onclick="addMoney(500)" class="money-btn bg-gray-50 hover:bg-gray-100 p-2 rounded font-bold text-gray-600 border">500</button>
                    <button onclick="addMoney(1000)" class="money-btn bg-gray-50 hover:bg-gray-100 p-2 rounded font-bold text-gray-600 border">1k</button>
                    <button onclick="setExactMoney()" class="bg-blue-100 text-blue-700 border border-blue-200 p-2 rounded font-bold col-span-2">‡∏û‡∏≠‡∏î‡∏µ</button>
                    <button onclick="clearMoney()" class="bg-red-100 text-red-700 border border-red-200 p-2 rounded font-bold">C</button>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 shrink-0"><button onclick="confirmPayment()" id="btnConfirmPay" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl text-xl disabled:opacity-50" disabled>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•</button></div>
        </div>
    </div>
    
    <div id="editMenuModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-pop"><div class="bg-yellow-500 p-4 flex justify-between items-center text-white"><h3 class="font-bold text-lg text-black">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3><button onclick="closeModal('editMenuModal')" class="bg-black/10 rounded-full w-8 h-8 text-black"><i class="fas fa-times"></i></button></div><form id="editMenuForm" class="p-6 space-y-4"><input type="hidden" id="eId"><div><label class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" id="eName" required class="input-box"></div><div class="flex gap-4"><div class="flex-1"><label class="label">‡∏£‡∏≤‡∏Ñ‡∏≤</label><input type="number" id="ePrice" required class="input-box"></div><div class="flex-1"><label class="label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><select id="eCategory" class="input-box"></select></div></div><div class="flex gap-3 pt-2"><button type="button" onclick="deleteMenu()" id="btnDeleteMenu" class="flex-1 bg-red-50 text-red-600 font-bold py-3 rounded-xl border border-red-200">‡∏•‡∏ö</button><button type="submit" id="btnEditSave" class="flex-[2] bg-yellow-500 text-black font-bold py-3 rounded-xl shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></form></div></div>
    
    <div id="addModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
         <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-pop">
            <div class="bg-green-600 p-4 flex justify-between items-center text-white"><h3 class="font-bold text-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3><button onclick="closeModal('addModal')" class="bg-white/20 rounded-full w-8 h-8"><i class="fas fa-times"></i></button></div>
            <form id="addMenuForm" class="p-6 space-y-4">
                <div class="mb-4 bg-gray-50 p-3 rounded-xl border border-dashed border-gray-300">
                    <label class="label text-gray-600 font-bold flex items-center gap-2 mb-2"><i class="fas fa-barcode text-gray-400"></i> ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / Barcode <span class="text-[10px] font-normal text-gray-400 bg-white px-2 py-0.5 rounded-full border border-gray-200">‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</span></label>
                    <div class="relative"><input type="text" id="mCode" class="input-box pl-10 font-mono text-blue-600 font-bold tracking-wider placeholder-gray-300 focus:bg-white transition-colors" placeholder="‡∏™‡πÅ‡∏Å‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-tag text-gray-300"></i></div></div>
                    <p class="text-[10px] text-gray-400 mt-1.5 ml-1"><i class="fas fa-info-circle"></i> ‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏∏ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô ID ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                </div>
                <div><label class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" id="mName" required class="input-box"></div>
                <div class="flex gap-4"><div class="flex-1"><label class="label">‡∏£‡∏≤‡∏Ñ‡∏≤</label><input type="number" id="mPrice" required class="input-box"></div><div class="flex-1"><label class="label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><select id="mCategory" class="input-box"></select></div></div>
                <div><label class="label">‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="file" id="mFile" accept="image/*" class="w-full text-sm"></div>
                <button type="submit" id="btnSaveMenu" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow mt-2 flex justify-center items-center gap-2"><span class="btn-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span> <i class="fas fa-save"></i></button>
            </form>
        </div>
    </div>
    
    <div id="salesModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-pop"><div class="bg-blue-600 p-4 text-white flex justify-between items-center"><h3 class="font-bold">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h3><button onclick="closeModal('salesModal')"><i class="fas fa-times"></i></button></div><div class="p-6 space-y-4"><div class="bg-blue-50 p-4 rounded-xl text-center border border-blue-100"><p class="text-gray-500 text-xs uppercase font-bold">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p><h2 class="text-4xl font-bold text-blue-600 mt-1" id="saleToday">...</h2></div><div class="grid grid-cols-2 gap-4"><div class="bg-gray-50 p-3 rounded-xl text-center"><p class="text-xs text-gray-400">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô</p><h3 class="font-bold text-gray-700" id="saleYest">...</h3></div><div class="bg-gray-50 p-3 rounded-xl text-center"><p class="text-xs text-gray-400">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p><h3 class="font-bold text-gray-700" id="saleMonth">...</h3></div></div></div></div></div>
    <div id="historyModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl h-[80vh] flex flex-col animate-pop"><div class="bg-gray-800 p-4 text-white flex justify-between items-center"><h3 class="font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 400 ‡∏ö‡∏¥‡∏•)</h3><button onclick="closeModal('historyModal')"><i class="fas fa-times"></i></button></div><div class="flex-1 overflow-y-auto p-4"><table class="w-full text-left border-collapse">
                <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="p-3 w-20">‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <th class="p-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                        <th class="p-3 text-right w-24">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                    </tr>
                </thead>
                <tbody id="historyList" class="text-sm divide-y divide-gray-100">
                    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </tbody>
            </table></table></div></div></div>
    <div id="billDetailModal" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-pop border border-gray-200"><div class="bg-gray-800 p-4 text-white flex justify-between items-center"><h3 class="font-bold text-lg">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏¥‡∏•</h3><button onclick="closeModal('billDetailModal')" class="bg-white/20 rounded-full w-8 h-8"><i class="fas fa-times"></i></button></div><div class="p-6" id="billDetailContent"></div><div class="bg-gray-50 p-4 border-t text-center"><button onclick="closeModal('billDetailModal')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button></div></div></div>

    <style>.label{display:block;font-size:.75rem;font-weight:700;color:#6b7280;text-transform:uppercase;margin-bottom:.25rem}.input-box{width:100%;border:2px solid #e5e7eb;border-radius:.75rem;padding:.75rem;outline:none;transition:border-color .2s}.input-box:focus{border-color:#3b82f6}</style>

    <script>
        // ‡πÉ‡∏™‡πà URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Web App Deployment ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        const API_URL = "https://script.google.com/macros/s/AKfycbxsEVswZLqeeijj4NAjeErT2mNaFbGdotAf_ZSo44APCCKgbDlGFf8DVG5FxpsiNRBLzQ/exec"; 
        
        // -------------------------------------------------------------
        // üî¥üî¥ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß üî¥üî¥
        // -------------------------------------------------------------
        // ID ‡πÄ‡∏î‡∏¥‡∏°‡∏ú‡∏¥‡∏î ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô: 1jx5XVDpGo5MAkykNbJ08eJgW5zTVVXmV
        const QR_FOLDER_ID = "1jx5XVDpGo5MAkykNbJ08eJgW5zTVVXmV"; 
        // -------------------------------------------------------------
        
        const mockMenuData = [
            { id: "M001", name: "‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå‡∏™‡∏¥‡∏á‡∏´‡πå", price: 65, category: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", image: "" },
            { id: "M002", name: "‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå‡∏•‡∏µ‡πÇ‡∏≠", price: 60, category: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", image: "" },
            { id: "M003", name: "‡πÄ‡∏•‡∏¢‡πå (‡∏´‡πà‡∏≠‡πÉ‡∏´‡∏ç‡πà)", price: 30, category: "‡∏Ç‡∏ô‡∏°/‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á", image: "" },
            { id: "M004", name: "‡∏Ñ‡∏≤‡∏£‡∏≤‡∏ö‡∏≤‡∏ß‡πÅ‡∏î‡∏á", price: 10, category: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", image: "" },
            { id: "M005", name: "‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤‡∏ó‡∏¥‡∏û‡∏£‡∏™", price: 35, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á", image: "" },
            { id: "M006", name: "‡πÑ‡∏Ç‡πà‡πÑ‡∏Å‡πà (‡πÄ‡∏ö‡∏≠‡∏£‡πå 2)", price: 4, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î", image: "" },
            { id: "M007", name: "‡∏ú‡∏á‡∏ã‡∏±‡∏Å‡∏ü‡∏≠‡∏Å‡∏ö‡∏£‡∏µ‡∏™", price: 20, category: "‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô", image: "" }
        ];

        let menuData = [];
        let masterData = [];
        let cart = [];
        let currentOrders = [];
        let currentPayOrder = null;
        let historyBills = [];
        let lastOrderCount = -1; 
        
        
        const categories = ['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°', '‡∏Ç‡∏ô‡∏°/‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', '‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î', '‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î'];
        
        let isCustomerMode = false;
        let customerTable = "";
        let isQuickPayMode = false; 
        let notifiedOrders = new Set();
        let isStoreOpen = true; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô
        let myLastOrders = [];  // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á

        function speak(text) { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); utterance.lang = 'th-TH'; utterance.rate = 1.0; window.speechSynthesis.speak(utterance); } }
        function playNotificationSound() { const beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"); beep.play().catch(e=>console.log("Audio blocked", e)); }
        
        function holdBill() {
            if(cart.length === 0) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•', 'warning'); return; }
            let heldBills = JSON.parse(localStorage.getItem('heldBills') || "[]");
            const newBill = { id: Date.now(), timestamp: new Date().toISOString(), items: cart, total: cart.reduce((sum, i) => sum + (i.price * i.qty), 0) };
            heldBills.push(newBill);
            localStorage.setItem('heldBills', JSON.stringify(heldBills));
            cart = []; renderCart();
            showToast('‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (' + heldBills.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)', 'success');
            speak("‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
        }

        function openRecallModal() {
            const heldBills = JSON.parse(localStorage.getItem('heldBills') || "[]");
            if (heldBills.length === 0) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ', 'warning'); return; }
            const listContainer = document.getElementById('heldBillsList');
            listContainer.innerHTML = heldBills.map((bill, index) => {
                const timeStr = new Date(bill.timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                return `<div class="bg-white border border-gray-200 rounded-xl p-3 shadow-sm hover:shadow-md transition flex justify-between items-center animate-fade-in"><div class="flex-1 cursor-pointer" onclick="recallBill(${index})"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded">${timeStr}</span><span class="font-bold text-gray-700">${bill.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></div><div class="text-sm text-gray-500 mt-1">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° <span class="text-blue-600 font-bold">${bill.total.toLocaleString()} ‡∏ø</span></div></div><button onclick="deleteHeldBill(${index})" class="w-8 h-8 rounded-full bg-red-50 text-red-500 hover:bg-red-100 flex items-center justify-center ml-2"><i class="fas fa-trash-alt text-xs"></i></button></div>`;
            }).join('');
            document.getElementById('recallModal').classList.remove('hidden');
        }

        function recallBill(index) {
            let heldBills = JSON.parse(localStorage.getItem('heldBills') || "[]");
            if (cart.length > 0) { if(!confirm("‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏´‡∏°?")) return; }
            cart = heldBills[index].items;
            heldBills.splice(index, 1); localStorage.setItem('heldBills', JSON.stringify(heldBills));
            closeModal('recallModal'); renderCart(); showToast('‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ö‡∏¥‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success'); speak("‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
        }

        function deleteHeldBill(index) {
            if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) return;
            let heldBills = JSON.parse(localStorage.getItem('heldBills') || "[]");
            heldBills.splice(index, 1); localStorage.setItem('heldBills', JSON.stringify(heldBills));
            if (heldBills.length === 0) { closeModal('recallModal'); showToast('‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success'); } else { openRecallModal(); }
        }

        function renderCategoryBar() {
            const bar = document.getElementById('categoryBar');
            bar.innerHTML = `<button onclick="filterMenu('All')" class="cat-btn bg-blue-600 text-white px-5 py-2 rounded-full shadow-md text-sm font-bold transition transform hover:scale-105 border border-blue-700 shrink-0">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>` + categories.map(c => `<button onclick="filterMenu('${c}')" class="cat-btn bg-white text-gray-600 hover:bg-blue-50 hover:text-blue-600 px-5 py-2 rounded-full shadow-sm text-sm font-medium transition border border-gray-200 shrink-0">${c}</button>`).join('');
        }

        function populateCategorySelects() {
            const opts = categories.map(c => `<option>${c}</option>`).join('');
            const mCat = document.getElementById('mCategory'); const eCat = document.getElementById('eCategory');
            if(mCat) mCat.innerHTML = opts; if(eCat) eCat.innerHTML = opts;
        }

        function initDateTime() {
            const updateTime = () => { const now = new Date(); document.getElementById('dateTimeDisplay').innerText = `${now.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' })} ${now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}`; };
            updateTime(); setInterval(updateTime, 1000);
        }

        function getDriveUrl(input) {
            if (!input) return '';
            let id = input;
            if (input.includes('drive.google.com/thumbnail')) return input;
            if (input.includes('http') || input.includes('google.com')) { const match = input.match(/[-\w]{25,}/); if (match) id = match[0]; }
            return `https://drive.google.com/thumbnail?id=${id}&sz=w800`;
        }

        function initBankQR() {
            const savedQR = localStorage.getItem('bankQRID');
            const promptPayID = localStorage.getItem('promptPayID');
            const amount = currentPayOrder ? currentPayOrder.totalPrice : 0;
            const imgEl = document.getElementById('bankQRImage');
            const labelEl = document.getElementById('ppLabel');

            if (promptPayID) {
                const payload = generatePayload(promptPayID, amount);
                imgEl.src = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${payload}`;
                labelEl.innerHTML = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå: ${promptPayID} <br><span class="text-blue-600 font-bold">‡∏¢‡∏≠‡∏î: ${amount.toLocaleString()} ‡∏ø</span>`;
            } else if (savedQR) {
                const url = getDriveUrl(savedQR);
                imgEl.src = url + "&t=" + new Date().getTime();
                labelEl.innerText = "‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô (‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)";
            } else {
                imgEl.src = "https://placehold.co/400x400?text=Set+PromptPay";
                labelEl.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå";
            }
        }
        
        function handleQRClick() {
            const hasPP = localStorage.getItem('promptPayID');
            const hasBankQR = localStorage.getItem('bankQRID');
            if (hasPP) { openPromptPayModal(); } else if (hasBankQR) { openManageQRModal(true); } else { openManageQRModal(false); }
        }

        function openPromptPayModal() {
            const current = localStorage.getItem('promptPayID') || '';
            document.getElementById('ppInput').value = current;
            document.getElementById('promptPayModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('ppInput').focus(), 300);
        }

        function savePromptPayID() {
            const newID = document.getElementById('ppInput').value;
            if (newID) {
                const cleanID = newID.trim().replace(/[^0-9]/g, '');
                if (cleanID.length === 10 || cleanID.length === 13) {
                    localStorage.setItem('promptPayID', cleanID); localStorage.removeItem('bankQRID');
                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PromptPay ‡πÅ‡∏•‡πâ‡∏ß', 'success'); initBankQR(); closeModal('promptPayModal');
                } else { alert("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 10 ‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ 13 ‡∏´‡∏•‡∏±‡∏Å"); }
            } else { clearPromptPayID(); }
        }

        function clearPromptPayID() {
            localStorage.removeItem('promptPayID'); document.getElementById('ppInput').value = '';
            showToast('‡∏•‡∏ö PromptPay ‡πÅ‡∏•‡πâ‡∏ß', 'success'); initBankQR(); closeModal('promptPayModal');
        }

        function checkAndUseOriginalQR() {
            setLoading('btnUseOriginal', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...'); 
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "checkQR", folderId: QR_FOLDER_ID }) })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success' && data.found && data.fileId) {
                    localStorage.setItem('bankQRID', data.fileId); localStorage.removeItem('promptPayID');
                    initBankQR(); showToast('‡∏ô‡∏≥‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
                } else { openManageQRModal(false); }
            })
            .catch(err => { console.error(err); openManageQRModal(false); showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'warning'); })
            .finally(() => { setLoading('btnUseOriginal', false, '‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°'); });
        }

        function openManageQRModal(hasFile) {
            const modal = document.getElementById('manageQRModal');
            const statusText = document.getElementById('mqrStatusText');
            const statusIcon = document.getElementById('mqrStatusIcon');
            const btnDelete = document.getElementById('btnDeleteQR');
            if (hasFile) {
                statusText.innerText = "‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"; statusText.classList.replace('text-gray-500', 'text-green-600');
                statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>'; btnDelete.classList.remove('hidden');
            } else {
                statusText.innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå"; statusText.classList.replace('text-green-600', 'text-gray-500');
                statusIcon.innerHTML = '<i class="fas fa-image"></i>'; btnDelete.classList.add('hidden');
            }
            modal.classList.remove('hidden');
        }

        function deleteServerQR() {
            if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
            setLoading('btnDeleteQR', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...');
            const currentFileId = localStorage.getItem('bankQRID');
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "deleteQR", folderId: QR_FOLDER_ID, fileId: currentFileId }) })
            .then(res => res.json()).then(data => {
                if(data.result === 'success') {
                    localStorage.removeItem('bankQRID'); initBankQR(); openManageQRModal(false); showToast('‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                } else { alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + data.error); }
            }).catch(err => { alert('Error: ' + err); }).finally(() => { setLoading('btnDeleteQR', false, '‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°'); });
        }

        function crc16(data) {
            let crc = 0xFFFF;
            for (let i = 0; i < data.length; i++) {
                let x = ((crc >> 8) ^ data.charCodeAt(i)) & 0xFF; x ^= x >> 4; crc = ((crc << 8) ^ (x << 12) ^ (x << 5) ^ x) & 0xFFFF;
            }
            return ('0000' + crc.toString(16).toUpperCase()).slice(-4);
        }

        function generatePayload(mobileNumber, amount) {
            const target = mobileNumber.replace(/[^0-9]/g, '');
            let targetFormatted = target;
            if (target.length === 10 && target.startsWith('0')) { targetFormatted = '66' + target.substring(1); }
            const merchantIdTag = (targetFormatted.length >= 13) ? '02' : '01'; 
            const merchantInfoValue = '0016A000000677010111' + merchantIdTag + ('00'+targetFormatted.length).slice(-2) + targetFormatted;
            const merchantInfo = '29' + ('00'+merchantInfoValue.length).slice(-2) + merchantInfoValue;
            const country = '5802TH'; const currency = '5303764'; 
            let amountTag = '';
            if (amount > 0) { const amtStr = parseFloat(amount).toFixed(2); amountTag = '54' + ('00'+amtStr.length).slice(-2) + amtStr; }
            const version = '000201'; const type = amount > 0 ? '010212' : '010211'; 
            const rawData = version + type + merchantInfo + country + currency + amountTag + '6304';
            return rawData + crc16(rawData);
        }

        window.onload = () => {
            checkMode(); initStoreStatus(); fetchMenu(); renderCategoryBar(); populateCategorySelects(); startOrderPolling(); initGlobalShortcuts(); initQuickAddShortcuts(); initDateTime();
        };

        function initGlobalShortcuts() {
            document.addEventListener('keydown', function(event) {
                const openModals = Array.from(document.querySelectorAll('div[id$="Modal"]')).filter(el => !el.classList.contains('hidden'));
                if (openModals.length > 0) return; 
                if (event.key === '.' || event.code === 'NumpadDecimal') {
                    const searchInput = document.getElementById('searchInput');
                    if (document.activeElement === searchInput) { return; }
                    event.preventDefault(); searchInput.focus(); searchInput.select();
                }
                if (event.key === '+' || event.code === 'NumpadAdd') {
                    event.preventDefault(); 
                    
                    // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 3: ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° + ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏•‡∏¢ ---
                    handleCheckoutClick();
                    // -----------------------------------------------
                }
            });
        }

        function initQuickAddShortcuts() {
             const mPrice = document.getElementById('mPrice');
             mPrice.addEventListener('keydown', function(event) {
                 if (event.key === 'Enter') {
                     event.preventDefault();
                     const mName = document.getElementById('mName');
                     const mCode = document.getElementById('mCode');
                     if(mName.value.trim() === "") { mName.value = "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ " + (mCode.value || "‡πÉ‡∏´‡∏°‡πà"); }
                     const priceVal = mPrice.value; const codeVal = mCode.value;
                     if(priceVal && codeVal) {
                         setLoading('btnSaveMenu', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'); 
                         const payload = { action: "addMenu", id: codeVal, name: mName.value, price: priceVal, category: document.getElementById('mCategory').value, spicy: "-", image: "", mimeType: "", fileName: "" };
                         sendAddMenu(payload);
                     } else { document.getElementById('btnSaveMenu').click(); }
                 }
             });
        }

        function startOrderPolling() { updateKitchenBadge().finally(() => { setTimeout(startOrderPolling, 3000); }); }

        function checkMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode'); const table = urlParams.get('table');
            if (mode === 'customer') {
                isCustomerMode = true; customerTable = table || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
                document.getElementById('adminToolbar').classList.add('hidden');
                document.getElementById('customerToolbar').classList.remove('hidden');
                document.getElementById('customerTableDisplay').innerText = customerTable;
                const tableInput = document.getElementById('tableNo');
                if(tableInput) { tableInput.value = customerTable; tableInput.readOnly = true; tableInput.classList.add('bg-gray-100', 'cursor-not-allowed'); }
            }
        }

        function openQRModal() { 
            document.getElementById('qrModal').classList.remove('hidden');
            const baseUrl = window.location.href.split('?')[0];
            const randomId = Math.floor(Math.random() * 10000); 
            const fullUrl = `${baseUrl}?mode=customer&table=${randomId}`;
            const qrApi = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(fullUrl)}`;
            document.getElementById('qrImage').src = qrApi; document.getElementById('qrLink').href = fullUrl; document.getElementById('qrLink').innerText = fullUrl;
        }

        function fetchMenu() {
            document.getElementById('loadingMenu').classList.remove('hidden');
            document.getElementById('noResults').classList.add('hidden');
            
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getMenu" }) }) // ‡∏î‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤ Menu
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    menuData = data.data; 
                    filterMenu('All'); // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                    
                    // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ---
                    fetchMasterList(); 
                } 
            })
            // ... (code error handling ‡πÄ‡∏î‡∏¥‡∏°) ...
            .finally(() => document.getElementById('loadingMenu').classList.add('hidden'));
        }

        function fetchMasterList() {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô masterData (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á)
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getMasterList" }) })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    masterData = data.data;
                    console.log("‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: " + masterData.length + " ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
                }
            })
            .catch(err => console.error("‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err));
        }

        function handleSearchKeydown(event) {
            const val = document.getElementById('searchInput').value;
            if (val === '') {
                if (event.key === '0' || event.key === '.' || event.key === 'Decimal') { event.preventDefault(); return; }
                if (event.key === 'Enter') { event.preventDefault(); if (cart.length > 0) { updateQty(0, 1); } return; }
                if (event.key === 'Backspace') { if (cart.length > 0) { if (cart[0].qty > 1) { updateQty(0, -1); } } return; }
            }
            if (event.key === 'Enter') {
                event.preventDefault(); 
                const trimVal = val.trim();
                if(trimVal) { if (/^[0-9]{1,4}$/.test(trimVal)) { addManualItem(parseInt(trimVal)); } else { scanBarcode(trimVal); } }
            }
        }
        
        function checkPaymentEnter(e) { if(e.key === 'Enter') { e.preventDefault(); if(!document.getElementById('btnConfirmPay').disabled) { confirmPayment(); } else { playNotificationSound(); } } }

        function addManualItem(price) {
            const manualItem = { id: "MANUAL-" + Date.now(), name: "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", price: price, category: "‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î", image: "", isHidden: true };
            addItemToCart(manualItem, "-"); document.getElementById('searchInput').value = ''; showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${price} ‡∏ö‡∏≤‡∏ó ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        }

        function scanBarcode(code) {
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ID ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô String ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå (‡πÄ‡∏û‡∏¥‡πà‡∏° .trim() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô ID ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏≤‡∏Å Sheet)
            const item = menuData.find(m => String(m.id).trim() === String(code)) || menuData.find(m => m.name.toLowerCase() === code.toLowerCase());
            if(item) {
                addItemToCart(item, "-"); document.getElementById('searchInput').value = ''; showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${item.name} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
            } else {
                playNotificationSound(); openQuickAddModal(code);
            }
        }
        
        function openQuickAddModal(barcode) {
             openAddMenuModal(); document.getElementById('mCode').value = barcode; document.getElementById('mName').value = ""; document.getElementById('mPrice').value = ""; setTimeout(() => { document.getElementById('mPrice').focus(); }, 300);
        }

        function searchMenu() { filterMenu('All'); }
        function clearSearch() { document.getElementById('searchInput').value = ''; searchMenu(); }

        function getCategoryEmoji(category) {
            const map = { '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°': 'ü•§', '‡∏Ç‡∏ô‡∏°/‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á': 'üç™', '‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô': 'üè†', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á': 'üßÇ', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î': 'ü•©', '‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î': 'üõçÔ∏è' };
            return map[category] || 'üì¶';
        }

        function filterMenu(category) {
            // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            let rawInput = document.getElementById('searchInput').value.toLowerCase().trim();
            
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏Å‡∏ö‡∏≤‡∏ó (Clear)
            const clearBtn = document.getElementById('clearSearchBtn');
            if(rawInput) clearBtn.classList.remove('hidden'); else clearBtn.classList.add('hidden');

            // --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ (1-9999) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ---
            let searchText = rawInput;
            const isPrice = /^[0-9]{1,4}$/.test(rawInput) && parseInt(rawInput) > 0;
            
            if (isPrice) { searchText = ""; } 

            // --- 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏ß‡∏° 2 ‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤) ---
            let dataSource = [];
            
            if (searchText !== "") {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Map ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏ï‡∏±‡∏ß‡∏ã‡πâ‡∏≥ (‡πÉ‡∏ä‡πâ ID ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå)
                const combined = new Map();
                
                // 1. ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Master) ‡∏•‡∏á‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
                if (masterData.length > 0) {
                    masterData.forEach(m => { if(m.id) combined.set(String(m.id), m); });
                }
                
                // 2. ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Menu (‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å) ‡∏ó‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô Menu ‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢)
                menuData.forEach(m => { if(m.id) combined.set(String(m.id), m); });
                
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                dataSource = Array.from(combined.values());
                
                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ menuData ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                if (dataSource.length === 0) dataSource = menuData;
                
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤ Menu ‡∏õ‡∏Å‡∏ï‡∏¥
                dataSource = menuData;
            }

            // --- 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ---
            if (category !== 'All' || searchText === '') {
                document.querySelectorAll('.cat-btn').forEach(btn => {
                    const isActive = (btn.innerText === category) || (category === 'All' && btn.innerText === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' && searchText === '');
                    btn.className = isActive ? "cat-btn bg-blue-600 text-white px-6 py-2 rounded-full shadow-lg shadow-blue-200 text-sm font-bold transition transform scale-105 border border-blue-500 shrink-0" : "cat-btn bg-white text-gray-500 hover:bg-gray-50 hover:text-blue-600 px-6 py-2 rounded-full shadow-sm text-sm font-medium transition border border-gray-100 shrink-0";
                });
            }

            // --- 3. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
            let filtered = dataSource;
            if (!searchText) { filtered = filtered.filter(m => !m.isHidden); }
            if (category !== 'All') { filtered = filtered.filter(m => m.category === category); }
            
            if (searchText) {
                 filtered = filtered.filter(m => 
                    m.name.toLowerCase().includes(searchText) || 
                    (m.id && String(m.id).toLowerCase().includes(searchText))
                 );
                 if(category === 'All') { document.querySelectorAll('.cat-btn').forEach(btn => btn.className = "cat-btn bg-white text-gray-600 hover:bg-blue-50 hover:text-blue-600 px-5 py-2 rounded-full shadow-sm text-sm font-medium transition border border-gray-200 shrink-0"); }
            } else if (category === 'All') { 
                filtered.sort((a, b) => categories.indexOf(a.category) - categories.indexOf(b.category)); 
            }

            // --- 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Grid) ---
            const grid = document.getElementById('menuGrid'); 
            const noResults = document.getElementById('noResults');
            
            if (filtered.length === 0) {
                grid.classList.add('hidden'); noResults.classList.remove('hidden');
            } else {
                grid.classList.remove('hidden'); noResults.classList.add('hidden');
                
                grid.innerHTML = filtered.map((item) => {
                    const editBtnHtml = isCustomerMode ? '' : `<button onclick="handleEditClick('${item.id}', event)" class="absolute top-2 right-2 bg-white/80 hover:bg-white text-gray-400 hover:text-orange-500 w-8 h-8 rounded-full shadow-sm backdrop-blur-sm z-10 flex items-center justify-center transition-all duration-200"><i class="fas fa-pencil-alt text-xs"></i></button>`;
                    const imageUrl = getDriveUrl(item.image);
                    const hasImage = imageUrl && imageUrl.length > 10;
                    let imageHtml;
                    
                    if (hasImage) {
                        imageHtml = `<img src="${imageUrl}" class="w-full h-full object-contain p-2 transition duration-500 group-hover:scale-110" loading="lazy" onerror="this.parentNode.innerHTML='<div class=\\'w-full h-full bg-blue-50 flex items-center justify-center text-5xl select-none text-blue-200\\'>${getCategoryEmoji(item.category)}</div>'">`;
                    } else {
                        const emoji = getCategoryEmoji(item.category); 
                        imageHtml = `<div class="w-full h-full bg-blue-50 flex items-center justify-center text-6xl group-hover:scale-110 transition duration-500 select-none drop-shadow-sm">${emoji}</div>`;
                    }

                    return `
                    <div class="bg-white rounded-3xl shadow-[0_2px_10px_rgba(0,0,0,0.03)] hover:shadow-[0_10px_25px_rgba(0,0,0,0.08)] transition-all duration-300 cursor-pointer overflow-hidden border border-gray-100 group relative transform hover:-translate-y-1" onclick="handleAddToCart('${item.id}')">
                        ${editBtnHtml}
                        <div class="h-32 sm:h-40 bg-white relative overflow-hidden flex items-center justify-center">
                            ${imageHtml}
                        </div>
                        <div class="p-4 pt-3 flex flex-col justify-between min-h-[110px]">
                            <h3 class="font-bold text-gray-700 text-sm sm:text-base leading-snug line-clamp-2 mb-2 h-10 group-hover:text-blue-700 transition-colors">
                                ${item.name}
                            </h3>
                            <div class="flex justify-between items-end mt-1">
                                <div class="flex flex-col">
                                     <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-[-2px]">‡∏£‡∏≤‡∏Ñ‡∏≤</span>
                                     <div class="flex items-baseline gap-1">
                                        <span class="text-3xl font-extrabold text-gray-800 tracking-tight leading-none group-hover:text-blue-600 transition-colors">${item.price}</span>
                                        <span class="text-xs text-gray-400 font-bold">‡∏ø</span>
                                     </div>
                                </div>
                                <div class="w-10 h-10 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-all shadow-sm group-hover:shadow-lg active:scale-90">
                                    <i class="fas fa-plus text-sm font-bold"></i>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å (‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á Script) ---
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å ID (‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ô menuData ‡πÅ‡∏•‡∏∞ masterData) ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        function handleAddToCart(itemId) {
            // ‡∏´‡∏≤‡πÉ‡∏ô masterData ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏≤‡πÉ‡∏ô menuData
            let item = masterData.find(m => m.id == itemId) || menuData.find(m => m.id == itemId);
            if (item) {
                addItemToCart(item, "-"); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            } else {
                console.error("Item not found:", itemId);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)
        function handleEditClick(itemId, e) {
            e.stopPropagation();
            // ‡∏´‡∏≤ item ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á 2 ‡πÅ‡∏´‡∏•‡πà‡∏á
            let item = masterData.find(m => m.id == itemId) || menuData.find(m => m.id == itemId);
            if (item) {
                document.getElementById('editMenuModal').classList.remove('hidden'); 
                document.getElementById('eId').value = item.id; 
                document.getElementById('eName').value = item.name; 
                document.getElementById('ePrice').value = item.price; 
                document.getElementById('eCategory').value = item.category;
            }
        }

        function toggleCart(show) {
            const panel = document.getElementById('cartPanel'); const mobileBar = document.getElementById('mobileBottomBar');
            if (show) { panel.classList.remove('hidden'); panel.classList.add('flex', 'fixed', 'inset-0', 'z-50'); mobileBar.classList.add('translate-y-[150%]'); } 
            else { if(window.innerWidth < 1024) { panel.classList.add('hidden'); panel.classList.remove('flex', 'fixed', 'inset-0', 'z-50'); if(cart.length > 0) mobileBar.classList.remove('translate-y-[150%]'); } }
        }

        function addToCart(index) { const item = menuData[index]; addItemToCart(item, "-"); }

        function addItemToCart(item, spicy) {
            const existingIndex = cart.findIndex(c => c.id === item.id);
            if (existingIndex !== -1) {
                const existingItem = cart[existingIndex]; existingItem.qty++; cart.splice(existingIndex, 1); cart.unshift(existingItem); speak(existingItem.qty.toString());
            } else { cart.unshift({ ...item, qty: 1, spicy: '-' }); speak(item.price + " ‡∏ö‡∏≤‡∏ó"); }
            renderCart(); if(window.navigator.vibrate) window.navigator.vibrate(50);
        }

        function renderCart() {
            const container = document.getElementById('cartItems'); 
            const totalEl = document.getElementById('totalPrice'); 
            const btn = document.getElementById('btnOrder'); // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® btn ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
            const countEl = document.getElementById('cartCountDesktop'); 
            const mobileBar = document.getElementById('mobileBottomBar'); 
            const mobileCount = document.getElementById('mobileCartCount'); 
            const mobileTotal = document.getElementById('mobileCartTotal');
            
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á
            if(cart.length === 0) {
                container.innerHTML = '<div class="h-full flex flex-col items-center justify-center text-gray-400 opacity-60"><i class="fas fa-cash-register text-6xl mb-4"></i><p>‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î QR ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</p></div>';
                
                btn.disabled = false; 
                btn.innerHTML = '<span>QR ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</span> <i class="fas fa-qrcode"></i>';
                btn.classList.replace('from-blue-600', 'from-green-600');
                btn.classList.replace('to-blue-700', 'to-green-700');
                
                totalEl.innerText = "0 ‡∏ø"; 
                countEl.innerText = "0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"; 
                mobileBar.classList.add('translate-y-[150%]'); 
                return;
            }
            
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°)
            if (isCustomerMode) {
                // --- ‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á" ---
                btn.innerHTML = '<span>‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á</span> <i class="fas fa-paper-plane"></i>';
                btn.classList.replace('from-gray-600', 'from-blue-600');
                btn.classList.replace('from-green-600', 'from-blue-600');
                btn.classList.replace('to-gray-700', 'to-blue-700');
                btn.classList.replace('to-green-700', 'to-blue-700');
            } else {
                // --- ‡πÇ‡∏´‡∏°‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ‡∏õ‡∏∏‡πà‡∏° "‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô" ---
                btn.innerHTML = '<span>‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô</span> <i class="fas fa-arrow-right"></i>';
                btn.classList.replace('from-gray-600', 'from-blue-600');
                btn.classList.replace('from-green-600', 'from-blue-600');
                btn.classList.replace('to-gray-700', 'to-blue-700');
                btn.classList.replace('to-green-700', 'to-blue-700');
            }

            // (‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
            let total = 0; let count = 0;
            container.innerHTML = cart.map((item, idx) => {
                total += item.price * item.qty; count += item.qty;
                return `<div class="flex justify-between items-start bg-white p-3 rounded-xl border border-gray-100 shadow-sm mb-2 animate-fade-in"><div class="flex-1"><h4 class="font-bold text-gray-800 leading-tight">${item.name}</h4><div class="text-xs text-gray-500 mt-1 flex gap-2"><span>${item.price}.-</span></div></div><div class="flex flex-col items-end gap-2"><div class="font-bold text-blue-600">${item.price * item.qty}</div><div class="flex items-center bg-gray-100 rounded-lg p-0.5 gap-1"><button onclick="removeFromCart(${idx})" class="w-7 h-7 flex items-center justify-center text-red-500 hover:bg-red-100 rounded-md transition"><i class="fas fa-trash-alt text-xs"></i></button><div class="w-px h-4 bg-gray-300 mx-1"></div><button onclick="updateQty(${idx}, -1)" class="w-7 h-7 flex items-center justify-center text-gray-500 hover:bg-white hover:shadow rounded-md transition">-</button><span class="w-6 text-center font-bold text-sm">${item.qty}</span><button onclick="updateQty(${idx}, 1)" class="w-7 h-7 flex items-center justify-center text-green-600 hover:bg-white hover:shadow rounded-md transition">+</button></div></div></div>`;
            }).join('');
            
            const totalTxt = total.toLocaleString() + " ‡∏ø";
            totalEl.innerText = totalTxt; 
            countEl.innerText = count + " ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"; 
            btn.disabled = false; 
            mobileCount.innerText = count; 
            mobileTotal.innerText = totalTxt;
            
            const isDrawerOpen = !document.getElementById('cartPanel').classList.contains('hidden');
            if (!isDrawerOpen && window.innerWidth < 1024) { mobileBar.classList.remove('translate-y-[150%]'); }
        }

        function updateQty(idx, change) { cart[idx].qty += change; if(cart[idx].qty > 0) { speak(cart[idx].qty.toString()); } if (cart[idx].qty <= 0) cart.splice(idx, 1); renderCart(); }
        function removeFromCart(idx) { cart.splice(idx, 1); renderCart(); }

        function handleCheckoutClick() { 
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á -> ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ QR ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤) ‡∏´‡∏£‡∏∑‡∏≠ QR ‡∏™‡∏±‡πà‡∏á (‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà Logic)
            if (cart.length === 0) {
                quickCheckout(); 
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            if (isCustomerMode) {
                // --- ‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á" ---
                isQuickPayMode = false; 
                openConfirmOrderModal(); 
            } else {
                // --- ‡πÇ‡∏´‡∏°‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á "‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô" ---
                quickCheckout(); 
            } 
        }
        
        function quickCheckout() {
            isQuickPayMode = true;
            const total = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            currentPayOrder = { orderId: null, totalPrice: total };
            
            initBankQR();
            document.getElementById('paymentModal').classList.remove('hidden'); 
            document.getElementById('payTotalDisplay').innerText = total.toLocaleString(); // ‡πÉ‡∏™‡πà comma ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
            document.getElementById('inputReceived').value = ''; 
            document.getElementById('changeDisplay').innerText = '0.00'; 
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏≠‡∏î 0 (QR ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏•‡∏¢, ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÉ‡∏™‡πà‡πÄ‡∏á‡∏¥‡∏ô
            const btnConfirm = document.getElementById('btnConfirmPay');
            if (total === 0) {
                btnConfirm.disabled = false;
                btnConfirm.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btnConfirm.disabled = true;
            }

            // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏û‡∏π‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏≠‡∏î‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0 ---
            if (total > 0) {
                speak("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° " + total + " ‡∏ö‡∏≤‡∏ó"); 
            }
            // ------------------------------------

            setTimeout(() => { document.getElementById('inputReceived').focus(); }, 100);
        }

        // --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠ + ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà) ---
        function openConfirmOrderModal() {
            document.getElementById('confirmOrderModal').classList.remove('hidden');
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            document.getElementById('summaryList').innerHTML = cart.map(i => `<div class="flex justify-between border-b border-gray-200 border-dashed py-2 last:border-0"><span class="text-gray-700 text-sm">${i.name} x${i.qty}</span><span class="font-bold text-gray-800">${i.price*i.qty}</span></div>`).join('') + `<div class="flex justify-between font-bold mt-3 pt-3 border-t text-blue-600 text-lg"><span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span><span>${document.getElementById('totalPrice').innerText}</span></div>`;
            
            // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á Element
            const typeSelect = document.getElementById('orderType');
            const typeDiv = typeSelect.parentElement; 
            const addressSection = document.getElementById('addressSection');
            const tableDiv = document.getElementById('tableNo').parentElement; 
            const tableInput = document.getElementById('tableNo');

            if (isCustomerMode) {
                // --- ‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ---
                // 1. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏™‡πà‡∏á‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà"
                typeSelect.value = "‡∏™‡πà‡∏á‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà";
                
                // 2. ‡∏ã‡πà‡∏≠‡∏ô Dropdown ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‡πÅ‡∏•‡∏∞ ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö
                typeDiv.classList.add('hidden');
                tableDiv.classList.add('hidden'); // <--- ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠
                
                // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                addressSection.classList.remove('hidden');

                // --- üî¥ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ---
                const savedHouse = localStorage.getItem('customerAddrHouse');
                const savedSoi = localStorage.getItem('customerAddrSoi');
                if (savedHouse) document.getElementById('addrHouseNo').value = savedHouse;
                if (savedSoi) document.getElementById('addrSoi').value = savedSoi;
                // ------------------------------------------------
                
                // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ error ‡∏ï‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
                if(!tableInput.value) tableInput.value = customerTable || "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Online";
                
            } else {
                // --- ‡πÇ‡∏´‡∏°‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ---
                typeDiv.classList.remove('hidden');
                tableDiv.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥
                toggleAddressFields(); 
                
                tableDiv.querySelector('label').innerText = "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà";
                tableInput.placeholder = "‡πÄ‡∏ä‡πà‡∏ô 1 ‡∏´‡∏£‡∏∑‡∏≠ A";
            }
        } // <--- ‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö

        // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ---
        function toggleAddressFields() {
            const type = document.getElementById('orderType').value; 
            const addrSection = document.getElementById('addressSection');
            if (type === '‡∏™‡πà‡∏á‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà') { addrSection.classList.remove('hidden'); } else { addrSection.classList.add('hidden'); }
        }

        // --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á) ---
        function submitOrder() {
            setLoading('btnSubmitOrder', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
            const total = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            
            // --- üõë ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100 ‡∏ö‡∏≤‡∏ó (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤) ---
            if (isCustomerMode && total < 100) {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
                const diff = 100 - total;
                document.getElementById('diffAmount').innerText = diff.toLocaleString();
                
                // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                document.getElementById('minOrderModal').classList.remove('hidden');
                
                playNotificationSound(); // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                speak("‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100 ‡∏ö‡∏≤‡∏ó‡∏Ñ‡πà‡∏∞"); // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î
                
                // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                setLoading('btnSubmitOrder', false, '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); 
                return;
            }
            // --------------------------------------------------------

            // --- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°: ‡∏û‡∏π‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ ---
            if (isCustomerMode) {
                speak("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° " + total.toLocaleString() + " ‡∏ö‡∏≤‡∏ó");
            }
            
            const orderType = document.getElementById('orderType').value;
            let noteText = document.getElementById('orderNote').value;
            
            if (orderType === '‡∏™‡πà‡∏á‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà') {
                const houseNo = document.getElementById('addrHouseNo').value.trim(); 
                const soi = document.getElementById('addrSoi').value.trim();
                
                if (!houseNo || !soi) {
                    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ "‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" ‡πÅ‡∏•‡∏∞ "‡∏ã‡∏≠‡∏¢/‡∏ñ‡∏ô‡∏ô" ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '<i class="fas fa-map-marked-alt text-orange-500"></i>');
                    setLoading('btnSubmitOrder', false, '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); 
                    return; 
                }
                
                if (isCustomerMode) {
                    localStorage.setItem('customerAddrHouse', houseNo);
                    localStorage.setItem('customerAddrSoi', soi);
                }
                
                const addressStr = `[‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà: ${houseNo} ${soi ? '‡∏ã.'+soi : ''}]`; 
                noteText = noteText ? `${addressStr} ${noteText}` : addressStr; 
            }

            const payload = { action: "saveOrder", tableNo: document.getElementById('tableNo').value || "‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô", orderType: orderType, cartItems: cart.map(i => ({ name: i.name, qty: i.qty, price: i.price, spicy: "-" })), totalPrice: total, note: noteText };
            
             fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(res => res.json()).then(data => {
                if(data.result === 'success') {
                    // ... (‡πÇ‡∏Ñ‡πâ‡∏î Success ‡πÄ‡∏î‡∏¥‡∏°) ...
                    myLastOrders = [...cart]; 
                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success'); 
                    if (isCustomerMode) { setTimeout(() => speak("‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞"), 1500); } else { speak("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞"); }
                    cart = []; renderCart(); toggleCart(false); closeModal('confirmOrderModal');
                    if(!isCustomerMode) document.getElementById('tableNo').value = '';
                    document.getElementById('orderNote').value = ''; 
                    document.getElementById('addrHouseNo').value = '';
                    document.getElementById('addrSoi').value = '';
                    if(isCustomerMode) openMyRecentOrder();
                    updateKitchenBadge();
                    
                } else if (data.error === 'STORE_CLOSED') {
                    // üõë 1. ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö Error ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                    document.getElementById('storeClosedModal').classList.remove('hidden');
                    isStoreOpen = false;
                    updateStoreUI();
                    speak("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
                    closeModal('confirmOrderModal'); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á
                    
                } else { 
                    showCustomAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + data.error, '<i class="fas fa-exclamation-circle text-red-500"></i>'); 
                }
            }).catch(err => showCustomAlert('Connection Error', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì')).finally(() => setLoading('btnSubmitOrder', false, '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'));
        }

        // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ß (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤) ---
        function updateKitchenBadge() { 
            return fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getOrders" }) })
            .then(res => res.json())
            .then(data => { 
                if (data.result === 'success') { 
                    
                    // --- üõë 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Auto Lock: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô Real-time ---
                    if (data.isStoreOpen !== undefined) {
                        isStoreOpen = data.isStoreOpen;
                        updateStoreUI(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß/‡πÅ‡∏î‡∏á
                        
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î -> ‡πÄ‡∏î‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏•‡πá‡∏≠‡∏Ñ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                        if (isCustomerMode && !isStoreOpen) {
                            document.getElementById('storeClosedModal').classList.remove('hidden');
                        } else if (isCustomerMode && isStoreOpen) {
                            // ‡∏ñ‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡∏¥‡∏î -> ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ
                            document.getElementById('storeClosedModal').classList.add('hidden');
                        }
                    }
                    // -----------------------------------------------------

                    const waitingOrders = data.data.filter(o => o.status !== 'Served'); 
                    const waitingCount = waitingOrders.length; 
                    const badge = document.getElementById('kitchenBadge'); 
                    
                    if (waitingCount > 0) { badge.innerText = waitingCount; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } 
                    
                    if (!isCustomerMode && lastOrderCount !== -1 && waitingCount > lastOrderCount) { 
                        playNotificationSound(); 
                        showToast('‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤!', 'warning'); 
                        if (!document.getElementById('kitchenModal').classList.contains('hidden')) { renderKitchen(data.data); } 
                    } 
                    lastOrderCount = waitingCount; 
                    
                    if (isCustomerMode) { 
                        document.getElementById('queueCountDisplay').innerText = waitingCount; 
                        const myOrders = data.data.filter(o => o.tableNo == customerTable);
                        myOrders.forEach(order => {
                            if (order.status === 'Served' && !notifiedOrders.has(order.orderId)) {
                                document.getElementById('deliveryNotificationModal').classList.remove('hidden');
                                playNotificationSound();
                                speak("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏∞");
                                notifiedOrders.add(order.orderId); 
                            }
                        });
                    }
                } 
            }).catch(e=>{}); 
        }
        function openKitchenModal() { document.getElementById('kitchenModal').classList.remove('hidden'); fetchOrders(); }
        function fetchOrders() { const grid = document.getElementById('kitchenGrid'); grid.innerHTML = '<div class="col-span-full text-center py-20"><i class="fas fa-circle-notch fa-spin text-4xl text-orange-500"></i><p class="mt-2 text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</p></div>'; fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getOrders" }) }).then(res => res.json()).then(data => { if (data.result === 'success') { currentOrders = data.data; renderKitchen(currentOrders); updateKitchenBadge(); } else { grid.innerHTML = `<div class="col-span-full text-center text-red-500">Error: ${data.error}</div>`; } }); }
        function renderKitchen(orders) { const grid = document.getElementById('kitchenGrid'); grid.innerHTML = ''; if(!orders || orders.length === 0) { grid.innerHTML = '<div class="col-span-full flex flex-col items-center justify-center text-gray-300 py-20"><i class="fas fa-clipboard-check text-6xl mb-4"></i><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á</p></div>'; return; } grid.innerHTML = orders.map(order => { const isServed = order.status === 'Served'; const isTakeAway = order.orderType === '‡∏™‡πà‡∏á‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà'; const cardColor = isServed ? 'bg-green-50 border-green-200' : (isTakeAway ? 'bg-orange-50 border-orange-200' : 'bg-white border-blue-100'); const statusColor = isServed ? 'text-green-600' : (isTakeAway ? 'text-orange-600' : 'text-blue-600'); return `<div class="${cardColor} border-2 rounded-2xl p-4 shadow-sm relative flex flex-col animate-slide-up"><div class="flex justify-between items-start mb-3"><div><h4 class="font-bold text-xl text-gray-800">‡∏Ñ‡∏¥‡∏ß/‡∏ä‡∏∑‡πà‡∏≠: ${order.tableNo}</h4><span class="text-xs font-bold px-2 py-0.5 rounded-full bg-white border shadow-sm ${statusColor}">${order.orderType}</span></div><div class="text-right"><div class="font-bold text-lg text-gray-800">${order.totalPrice}‡∏ø</div><div class="text-xs text-gray-400 font-mono">${new Date(order.timestamp).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}</div></div></div>${order.note ? `<div class="bg-yellow-100 text-yellow-800 text-xs p-2 rounded-lg mb-3 font-medium"><i class="fas fa-sticky-note mr-1"></i> ${order.note}</div>` : ''}<div class="flex-1 space-y-2 mb-4 overflow-y-auto max-h-[200px]">${(order.items || []).map(i => `<div class="flex justify-between text-sm border-b border-dashed border-gray-300/50 pb-1 last:border-0"><span class="font-medium text-gray-700">${i.name} <span class="text-gray-400 text-xs">x${i.qty}</span></span></div>`).join('')}</div><div class="flex gap-2 mt-auto pt-3 border-t border-gray-200/50">${!isServed ? `<button onclick="markServed('${order.orderId}', this)" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-xl font-bold text-sm shadow transition"><i class="fas fa-check"></i> ‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à</button>` : '<div class="flex-1 text-center text-green-600 font-bold py-2"><i class="fas fa-check-circle"></i> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</div>'}<button onclick="openPayment('${order.orderId}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-xl font-bold text-sm shadow transition"><i class="fas fa-money-bill"></i> ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button></div></div>`; }).join(''); }
        function markServed(orderId, btn) { const originalContent = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>'; fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "updateOrderStatus", orderId: orderId, status: "Served" }) }).then(() => { fetchOrders(); showToast('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'success'); }).catch(() => { btn.disabled = false; btn.innerHTML = originalContent; }); }
        
        function openPayment(orderId) { 
            isQuickPayMode = false;
            currentPayOrder = currentOrders.find(o => o.orderId === orderId); 
            if(!currentPayOrder) return; 
            initBankQR();
            document.getElementById('paymentModal').classList.remove('hidden'); document.getElementById('payTotalDisplay').innerText = currentPayOrder.totalPrice; document.getElementById('inputReceived').value = ''; document.getElementById('changeDisplay').innerText = '0.00'; document.getElementById('btnConfirmPay').disabled = true; speak("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° " + currentPayOrder.totalPrice + " ‡∏ö‡∏≤‡∏ó"); setTimeout(() => { document.getElementById('inputReceived').focus(); }, 100);
        }
        
        function addMoney(amount) { const input = document.getElementById('inputReceived'); input.value = Number(input.value) + amount; calcChange(); }
        function setExactMoney() { document.getElementById('inputReceived').value = currentPayOrder.totalPrice; calcChange(); }
        function clearMoney() { document.getElementById('inputReceived').value = ''; calcChange(); }
        
        function calcChange() { 
            const total = currentPayOrder.totalPrice; 
            const inputEl = document.getElementById('inputReceived');
            const received = Number(inputEl.value); 
            const change = received - total; 
            
            const display = document.getElementById('changeDisplay'); 
            const currency = document.getElementById('changeCurrency'); // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ element ‡∏ô‡∏µ‡πâ
            const btn = document.getElementById('btnConfirmPay'); 
            
            // ‡∏Å‡∏£‡∏ì‡∏µ QR ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏¢‡∏≠‡∏î 0) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≠‡∏î
            if(received >= total) { 
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô
                display.innerText = change.toLocaleString(); 
                display.className = "text-4xl sm:text-5xl font-bold text-green-500 transition-all duration-300 transform scale-110 drop-shadow-sm";
                if(currency) currency.className = "text-xl text-green-500 font-bold mt-2 transition-colors duration-300";
                
                inputEl.classList.replace('border-gray-200', 'border-green-500');
                inputEl.classList.replace('text-blue-600', 'text-green-600');
                
                btn.disabled = false; 
                btn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400'); 
                btn.classList.add('bg-green-600', 'hover:bg-green-700', 'shadow-lg');
                
                // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏û‡∏π‡∏î "‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô... ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô..." ---
                if(change >= 0 && total > 0) { 
                    speak("‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô " + received + " ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô " + change + " ‡∏ö‡∏≤‡∏ó"); 
                }
                // ---------------------------------------

            } else { 
                // ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
                if (received === 0) {
                     display.innerText = "0.00";
                     display.className = "text-4xl sm:text-5xl font-bold text-gray-300 transition-all duration-300 transform scale-100";
                     if(currency) currency.className = "text-xl text-gray-300 font-bold mt-2 transition-colors duration-300";
                } else {
                     display.innerText = "-" + Math.abs(change).toLocaleString(); 
                     display.className = "text-4xl sm:text-5xl font-bold text-red-500 transition-all duration-300 transform scale-100";
                     if(currency) currency.className = "text-xl text-red-500 font-bold mt-2 transition-colors duration-300";
                }
                
                inputEl.classList.replace('border-green-500', 'border-gray-200');
                inputEl.classList.replace('text-green-600', 'text-blue-600');
                
                btn.disabled = true; 
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            } 
        }
        
        function confirmPayment() { 
            const received = Number(document.getElementById('inputReceived').value); 
            const total = currentPayOrder.totalPrice; 
            const orderId = currentPayOrder.orderId;
            
            closeModal('paymentModal'); 
            speak("‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞");
            
            let itemsToSave = [];
            
            // === ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ ===
            if (isQuickPayMode) { 
                // ‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                 itemsToSave = cart.map(i => ({ name: i.name, qty: i.qty, price: i.price })); 
                 
                 // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
                 cart = []; 
                 renderCart(); 
                 toggleCart(false); 

                 // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Bill ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÄ‡∏û‡∏¥‡πà‡∏° parameter directItems)
                 const payload = { 
                     action: "processPayment", 
                     tableNo: "Walk-in", 
                     finalPrice: total, 
                     received: received, 
                     change: received - total,
                     directItems: itemsToSave // ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
                 };
                 
                 fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
                 .then(res => res.json())
                 .then(data => { 
                     if(data.result === 'success') { 
                         showToast('‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); 
                     } else {
                         throw new Error(data.error);
                     }
                 })
                 .catch(err => showCustomAlert('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err));

            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å QR (Logic ‡πÄ‡∏î‡∏¥‡∏°)
                fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "processPayment", orderId: orderId, finalPrice: total, received: received, change: received - total }) })
                .then(res => res.json())
                .then(data => { if(data.result === 'success') { showToast('‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); fetchOrders(); } });
            }
        }
        
        function openEditMenu(index, e) { e.stopPropagation(); const item = menuData[index]; document.getElementById('editMenuModal').classList.remove('hidden'); document.getElementById('eId').value = item.id; document.getElementById('eName').value = item.name; document.getElementById('ePrice').value = item.price; document.getElementById('eCategory').value = item.category; }
        function openAddMenuModal() { document.getElementById('addModal').classList.remove('hidden'); }
        function openSalesModal() { document.getElementById('salesModal').classList.remove('hidden'); document.getElementById('saleToday').innerText = '...'; fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getSalesStats" }) }).then(r=>r.json()).then(d => { document.getElementById('saleToday').innerText = d.today.toLocaleString(); document.getElementById('saleYest').innerText = d.yesterday.toLocaleString(); document.getElementById('saleMonth').innerText = d.month.toLocaleString(); }); }
        function openHistoryModal() { 
            document.getElementById('historyModal').classList.remove('hidden'); 
            
            const list = document.getElementById('historyList');
            list.innerHTML = '<tr><td colspan="3" class="text-center p-10 text-gray-400"><i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</td></tr>'; 
            
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getHistory" }) })
            .then(r => r.json())
            .then(d => { 
                if(d.result === 'success') { 
                    // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ openBillDetail ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
                    historyBills = d.data; 

                    if(historyBills.length === 0) {
                        list.innerHTML = '<tr><td colspan="3" class="text-center p-10 text-gray-300">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</td></tr>';
                        return;
                    }

                    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ (onclick="openBillDetail")
                    list.innerHTML = historyBills.map((b, index) => {
                        let timeStr = "-";
                        try {
                            timeStr = new Date(b.date).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
                        } catch(e) {}

                        return `
                        <tr onclick="openBillDetail(${index})" class="hover:bg-blue-50 transition duration-150 cursor-pointer group border-b border-gray-100 last:border-0">
                            <td class="p-3 text-gray-500 font-mono align-top pt-3 group-hover:text-blue-600">
                                ${timeStr}
                            </td>
                            <td class="p-3 text-gray-700 align-top pt-3">
                                <span class="line-clamp-1 leading-relaxed font-medium group-hover:text-blue-800">${b.itemSummary}</span>
                                <span class="text-[10px] text-gray-400 block mt-0.5 group-hover:text-blue-400">ID: ${b.billId}</span>
                            </td>
                            <td class="p-3 text-right font-bold text-gray-800 align-top pt-3 whitespace-nowrap text-base group-hover:text-blue-600">
                                ${parseFloat(b.total).toLocaleString()}
                            </td>
                        </tr>`; 
                    }).join(''); 
                } else {
                    list.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-red-400">Error: ${d.error}</td></tr>`;
                }
            })
            .catch(err => {
                console.error(err);
                list.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-red-400">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</td></tr>';
            }); 
        }
        
        function openBillDetail(index) { 
            const bill = historyBills[index]; const modal = document.getElementById('billDetailModal'); const content = document.getElementById('billDetailContent'); 
            let items = bill.items; if (typeof items === 'string') { try { items = JSON.parse(items); } catch(e) { items = []; } }
            let itemsHtml = ''; 
            if(Array.isArray(items) && items.length > 0) { itemsHtml = items.map(i => `<div class="flex justify-between py-2 border-b border-dashed border-gray-200 last:border-0"><div class="flex-1"><span class="font-bold text-gray-700 text-sm">${i.name}</span></div><div class="text-right"><span class="text-gray-600 text-sm">x${i.qty}</span><span class="ml-2 font-bold text-gray-800 text-sm">${(i.price * i.qty).toLocaleString()}</span></div></div>`).join(''); } else { itemsHtml = '<p class="text-center text-gray-400 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>'; } 
            content.innerHTML = `<div class="mb-4 text-center pb-4 border-b"><h4 class="text-xl font-bold text-gray-800">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h4><p class="text-gray-500 text-xs font-mono mt-1">ID: ${bill.billId}</p><p class="text-gray-500 text-xs">${new Date(bill.date).toLocaleString('th-TH')}</p></div><div class="flex justify-between mb-3 text-sm bg-gray-50 p-2 rounded"><span class="font-bold text-gray-700">‡∏ä‡∏∑‡πà‡∏≠/‡∏Ñ‡∏¥‡∏ß: ${bill.table}</span><span class="text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${bill.type || '-'}</span></div><div class="rounded-lg mb-4 max-h-60 overflow-y-auto custom-scrollbar">${itemsHtml}</div><div class="space-y-2 text-right border-t pt-3"><div class="flex justify-between text-gray-600 text-sm"><span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span><span class="font-bold text-lg text-blue-600">${parseFloat(bill.total).toLocaleString()} ‡∏ø</span></div><div class="flex justify-between text-xs text-gray-500"><span>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (${bill.paymentMethod || 'Cash'})</span><span>${parseFloat(bill.receive || bill.total).toLocaleString()} ‡∏ø</span></div><div class="flex justify-between text-xs text-green-600 font-bold"><span>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</span><span>${parseFloat(bill.change || 0).toLocaleString()} ‡∏ø</span></div></div>`; 
            modal.classList.remove('hidden'); 
        }

        document.getElementById('editMenuForm').addEventListener('submit', function(e) { e.preventDefault(); setLoading('btnEditSave', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'); const payload = { action: "editMenu", id: document.getElementById('eId').value, name: document.getElementById('eName').value, price: document.getElementById('ePrice').value, category: document.getElementById('eCategory').value, spicy: "-" }; fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r=>r.json()).then(d=>{ if(d.result==='success') { showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); closeModal('editMenuModal'); fetchMenu(); } }).finally(()=>setLoading('btnEditSave', false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å')); });
        
        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = event => { const img = new Image(); img.src = event.target.result; img.onload = () => { const canvas = document.createElement('canvas'); let width = img.width; let height = img.height; if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } else { if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; } } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', quality)); }; img.onerror = error => reject(error); }; reader.onerror = error => reject(error);
            });
        }
        document.getElementById('addMenuForm').addEventListener('submit', function(e) { 
            e.preventDefault(); 
            const fileInput = document.getElementById('mFile'); const file = fileInput.files[0]; const mCode = document.getElementById('mCode').value.trim();
            if (file) {
                 setLoading('btnSaveMenu', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ...'); 
                 compressImage(file, 800, 0.7).then(compressedBase64 => {
                    setLoading('btnSaveMenu', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...'); 
                    const base64Data = compressedBase64.split(',')[1];
                    const payload = { action: "addMenu", name: document.getElementById('mName').value, price: document.getElementById('mPrice').value, category: document.getElementById('mCategory').value, spicy: "-", image: base64Data, mimeType: "image/jpeg", fileName: file.name.replace(/\.[^/.]+$/, "") + ".jpg" };
                    if (mCode) { payload.id = mCode; }
                    sendAddMenu(payload);
                }).catch(err => { console.error(err); setLoading('btnSaveMenu', false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'); showCustomAlert('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ'); });
            } else {
                 setLoading('btnSaveMenu', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'); 
                 const payload = { action: "addMenu", name: document.getElementById('mName').value, price: document.getElementById('mPrice').value, category: document.getElementById('mCategory').value, spicy: "-", image: "", mimeType: "", fileName: "" };
                 if (mCode) { payload.id = mCode; }
                 sendAddMenu(payload);
            }
        });

        function uploadBankQRFile(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0]; const reader = new FileReader();
                const imgEl = document.getElementById('bankQRImage'); const originalSrc = imgEl.src; imgEl.style.opacity = '0.5';
                reader.onload = function(e) {
                      const base64Preview = e.target.result; imgEl.src = base64Preview;
                      compressImage(file, 600, 0.7).then(compressedBase64 => {
                          const base64Data = compressedBase64.split(',')[1];
                          const payload = { action: "uploadBankQR", image: base64Data, mimeType: "image/jpeg", folderId: QR_FOLDER_ID };
                          fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r => r.json()).then(d => {
                              if(d.result === 'success') {
                                  localStorage.setItem('bankQRID', d.fileId); localStorage.removeItem('promptPayID');
                                  showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î QR Code ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); initBankQR(); closeModal('manageQRModal');
                             } else { throw new Error(d.error); }
                          }).catch(err => { imgEl.src = originalSrc; showCustomAlert('Error', '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err); }).finally(() => { imgEl.style.opacity = '1'; });
                      });
                }; reader.readAsDataURL(file);
            }
        }

        function sendAddMenu(payload) {
             fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r=>r.json()).then(d=>{ 
                 if(d.result === 'success') { showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success'); closeModal('addModal'); fetchMenu(); document.getElementById('addMenuForm').reset(); } 
                 else { showCustomAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + d.error, '<i class="fas fa-exclamation-circle text-red-500"></i>'); } 
             }).catch(err => { showCustomAlert('Connection Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ'); }).finally(()=>setLoading('btnSaveMenu', false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å')); 
        }
        
        function confirmDeleteMenu() { setLoading('btnDeleteMenu', true, '‡∏•‡∏ö...'); fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "deleteMenu", id: document.getElementById('eId').value }) }).then(r=>r.json()).then(d=>{ if(d.result === 'success') { showToast('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success'); closeModal('editMenuModal'); fetchMenu(); } else { showCustomAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + d.error, '<i class="fas fa-exclamation-circle text-red-500"></i>'); } }).catch(err => showCustomAlert('Connection Error', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì')).finally(()=>setLoading('btnDeleteMenu', false, '‡∏•‡∏ö')); }
        function deleteMenu() { openConfirmActionModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ', '<i class="fas fa-trash-alt"></i>', confirmDeleteMenu); }
        function openConfirmActionModal(title, msg, iconHtml, confirmHandler) { document.getElementById('confirmActionTitle').innerText = title; document.getElementById('confirmActionMsg').innerText = msg; document.getElementById('confirmActionIcon').innerHTML = iconHtml; const confirmBtn = document.getElementById('btnConfirmAction'); confirmBtn.onclick = () => { closeModal('confirmActionModal'); confirmHandler(); }; document.getElementById('confirmActionModal').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function showToast(msg, type='success') { const toast = document.getElementById('toast'); const iconContainer = toast.querySelector('div:first-child'); const icon = iconContainer.querySelector('i'); if (type === 'warning') { toast.classList.remove('border-green-500'); toast.classList.add('border-yellow-500'); iconContainer.classList.replace('bg-green-100', 'bg-yellow-100'); icon.classList.replace('text-green-600', 'text-yellow-600'); icon.className = 'fas fa-bell'; } else { toast.classList.add('border-green-500'); toast.classList.remove('border-yellow-500'); iconContainer.classList.replace('bg-yellow-100', 'bg-green-100'); icon.classList.replace('text-yellow-600', 'text-green-600'); icon.className = 'fas fa-check'; } document.getElementById('toastMsg').innerText = msg; toast.style.transform = 'translateX(0)'; setTimeout(() => { toast.style.transform = 'translateX(150%)'; }, 3000); }
        function showCustomAlert(title, msg, icon='<i class="fas fa-info-circle text-blue-500"></i>') { document.getElementById('alertTitle').innerText = title; document.getElementById('alertMsg').innerText = msg; document.getElementById('alertIcon').innerHTML = icon; document.getElementById('customAlert').classList.remove('hidden'); }
        function closeCustomAlert() { document.getElementById('customAlert').classList.add('hidden'); }
        function setLoading(btnId, isLoading, text) { const btn = document.getElementById(btnId); let span = btn.querySelector('.btn-text'); let icon = btn.querySelector('i.fas'); if (!span && btnId === 'btnDeleteMenu') { if (btn.innerHTML.indexOf('<span class="btn-text">') === -1) { const originalText = btn.innerText; btn.innerHTML = `<span class="btn-text">${originalText}</span> <i class="fas fa-trash-alt"></i>`; } span = btn.querySelector('.btn-text'); icon = btn.querySelector('i.fas'); } else if (!span && btnId !== 'btnDeleteMenu') { if (btn.innerHTML.indexOf('<span class="btn-text">') === -1) { const originalText = btn.innerText; btn.innerHTML = `<span class="btn-text">${originalText}</span> <i class="fas fa-save"></i>`; } span = btn.querySelector('.btn-text'); icon = btn.querySelector('i.fas'); } if(isLoading) { btn.disabled = true; btn.classList.add('opacity-75', 'cursor-not-allowed'); if(span && !span.dataset.originalText) { span.dataset.originalText = span.innerText; } if(span) span.innerText = text; if(icon && !icon.dataset.originalClass) { icon.dataset.originalClass = icon.dataset.originalClass; } if(icon) { icon.className = "fas fa-circle-notch fa-spin"; } } else { btn.disabled = false; btn.classList.remove('opacity-75', 'cursor-not-allowed'); if(span && span.dataset.originalText) { span.innerText = span.dataset.originalText; delete span.dataset.originalText; span.removeAttribute('data-original-text'); } if(icon && icon.dataset.originalClass) { icon.className = icon.dataset.originalClass; delete icon.dataset.originalClass; icon.removeAttribute('data-original-class'); } } }

        function initStoreStatus() {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getStoreStatus" }) })
            .then(r => r.json())
            .then(d => {
                if (d.result === 'success') {
                    isStoreOpen = d.isOpen;
                    updateStoreUI();
                    
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î -> ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô
                    if (isCustomerMode && !isStoreOpen) {
                        document.getElementById('storeClosedModal').classList.remove('hidden');
                    }
                }
            });
        }

        function toggleStoreStatus() {
            if (isCustomerMode) return; // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
            
            const newStatus = !isStoreOpen;
            // Optimistic UI Update (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏£‡πá‡∏ß)
            isStoreOpen = newStatus;
            updateStoreUI();
            
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "setStoreStatus", isOpen: newStatus }) })
            .then(r => r.json())
            .then(d => {
                if (d.result !== 'success') {
                    // ‡∏ñ‡πâ‡∏≤‡∏û‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
                    isStoreOpen = !newStatus;
                    updateStoreUI();
                    showToast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'warning');
                } else {
                    showToast(isStoreOpen ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß' : '‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß', 'success');
                }
            });
        }

        function updateStoreUI() {
            const bg = document.getElementById('storeToggleBg');
            const dot = document.getElementById('storeToggleDot');
            const text = document.getElementById('storeStatusText');
            
            if (isStoreOpen) {
                // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î: ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß, ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤
                bg.className = "w-10 h-5 rounded-full relative transition-colors duration-300 shadow-inner flex items-center bg-green-500";
                dot.style.transform = "translateX(20px)"; // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤
                text.innerText = "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô";
            } else {
                // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏¥‡∏î: ‡∏™‡∏µ‡πÅ‡∏î‡∏á, ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ã‡πâ‡∏≤‡∏¢
                bg.className = "w-10 h-5 rounded-full relative transition-colors duration-300 shadow-inner flex items-center bg-red-500";
                dot.style.transform = "translateX(0px)"; // ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢
                text.innerText = "‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô";
            }
        }

        function openMyRecentOrder() {
            const modal = document.getElementById('myOrderModal');
            const content = document.getElementById('myOrderContent');
            
            if (myLastOrders.length === 0) {
                content.innerHTML = '<div class="text-center py-10"><i class="fas fa-shopping-basket text-4xl text-gray-300 mb-2"></i><p class="text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p></div>';
            } else {
                let html = '<div class="space-y-2">';
                let total = 0;
                myLastOrders.forEach(item => {
                    const itemTotal = item.price * item.qty;
                    total += itemTotal;
                    html += `
                        <div class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
                            <div>
                                <h4 class="font-bold text-gray-700">${item.name}</h4>
                                <div class="text-xs text-gray-500">${item.price} x ${item.qty}</div>
                            </div>
                            <div class="font-bold text-blue-600">${itemTotal.toLocaleString()} ‡∏ø</div>
                        </div>
                    `;
                });
                html += `</div>
                    <div class="mt-4 pt-4 border-t border-dashed border-gray-300 flex justify-between items-center">
                        <span class="text-gray-600 font-bold">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        <span class="text-2xl font-bold text-blue-600">${total.toLocaleString()} ‡∏ø</span>
                    </div>
                    <div class="mt-6 text-center">
                        <p class="text-green-600 font-bold text-sm mb-2"><i class="fas fa-check-circle"></i> ‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß</p>
                        <button onclick="closeModal('myOrderModal')" class="bg-gray-800 text-white w-full py-3 rounded-xl font-bold hover:bg-gray-900 transition">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
                    </div>
                `;
                content.innerHTML = html;
            }
            modal.classList.remove('hidden');
        }
    </script>
</body>
</html>