<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏û‡∏¥‡∏ô POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>

                /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏ô <style> */
        @keyframes heartbeat { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.15); } 
            100% { transform: scale(1); } 
        }
        .animate-heartbeat { 
            animation: heartbeat 1.2s infinite ease-in-out; 
            display: inline-block; 
        }
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Animation Blob */
        @keyframes blob { 
            0% { transform: translate(0px, 0px) scale(1); } 
            33% { transform: translate(30px, -50px) scale(1.1); } 
            66% { transform: translate(-20px, 20px) scale(0.9); } 
            100% { transform: translate(0px, 0px) scale(1); } 
        }
        .animate-blob { animation: blob 7s infinite; }
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }
        body { font-family: 'Kanit', sans-serif; touch-action: manipulation; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .smooth-scroll { -webkit-overflow-scrolling: touch; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .badge-pulse { animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 6px rgba(37, 99, 235, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏ô <style> */

        /* ‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡πâ‡∏á */
        .btn-pop {
            transform: scale(1.25) !important; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô 25% */
            background-color: #bfdbfe !important; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô (bg-blue-200) */
            color: #1d4ed8 !important; /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2) !important;
            z-index: 50; /* ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≤‡∏á‡πÜ */
            transition: all 0.1s ease-out; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏• */
        }
    </style>
</head>

<body class="bg-gray-100 h-[100dvh] flex flex-col overflow-hidden text-gray-800">

    <div id="loginScreen" class="fixed inset-0 z-[9999] bg-gradient-to-br from-blue-900 via-blue-800 to-gray-900 flex items-center justify-center p-4 transition-all duration-500">
        <div class="absolute inset-0 overflow-hidden opacity-20 pointer-events-none">
            <div class="absolute top-0 left-0 w-64 h-64 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob"></div>
            <div class="absolute top-0 right-0 w-64 h-64 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-2000"></div>
            <div class="absolute -bottom-8 left-20 w-64 h-64 bg-pink-500 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-4000"></div>
        </div>

        <div class="bg-white/10 backdrop-blur-lg border border-white/20 p-8 rounded-3xl shadow-2xl w-full max-w-sm relative overflow-hidden animate-slide-up">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-tr from-blue-500 to-cyan-400 rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-4 transform rotate-3 hover:rotate-6 transition">
                    <i class="fas fa-store text-4xl text-white"></i>
                </div>
                <h2 class="text-3xl font-extrabold text-white tracking-wide">‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏û‡∏¥‡∏ô</h2>
                <p class="text-blue-200 text-sm mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (POS)</p>
            </div>

            <div id="loginErrorBox" class="hidden bg-red-500/20 border border-red-500/50 rounded-xl p-3 mb-4 flex items-center gap-3 animate-pulse">
                <div class="bg-red-500 rounded-full w-6 h-6 flex items-center justify-center shrink-0">
                    <i class="fas fa-exclamation text-white text-xs"></i>
                </div>
                <p id="loginErrorMsg" class="text-red-100 text-sm font-bold">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
            </div>

            <form id="loginForm" class="space-y-5">
                <div class="space-y-1">
                    <label class="text-blue-200 text-xs font-bold uppercase ml-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="fas fa-phone text-blue-300"></i></div>
                        <input type="tel" id="loginPhone" class="w-full bg-black/20 border border-white/10 rounded-xl py-3.5 pl-11 pr-4 text-white placeholder-blue-300/50 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:bg-black/30 transition text-lg font-bold tracking-wide" placeholder="08X-XXX-XXXX" required>
                    </div>
                </div>
                
                <div class="space-y-1">
                    <label class="text-blue-200 text-xs font-bold uppercase ml-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="fas fa-lock text-blue-300"></i></div>
                        <input type="password" id="loginPass" class="w-full bg-black/20 border border-white/10 rounded-xl py-3.5 pl-11 pr-4 text-white placeholder-blue-300/50 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:bg-black/30 transition text-lg tracking-widest" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                </div>

                <button type="submit" id="btnLogin" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-bold py-4 rounded-xl shadow-lg transform transition active:scale-95 text-lg mt-4 flex justify-center items-center gap-2">
                    <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span> <i class="fas fa-arrow-right"></i>
                </button>
            </form>
            <p class="text-center text-white/20 text-xs mt-6">Secure System V.1.0</p>
        </div>
    </div>

    <div id="logoutModal" class="fixed inset-0 z-[10000] bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop relative">
            <div class="bg-red-500 h-24 flex items-center justify-center relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center shadow-lg relative z-10">
                    <i class="fas fa-power-off text-3xl text-white"></i>
                </div>
            </div>
            
            <div class="p-8 text-center">
                <h3 class="text-2xl font-extrabold text-gray-800 mb-2">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?</h3>
                <p class="text-gray-500 mb-8 text-sm">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤<br>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                
                <div class="flex gap-3">
                    <button onclick="closeModal('logoutModal')" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-3.5 rounded-xl transition">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button onclick="confirmLogout()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-red-200 transition transform active:scale-95">
                        ‡πÉ‡∏ä‡πà, ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="changePassModal" class="fixed inset-0 bg-black/80 hidden z-[150] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop">
            <div class="bg-gray-800 p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-key mr-2 text-yellow-400"></i>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
                <button onclick="closeModal('changePassModal')" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-sm text-yellow-800 flex items-start gap-2">
                    <i class="fas fa-info-circle mt-0.5"></i>
                    <span>‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                </div>
                
                <div>
                    <label class="block text-gray-600 text-sm font-bold mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <input type="tel" id="changePassPhone" class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-blue-500 outline-none text-lg font-bold tracking-wide" placeholder="08X-XXX-XXXX">
                </div>

                <div>
                    <label class="block text-gray-600 text-sm font-bold mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                    <input type="password" id="newPasswordInput" class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-blue-500 outline-none text-lg font-bold text-center tracking-widest" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                </div>
                
                <button onclick="submitChangePassword()" id="btnSubmitChangePass" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg transition">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>
    </div>

    <div id="customerIdentityModal" class="fixed inset-0 z-[200] bg-gray-900 flex items-center justify-center p-4 hidden animate-fade-in bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop relative">
            <div class="bg-blue-600 h-32 flex items-center justify-center relative overflow-hidden">
                <div class="absolute inset-0 bg-white/10 opacity-50"></div>
                <div class="w-20 h-20 bg-white text-blue-600 rounded-full flex items-center justify-center shadow-lg text-3xl animate-bounce">
                    <i class="fas fa-user-edit"></i>
                </div>
            </div>
            
            <div class="p-8">
                <h2 class="text-2xl font-extrabold text-center text-gray-800 mb-2">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö</h2>
                <p class="text-center text-gray-500 mb-6 text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô<br>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞</p>
                
                <form id="customerIdentityForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô / ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                    <input type="text" id="custIdName" class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-blue-500 outline-none font-bold text-lg bg-gray-50" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏µ‡πà‡∏´‡∏ô‡∏∏‡πà‡∏°, ‡∏ô‡πâ‡∏≠‡∏á‡∏û‡∏•‡∏≠‡∏¢" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠)</label>
                    <input type="tel" id="custIdPhone" class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-blue-500 outline-none font-bold text-lg bg-gray-50 tracking-wider" placeholder="08X-XXX-XXXX" required minlength="9" maxlength="10">
                </div>
                
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà *</label>
                        <input type="text" id="custIdHouseNo" class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-blue-500 outline-none font-bold text-lg bg-gray-50" placeholder="‡πÄ‡∏ä‡πà‡∏ô 99/9" required>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">‡∏ã‡∏≠‡∏¢/‡∏ñ‡∏ô‡∏ô *</label>
                        <input type="text" id="custIdSoi" class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-blue-500 outline-none font-bold text-lg bg-gray-50" placeholder="‡∏ã. 15, ‡∏ñ.‡∏´‡∏•‡∏±‡∏Å" required>
                    </div>
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition transform active:scale-95 text-lg mt-4">
                    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </form>
            </div>
        </div>
    </div>


    <!-- Navbar -->
    <nav class="bg-gradient-to-r from-blue-700 to-blue-900 text-white p-2 shadow-lg flex justify-between items-center z-30 shrink-0 gap-2">
        <div class="flex items-center gap-2 overflow-hidden shrink-0">
            <div class="bg-white text-blue-700 p-1.5 rounded-full w-9 h-9 flex items-center justify-center font-bold shadow shrink-0">üè™</div>
            <div class="flex flex-col">
                <h1 class="text-lg font-bold tracking-wide whitespace-nowrap truncate hidden sm:block">‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏û‡∏¥‡∏ô</h1>
                <h1 class="text-lg font-bold tracking-wide whitespace-nowrap truncate sm:hidden">‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏û‡∏¥‡∏ô</h1>
                <span id="dateTimeDisplay" class="text-xs sm:text-lg text-blue-200 font-mono leading-none">...</span>
            </div>
        </div>
        
        <div id="adminToolbar" class="flex gap-2 overflow-x-auto hide-scrollbar smooth-scroll items-center min-w-0 ml-auto">
            <button onclick="toggleFloatingNumpad()" class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-1.5 rounded-lg text-sm transition border border-gray-600 shrink-0 font-bold mr-1 shadow-md">
                <i class="fas fa-th"></i>
            </button>


            <button onclick="logout()" class="bg-red-500/20 hover:bg-red-500 text-white px-3 py-1.5 rounded-lg text-sm transition border border-red-500/30 shrink-0 font-bold mr-1 group">
                <i class="fas fa-power-off group-hover:scale-110 transition-transform"></i>
            </button>
            
            <button onclick="openChangePassModal()" class="bg-yellow-500/20 hover:bg-yellow-500 text-white px-3 py-1.5 rounded-lg text-sm transition border border-yellow-500/30 shrink-0 font-bold mr-2 group">
                <i class="fas fa-key text-yellow-400 group-hover:text-white transition-colors"></i>
            </button>
             <div onclick="toggleStoreStatus()" class="cursor-pointer bg-white/10 hover:bg-white/20 rounded-full px-2 py-1 flex items-center gap-2 transition mr-2 border border-white/20 group">
                <div id="storeToggleBg" class="w-10 h-5 rounded-full relative transition-colors duration-300 shadow-inner flex items-center">
                    <div id="storeToggleDot" class="w-4 h-4 bg-white rounded-full absolute shadow-md transform transition-transform duration-300 left-0.5"></div>
                </div>
                <span id="storeStatusText" class="text-xs font-bold text-white group-hover:text-blue-100 min-w-[35px]">‡πÄ‡∏õ‡∏¥‡∏î</span>
            </div>

            <button onclick="openQRModal()" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-lg text-sm transition border border-white/20 shrink-0 font-bold"><i class="fas fa-qrcode"></i> <span class="hidden sm:inline">QR ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span></button>
            <button onclick="openKitchenModal()" class="relative bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-lg flex items-center gap-2 text-sm transition border border-white/20 whitespace-nowrap shrink-0">
                <i class="fas fa-box-open"></i> <span class="hidden sm:inline">‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á</span>
                <span id="kitchenBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-white hidden badge-pulse shadow-md z-50">0</span>
            </button>
            <button onclick="openSalesModal()" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-lg text-sm transition border border-white/20 shrink-0"><i class="fas fa-chart-line"></i></button>
            <button onclick="openHistoryModal()" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-lg text-sm transition border border-white/20 shrink-0"><i class="fas fa-history"></i></button>
            <button onclick="openExportModal()" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1.5 rounded-lg text-sm shadow-lg font-bold whitespace-nowrap shrink-0 border border-red-700 mr-2">
                <i class="fas fa-file-pdf"></i> <span class="hidden sm:inline">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>
            </button>
            <button onclick="openAddMenuModal()" class="bg-green-500 hover:bg-green-400 text-white px-3 py-1.5 rounded-lg text-sm shadow-lg font-bold whitespace-nowrap shrink-0 border border-green-600"><i class="fas fa-plus"></i> <span class="hidden sm:inline">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span></button>
        </div>

        <div id="customerToolbar" class="hidden flex items-center justify-end gap-2 flex-1">
             <button onclick="openMyRecentOrder()" class="bg-white/20 hover:bg-white/30 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm flex items-center gap-1 border border-white/30 active:scale-95 transition">
                <i class="fas fa-receipt"></i>
            </button>
            
            <div class="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-xs font-bold shadow-sm flex items-center gap-1 animate-pulse"><i class="fas fa-clock"></i><span id="queueCountDisplay">0</span> ‡∏Ñ‡∏¥‡∏ß</div>
            <span class="bg-white/20 px-3 py-1 rounded-full text-sm font-bold text-white"><i class="fas fa-user mr-1"></i> <span id="customerTableDisplay">...</span></span>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden relative">
        <!-- Left: Menu Area -->
        <div id="leftPanel" class="flex-1 flex flex-col bg-gray-100 h-full min-w-0 transition-all duration-300">
            <!-- SEARCH BAR -->
            <div class="bg-white p-3 shadow-sm z-20 border-b border-gray-200">
                <div class="relative flex gap-2">
    <div class="relative flex-1">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-barcode text-gray-400"></i></div>
        
        <input type="text" id="searchInput" inputmode="none" 
               oninput="this.value = this.value.replace(/[.+]/g, '')" 
               onkeyup="searchMenu()" 
               onkeydown="handleSearchKeydown(event)" 
               class="block w-full pl-10 pr-10 py-2.5 border border-gray-200 rounded-xl leading-5 bg-gray-50 text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 sm:text-sm transition shadow-inner" 
               placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î...">
               
        <div class="absolute inset-y-0 right-0 pr-2 flex items-center">
            <button onclick="clearSearch()" class="text-gray-400 hover:text-gray-600 p-1 hidden" id="clearSearchBtn"><i class="fas fa-times-circle"></i></button>
        </div>
    </div>

    <button onclick="toggleSystemKeyboard()" id="btnToggleKey" class="bg-white border border-gray-200 text-gray-400 hover:text-blue-600 hover:border-blue-300 w-12 rounded-xl flex items-center justify-center shadow-sm transition">
        <i class="fas fa-keyboard"></i>
    </button>
</div>
            </div>

            <!-- CATEGORY BAR -->
            <div class="p-2 bg-white shadow-sm border-b border-gray-200 flex gap-2 overflow-x-auto whitespace-nowrap z-10 shrink-0 smooth-scroll hide-scrollbar" id="categoryBar"></div>

            <!-- MENU GRID -->
            <div class="flex-1 overflow-y-auto p-4 pb-24 lg:pb-4 relative custom-scrollbar bg-gray-100" id="menuContainer">
                <div id="loadingMenu" class="absolute inset-0 flex flex-col items-center justify-center bg-white/80 z-20 backdrop-blur-sm hidden"><i class="fas fa-circle-notch fa-spin text-4xl text-blue-500 mb-3"></i><p class="text-gray-500 font-medium animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</p></div>
                <div id="menuGrid" class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 lg:gap-4 content-start"></div>
                
                <!-- No Results / Error State -->
                <div id="noResults" class="hidden flex flex-col items-center justify-center py-10 text-gray-400 text-center">
                    <i class="fas fa-box-open text-6xl mb-4 text-gray-300"></i>
                    <p class="mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                    <button onclick="fetchMenu()" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-200 transition">
                        <i class="fas fa-sync-alt mr-1"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
            </div>
        </div>

        <!-- Right: Cart Area -->
        <div id="cartPanel" class="hidden md:flex flex-col w-full md:w-[340px] lg:w-[400px] bg-white shadow-2xl border-l border-gray-200 z-40 md:z-[101] fixed inset-0 md:relative md:h-auto animate-slide-up md:animate-none">
            
            <div class="lg:hidden bg-blue-700 text-white p-4 flex justify-between items-center shadow-md shrink-0">
                <h2 class="text-xl font-bold"><i class="fas fa-shopping-cart mr-2"></i>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                <button onclick="toggleCart(false)" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-down"></i></button>
            </div>
            
            <div class="hidden md:flex flex-col bg-blue-50 border-b border-blue-100 shrink-0 relative overflow-hidden transition-all duration-500" id="cartHeaderArea">
                <div class="absolute top-0 right-0 w-32 h-32 bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
                
                <div class="p-4 pb-2 flex items-center justify-between relative z-10">
                     <div class="flex flex-col justify-center">
                        <h2 class="text-lg font-bold text-blue-800 flex items-center gap-2"><i class="fas fa-shopping-cart"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>
                        <span id="cartCountDesktop" class="bg-blue-200 text-blue-800 text-[10px] font-bold px-2 py-0.5 rounded-full w-fit mt-1">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                     </div>
                     
                     <div class="text-right flex flex-col items-end transition-all duration-500" id="priceDisplayBox">
                        <span class="block text-7xl font-extrabold text-transparent bg-clip-text bg-gradient-to-br from-blue-600 to-blue-900 tracking-tighter leading-none drop-shadow-sm filter transition-all duration-500 origin-right" 
                              id="totalPrice" 
                              style="text-shadow: 2px 2px 0px rgba(7, 2, 77, 0);">
                            0 ‡∏ø
                        </span>

                        <div id="changeWrapper" class="hidden opacity-0 transform translate-y-4 transition-all duration-500 mt-1">
                            <span class="text-gray-500 text-xs font-bold mr-2">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</span>
                            <span id="mainScreenChange" class="text-5xl font-extrabold text-green-600 drop-shadow-sm">0 ‡∏ø</span>
                        </div>
                     </div>
                </div>
                
                <div class="flex gap-2 px-4 pb-3 relative z-10">
                    <button onclick="holdBill()" class="flex-1 bg-white text-orange-600 border border-orange-200 hover:bg-orange-50 text-xs font-bold py-1.5 rounded-lg transition shadow-sm transform active:scale-95"><i class="fas fa-pause mr-1"></i> ‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•</button>
                    <button onclick="openRecallModal()" class="flex-1 bg-white text-blue-600 border border-blue-200 hover:bg-blue-50 text-xs font-bold py-1.5 rounded-lg transition shadow-sm transform active:scale-95"><i class="fas fa-history mr-1"></i> ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ö‡∏¥‡∏•</button>
                </div>
            </div>

            <div id="cartItems" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white">
                <div class="h-full flex flex-col items-center justify-center text-gray-400 opacity-60">
                    <i class="fas fa-cash-register text-6xl mb-4"></i>
                    <p>‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                </div>
            </div>

            <div class="p-4 bg-white border-t border-gray-200 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] shrink-0 pb-safe md:hidden">
    <button onclick="handleCheckoutClick()" id="btnOrderMobile" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 text-lg transition transform active:scale-95 flex justify-center items-center gap-2">
        <span>‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô</span> <i class="fas fa-arrow-right"></i>
    </button>
</div>

<div id="embeddedNumpadPanel" class="hidden md:flex flex-col bg-gray-50 border-t border-gray-300 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] shrink-0 transition-all duration-300 ease-in-out relative z-[200]">
    
    <div onclick="toggleEmbeddedNumpad()" class="h-6 flex items-center justify-center cursor-pointer hover:bg-blue-50 transition-colors group border-b border-gray-200 bg-white rounded-t-xl mx-2 -mt-3 shadow-sm relative z-10">
        <div class="flex gap-1 group-hover:gap-1.5 transition-all duration-300">
            <div class="w-1.5 h-1.5 bg-gray-300 rounded-full group-hover:bg-blue-400"></div>
            <div class="w-1.5 h-1.5 bg-gray-300 rounded-full group-hover:bg-blue-400"></div>
            <div class="w-1.5 h-1.5 bg-gray-300 rounded-full group-hover:bg-blue-400"></div>
        </div>
    </div>

    <div id="embeddedKeys" class="grid grid-cols-4 gap-2 p-3 pb-4">
    
        <button onclick="numpadPress('7', this)" class="h-12 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition active:scale-95">7</button>
        <button onclick="numpadPress('8', this)" class="h-12 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition active:scale-95">8</button>
        <button onclick="numpadPress('9', this)" class="h-12 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition active:scale-95">9</button>
        <button onclick="numpadAction('del')" class="h-12 bg-red-50 border border-red-100 shadow-sm rounded-lg text-red-500 hover:bg-red-100 transition active:scale-95"><i class="fas fa-backspace"></i></button>

        <button onclick="numpadPress('4', this)" class="h-12 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition active:scale-95">4</button>
        <button onclick="numpadPress('5', this)" class="h-12 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition active:scale-95">5</button>
        <button onclick="numpadPress('6', this)" class="h-12 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition active:scale-95">6</button>
        
        <button id="btnOrderDesktop" onclick="handleCheckoutClick()" class="h-12 bg-gradient-to-b from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold text-lg rounded-lg shadow-md border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition-all flex flex-col items-center justify-center gap-1">
            <span class="text-xs font-normal opacity-80">‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô</span>
        </button>

        <button onclick="numpadPress('1', this)" class="h-12 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition active:scale-95">1</button>
        <button onclick="numpadPress('2', this)" class="h-12 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition active:scale-95">2</button>
        <button onclick="numpadPress('3', this)" class="h-12 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition active:scale-95">3</button>
        
        <button onclick="numpadAction('enter')" class="row-span-2 h-full bg-blue-600 border border-blue-700 shadow-md rounded-lg text-white font-bold text-xl hover:bg-blue-700 transition active:scale-95 flex flex-col items-center justify-center">
            <i class="fas fa-arrow-left mb-1"></i> Enter
        </button>

        <button onclick="numpadPress('0', this)" class="col-span-3 h-12 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition active:scale-95">0</button>
        
    </div>
    
    <div id="minimizedBar" class="hidden px-4 pb-4 pt-1">
         <button onclick="handleCheckoutClick()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow transition flex justify-center items-center gap-2">
            <span>‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</span> <span id="miniTotalDisplay" class="bg-blue-800 px-2 py-0.5 rounded text-sm">0 ‡∏ø</span>
        </button>
    </div>
</div>
        </div>

        <!-- Mobile Bottom Bar -->
        <div id="mobileBottomBar" onclick="toggleCart(true)" class="md:hidden fixed bottom-4 left-4 right-4 bg-gray-900 text-white p-4 rounded-2xl shadow-2xl flex justify-between items-center z-20 cursor-pointer transform transition-all duration-300 translate-y-[150%] active:scale-95 border border-gray-700/50 backdrop-blur-md bg-opacity-95">
            <div class="flex items-center gap-3"><div class="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold shadow-lg ring-2 ring-blue-900" id="mobileCartCount">0</div><div class="flex flex-col"><span class="text-xs text-gray-400">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span class="font-bold text-lg leading-none" id="mobileCartTotal">0 ‡∏ø</span></div></div>
            <div class="flex items-center gap-2 text-blue-400 font-bold text-sm">‡∏î‡∏π‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ <i class="fas fa-chevron-up"></i></div>
        </div>
    </div>

    <!-- Modals -->
    <!-- QR Modal -->
    <div id="qrModal" class="fixed inset-0 bg-black/60 hidden z-[200] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop"><div class="bg-gray-800 p-4 text-white flex justify-between items-center"><h3 class="font-bold text-lg"><i class="fas fa-qrcode mr-2"></i>QR ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏±‡πà‡∏á</h3><button onclick="closeModal('qrModal')" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8"><i class="fas fa-times"></i></button></div><div class="p-6 text-center space-y-4"><div id="qrResult" class="flex flex-col items-center pt-2"><img id="qrImage" class="w-56 h-56 border-4 border-white shadow-lg mb-3" src=""><p class="text-sm text-gray-500 mb-2">‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p><a id="qrLink" href="#" target="_blank" class="text-blue-600 text-xs underline break-all">‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå</a></div></div></div></div>
    
    <!-- Recall Bill Modal -->
    <div id="recallModal" class="fixed inset-0 bg-black/60 hidden z-[200] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop flex flex-col max-h-[80vh]"><div class="bg-blue-600 p-4 text-white flex justify-between items-center shrink-0"><h3 class="font-bold text-lg"><i class="fas fa-history mr-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•‡πÑ‡∏ß‡πâ</h3><button onclick="closeModal('recallModal')" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8"><i class="fas fa-times"></i></button></div><div id="heldBillsList" class="p-4 overflow-y-auto space-y-2 bg-gray-50 flex-1"></div></div></div>

    <!-- Toast & Alerts -->
    <div id="toast" class="fixed top-5 right-5 z-[100] transform transition-all duration-300 translate-x-[150%] bg-white border-l-4 border-green-500 shadow-2xl rounded-lg p-4 flex items-center gap-3 min-w-[300px]"><div class="bg-green-100 text-green-600 rounded-full w-8 h-8 flex items-center justify-center shrink-0"><i class="fas fa-check"></i></div><div><h4 class="font-bold text-gray-800 text-sm">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h4><p class="text-xs text-gray-500" id="toastMsg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</p></div></div>
    <div id="customAlert" class="fixed inset-0 z-[100] bg-black/70 hidden flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"><div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center animate-pop"><div id="alertIcon" class="text-5xl mb-4"></div><h3 id="alertTitle" class="text-xl font-bold text-gray-800 mb-2"></h3><p id="alertMsg" class="text-gray-500 mb-6 text-sm"></p><button onclick="closeCustomAlert()" class="w-full bg-gray-800 hover:bg-gray-900 text-white py-3 rounded-xl font-bold">‡∏ï‡∏Å‡∏•‡∏á</button></div></div>
    <div id="confirmActionModal" class="fixed inset-0 z-[110] bg-black/70 hidden flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"><div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center animate-pop"><div id="confirmActionIcon" class="text-5xl mb-4 text-red-500"></div><h3 id="confirmActionTitle" class="text-xl font-bold text-gray-800 mb-2"></h3><p id="confirmActionMsg" class="text-gray-500 mb-6 text-sm"></p><div class="flex gap-4"><button onclick="closeModal('confirmActionModal')" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 rounded-xl font-bold transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button id="btnConfirmAction" onclick="" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div></div></div>
    
    <!-- PromptPay Setting Modal -->
    <div id="promptPayModal" class="fixed inset-0 bg-black/60 hidden z-[150] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop">
            <div class="bg-blue-600 p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-cog mr-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</h3>
                <button onclick="closeModal('promptPayModal')" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-center gap-3">
                    <img src="https://promptpay.io/logo.png" class="w-12 h-auto opacity-80" onerror="this.style.display='none'">
                    <div>
                        <p class="text-sm font-bold text-blue-900">‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                        <p class="text-[10px] text-blue-600">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô/Tax ID</p>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-600 text-sm font-bold mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</label>
                    <input type="tel" id="ppInput" class="w-full text-xl font-bold text-center border-2 border-gray-300 rounded-xl p-3 focus:border-blue-500 outline-none tracking-wider text-blue-700 placeholder-gray-300" placeholder="08X-XXX-XXXX">
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="clearPromptPayID()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-500 font-bold py-3 rounded-xl transition">‡∏•‡∏ö / ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                    <button onclick="savePromptPayID()" class="flex-[2] bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Manage QR Modal -->
    <div id="manageQRModal" class="fixed inset-0 bg-black/60 hidden z-[150] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop">
            <div class="bg-gray-800 p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-image mr-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ QR Code</h3>
                <button onclick="closeModal('manageQRModal')" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 text-center space-y-4">
                <div class="bg-gray-100 p-6 rounded-xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center">
                    <div id="mqrStatusIcon" class="text-4xl text-gray-300 mb-2"><i class="fas fa-image"></i></div>
                    <p id="mqrStatusText" class="text-gray-500 font-medium">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                </div>
                
                <div class="flex flex-col gap-3 pt-2">
                    <button onclick="document.getElementById('bankQRInput').click()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition flex justify-center items-center gap-2">
                        <i class="fas fa-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà
                    </button>
                    <button id="btnDeleteQR" onclick="deleteServerQR()" class="w-full bg-red-100 hover:bg-red-200 text-red-600 font-bold py-3 rounded-xl transition hidden">
                        <i class="fas fa-trash-alt mr-1"></i> ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="deliveryNotificationModal" class="fixed inset-0 bg-black/80 hidden z-[120] flex items-center justify-center p-4 backdrop-blur-md animate-fade-in">
        <div class="bg-white rounded-3xl shadow-[0_0_50px_rgba(37,99,235,0.25)] w-full max-w-sm overflow-hidden animate-pop relative">
            <div class="bg-gradient-to-br from-green-400 to-green-600 h-32 flex items-center justify-center relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                <div class="bg-white/20 p-6 rounded-full shadow-lg backdrop-blur-sm animate-bounce">
                    <i class="fas fa-shipping-fast text-5xl text-white"></i>
                </div>
            </div>
            
            <div class="p-8 text-center">
                <h3 class="text-2xl font-extrabold text-gray-800 mb-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏™‡πà‡∏á!</h3>
                <div class="w-16 h-1 bg-green-500 mx-auto rounded-full mb-4"></div>
                <p class="text-gray-500 mb-8 leading-relaxed">‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞</p>
                
                <button onclick="closeModal('deliveryNotificationModal')" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-4 rounded-2xl shadow-lg transition transform active:scale-95 text-lg">
                    ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞ üëç
                </button>
            </div>
        </div>
    </div>

    <div id="storeClosedModal" class="fixed inset-0 bg-gray-900 z-[200] hidden flex items-center justify-center p-6 animate-fade-in bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
        <div class="bg-gray-800/90 backdrop-blur-xl border border-gray-700 rounded-3xl shadow-[0_0_50px_rgba(239,68,68,0.3)] w-full max-w-sm overflow-hidden text-center relative animate-pop">
            <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-32 h-1 bg-red-500 shadow-[0_0_20px_rgba(239,68,68,1)]"></div>
            
            <div class="p-10">
                <div class="w-24 h-24 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner relative">
                    <i class="fas fa-store-slash text-5xl text-gray-400"></i>
                    <div class="absolute -bottom-2 -right-2 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg border-2 border-gray-800">CLOSED</div>
                </div>
                
                <h2 class="text-3xl font-extrabold text-white mb-2 tracking-wide">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß</h2>
                <p class="text-gray-400 mb-8 font-light">‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£<br>‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞</p>
                
                <div class="flex justify-center gap-2">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            </div>
            
            <div class="bg-gray-900/50 p-4 border-t border-gray-700">
                <p class="text-xs text-gray-500">‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏û‡∏¥‡∏ô ‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏≥</p>
            </div>
        </div>
    </div>
    
    <div id="myOrderModal" class="fixed inset-0 bg-black/60 hidden z-[130] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-pop flex flex-col max-h-[80vh]">
            <div class="bg-blue-600 p-4 text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold"><i class="fas fa-clipboard-list mr-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                <button onclick="closeModal('myOrderModal')" class="bg-white/20 rounded-full w-8 h-8"><i class="fas fa-times"></i></button>
            </div>
            <div id="myOrderContent" class="p-4 overflow-y-auto flex-1 bg-gray-50">
                <p class="text-center text-gray-400 mt-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
            </div>
        </div>
    </div>


    <div id="minOrderModal" class="fixed inset-0 bg-black/80 hidden z-[130] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop text-center relative border border-gray-100">
            <div class="bg-gradient-to-br from-orange-400 to-red-500 h-28 flex items-center justify-center relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>
                <div class="bg-white p-4 rounded-full shadow-lg mt-8 relative z-10">
                    <i class="fas fa-shopping-basket text-4xl text-orange-500"></i>
                    <div class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold w-6 h-6 flex items-center justify-center rounded-full border-2 border-white">!</div>
                </div>
            </div>
            
            <div class="pt-10 pb-8 px-8">
                <h3 class="text-2xl font-extrabold text-gray-800 mb-2">‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100 ‡∏ö‡∏≤‡∏ó</h3>
                <p class="text-gray-500 mb-6 text-sm leading-relaxed">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏°‡∏µ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏™‡πà‡∏á<br>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ 100 ‡∏ö‡∏≤‡∏ó‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏ô‡∏∞‡∏Ñ‡∏∞</p>
                
                <div class="bg-orange-50 rounded-xl p-4 border border-orange-100 mb-6">
                    <p class="text-gray-600 text-xs font-bold uppercase mb-1">‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å</p>
                    <p class="text-orange-600 font-extrabold text-3xl"><span id="diffAmount">0</span> <span class="text-sm text-gray-400">‡∏ö‡∏≤‡∏ó</span></p>
                </div>

                <button onclick="closeModal('minOrderModal')" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                    <i class="fas fa-cart-plus"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°
                </button>
            </div>
        </div>
    </div>



    <div id="deleteBillModal" class="fixed inset-0 bg-black/80 hidden z-[200] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop text-center relative">
            <div class="bg-red-100 p-6 flex justify-center items-center">
                <div class="w-20 h-20 bg-red-500 rounded-full flex items-center justify-center shadow-lg animate-bounce">
                    <i class="fas fa-trash-alt text-4xl text-white"></i>
                </div>
            </div>
            <div class="p-6">
                <h3 class="text-2xl font-extrabold text-gray-800 mb-2">‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?</h3>
                <p class="text-gray-500 text-sm mb-6">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£<br>‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏î‡∏•‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                <input type="hidden" id="deleteBillIdTarget">
                
                <div class="flex gap-3">
                    <button onclick="closeModal('deleteBillModal')" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-xl transition">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button onclick="executeDeleteBill()" id="btnConfirmDeleteBill" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div id="confirmOrderModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-end lg:items-center justify-center p-0 lg:p-4 backdrop-blur-sm">
        <div class="bg-white rounded-t-2xl lg:rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up h-[90vh] lg:h-auto flex flex-col">
            <div class="bg-blue-700 p-4 text-white flex justify-between items-center shrink-0"><h3 class="font-bold text-lg"><i class="fas fa-clipboard-check mr-2"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3><button onclick="closeModal('confirmOrderModal')" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8"><i class="fas fa-times"></i></button></div>
            <div class="p-6 overflow-y-auto flex-1">
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-4 max-h-40 overflow-y-auto" id="summaryList"></div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà</label><input type="text" id="tableNo" class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-blue-500 outline-none text-center text-xl font-bold bg-gray-50" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1 ‡∏´‡∏£‡∏∑‡∏≠ A"></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="orderType" onchange="toggleAddressFields()" class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-blue-500 outline-none bg-white font-bold text-gray-700 h-full"><option value="‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô">üõí ‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</option><option value="‡∏™‡πà‡∏á‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà">üõµ ‡∏™‡πà‡∏á‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà</option><option value="‡∏à‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô">üì¶ ‡∏à‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô</option></select></div>
                    </div>
                    <div id="addressSection" class="hidden bg-blue-50 p-3 rounded-xl border border-blue-200 animate-fade-in">
                        <label class="block text-xs font-bold text-blue-800 uppercase mb-2"><i class="fas fa-map-marker-alt text-blue-500"></i> ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
                        <div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] text-gray-500 font-bold">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label><input type="text" id="addrHouseNo" class="w-full border border-blue-200 rounded-lg p-2 focus:border-blue-500 outline-none text-sm bg-white" placeholder="123/45"></div><div><label class="text-[10px] text-gray-500 font-bold">‡∏ã‡∏≠‡∏¢ / ‡∏ñ‡∏ô‡∏ô</label><input type="text" id="addrSoi" class="w-full border border-blue-200 rounded-lg p-2 focus:border-blue-500 outline-none text-sm bg-white" placeholder="‡∏ã‡∏≠‡∏¢ 5"></div></div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea id="orderNote" class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-blue-500 outline-none text-sm" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏™‡πà‡∏ñ‡∏∏‡∏á‡πÅ‡∏¢‡∏Å, ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô..."></textarea></div>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 shrink-0"><button onclick="submitOrder()" id="btnSubmitOrder" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg text-lg flex justify-center items-center gap-2 transition-all active:scale-95"><span class="btn-text">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span> <i class="fas fa-check-circle"></i></button></div>
        </div>
    </div>
    
    <div id="kitchenModal" class="fixed inset-0 bg-gray-100 hidden z-[200] flex flex-col animate-slide-up"><div class="bg-orange-600 p-4 text-white flex justify-between items-center shadow-md shrink-0"><h3 class="font-bold text-lg"><i class="fas fa-box mr-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</h3><div class="flex gap-2"><button onclick="fetchOrders()" class="bg-white/20 rounded px-3 py-1"><i class="fas fa-sync-alt"></i></button><button onclick="closeModal('kitchenModal')" class="bg-white/20 rounded px-3 py-1"><i class="fas fa-times"></i></button></div></div><div class="flex-1 overflow-y-auto p-4 bg-gray-100 custom-scrollbar"><div id="kitchenGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-10"></div></div></div>
    
    <div id="paymentModal" class="fixed inset-0 z-[100] hidden flex items-start justify-start">
    <div class="absolute inset-0" onclick="closeModal('paymentModal')"></div>

    <div id="draggableModal" class="bg-white rounded-2xl shadow-[0_0_50px_rgba(0,0,0,0.2)] w-full max-w-xs overflow-hidden animate-pop absolute border border-gray-200 z-[200]" style="left: 20%; top: 15%;">
        
        <div id="modalHeader" class="bg-blue-900 p-3 text-white flex justify-between items-center shrink-0 cursor-move">
            <h3 class="font-bold text-base"><i class="fas fa-hand-holding-usd mr-2"></i>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <button onclick="closeModal('paymentModal')" 
                    onmousedown="event.stopPropagation()" 
                    ontouchstart="event.stopPropagation()" 
                    class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8 flex items-center justify-center transition shadow-sm">
                <i class="fas fa-times text-sm"></i>
            </button>
        </div>
        
        <div class="p-4">
            <div id="quickPayTableNoContainer" class="hidden"><input type="text" id="quickPayTableNo"></div>
            
            <div class="bg-gray-50 p-2 rounded-xl border border-gray-100 text-center mb-2 relative group-qr">
    
    <button onclick="togglePaymentMenu()" class="absolute top-3 right-3 z-20 w-8 h-8 bg-white/90 hover:bg-white rounded-full text-gray-500 hover:text-blue-600 shadow-md flex items-center justify-center transition backdrop-blur-sm border border-gray-200">
        <i class="fas fa-ellipsis-v"></i>
    </button>

    <div id="paymentSettingsMenu" class="hidden absolute top-12 right-3 z-30 bg-white shadow-xl rounded-xl border border-gray-100 p-1.5 w-44 flex flex-col gap-1 animate-pop origin-top-right">
        <button onclick="openPromptPayModal(); togglePaymentMenu()" class="text-left text-xs font-bold text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition flex items-center">
            <i class="fas fa-cog w-6 text-center mr-1"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå
        </button>
        <button onclick="checkAndUseOriginalQR(); togglePaymentMenu()" class="text-left text-xs font-bold text-gray-600 hover:bg-gray-100 p-2 rounded-lg transition flex items-center">
            <i class="fas fa-image w-6 text-center mr-1"></i> ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°
        </button>
        <div class="h-px bg-gray-100 my-0.5"></div>
         <button onclick="document.getElementById('bankQRInput').click(); togglePaymentMenu()" class="text-left text-xs font-bold text-gray-500 hover:bg-gray-100 p-2 rounded-lg transition flex items-center">
            <i class="fas fa-upload w-6 text-center mr-1"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà
        </button>
    </div>

    <div class="relative overflow-hidden rounded-lg bg-white h-64 flex items-center justify-center cursor-pointer group shadow-inner" onclick="handleQRClick()">
        <img id="bankQRImage" src="" class="h-full w-auto object-contain p-2" alt="QR">
        <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
            <span class="text-white text-xs font-bold"><i class="fas fa-expand"></i> ‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÄ‡∏ï‡πá‡∏°</span>
        </div>
    </div>
    
    <input type="file" id="bankQRInput" class="hidden" accept="image/*" onchange="uploadBankQRFile(this)">
</div>

            <div class="flex justify-between items-end px-4 mb-2 h-8">
                <div class="text-xs font-bold text-gray-500 flex items-baseline">
                    ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span id="modalTotalPay" class="text-blue-600 text-4xl font-extrabold ml-2 animate-heartbeat">0</span> <span class="ml-1 text-sm">‡∏ø</span>
                </div>
                <div id="modalChangeBox" class="text-xs font-bold text-gray-500 opacity-0 transform translate-y-2 transition-all duration-300">
                    ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: <span id="modalChangePay" class="text-green-600 text-lg ml-1 drop-shadow-sm">0</span> ‡∏ø
                </div>
            </div>
            
            <div class="mb-3 relative text-center">
                <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-wide">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</label>
                <div class="relative">
                    <input type="text" id="inputReceived" inputmode="none"
                        oninput="this.value = this.value.replace(/[^0-9]/g, ''); calcChange()" 
                        onkeydown="checkPaymentEnter(event)" 
                        class="w-1/3 mx-auto block text-1xl font-extrabold text-center border border-blue-500 rounded-lg p-0.5 text-blue-600 placeholder-gray-200 focus:ring-4 focus:ring-blue-100 outline-none transition-all shadow-inner bg-blue-50/50" 
                        placeholder="0">
                </div>
            </div>

            <button onclick="confirmPayment()" id="btnConfirmPay" class="w-1/2 mx-auto block bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-xl text-base shadow-lg transition transform active:scale-95">
                ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
            </button>
        </div>
    </div>
</div>
    
    <div id="editMenuModal" class="fixed inset-0 bg-black/60 hidden z-[200] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-pop"><div class="bg-yellow-500 p-4 flex justify-between items-center text-white"><h3 class="font-bold text-lg text-black">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3><button onclick="closeModal('editMenuModal')" class="bg-black/10 rounded-full w-8 h-8 text-black"><i class="fas fa-times"></i></button></div><form id="editMenuForm" class="p-6 space-y-4"><input type="hidden" id="eId"><div><label class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" id="eName" required class="input-box"></div><div class="flex gap-4"><div class="flex-1"><label class="label">‡∏£‡∏≤‡∏Ñ‡∏≤</label><input type="number" id="ePrice" required class="input-box"></div><div class="flex-1"><label class="label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><select id="eCategory" class="input-box"></select></div></div><div class="flex gap-3 pt-2"><button type="button" onclick="deleteMenu()" id="btnDeleteMenu" class="flex-1 bg-red-50 text-red-600 font-bold py-3 rounded-xl border border-red-200">‡∏•‡∏ö</button><button type="submit" id="btnEditSave" class="flex-[2] bg-yellow-500 text-black font-bold py-3 rounded-xl shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></form></div></div>
    
    <div id="addModal" class="fixed inset-0 bg-black/60 hidden z-[1000] flex items-center justify-center p-4 backdrop-blur-sm">
         <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-pop">
            <div class="bg-green-600 p-4 flex justify-between items-center text-white"><h3 class="font-bold text-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3><button onclick="closeModal('addModal')" class="bg-white/20 rounded-full w-8 h-8"><i class="fas fa-times"></i></button></div>
            <form id="addMenuForm" class="p-6 space-y-4">
                <div class="mb-4 bg-gray-50 p-3 rounded-xl border border-dashed border-gray-300">
                    <label class="label text-gray-600 font-bold flex items-center gap-2 mb-2"><i class="fas fa-barcode text-gray-400"></i> ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / Barcode <span class="text-[10px] font-normal text-gray-400 bg-white px-2 py-0.5 rounded-full border border-gray-200">‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</span></label>
                    <div class="relative"><input type="text" id="mCode" class="input-box pl-10 font-mono text-blue-600 font-bold tracking-wider placeholder-gray-300 focus:bg-white transition-colors" placeholder="‡∏™‡πÅ‡∏Å‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-tag text-gray-300"></i></div></div>
                    <p class="text-[10px] text-gray-400 mt-1.5 ml-1"><i class="fas fa-info-circle"></i> ‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏∏ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô ID ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                </div>
                <div><label class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" id="mName" required class="input-box"></div>
                <div class="flex gap-4"><div class="flex-1"><label class="label">‡∏£‡∏≤‡∏Ñ‡∏≤</label><input type="number" id="mPrice" required class="input-box"></div><div class="flex-1"><label class="label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><select id="mCategory" class="input-box"></select></div></div>
                <div><label class="label">‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="file" id="mFile" accept="image/*" class="w-full text-sm"></div>
                <button type="submit" id="btnSaveMenu" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow mt-2 flex justify-center items-center gap-2"><span class="btn-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span> <i class="fas fa-save"></i></button>
            </form>
        </div>
    </div>
    
    <div id="salesModal" class="fixed inset-0 bg-black/60 hidden z-[200] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-pop"><div class="bg-blue-600 p-4 text-white flex justify-between items-center"><h3 class="font-bold">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h3><button onclick="closeModal('salesModal')"><i class="fas fa-times"></i></button></div><div class="p-6 space-y-4"><div class="bg-blue-50 p-4 rounded-xl text-center border border-blue-100"><p class="text-gray-500 text-xs uppercase font-bold">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p><h2 class="text-4xl font-bold text-blue-600 mt-1" id="saleToday">...</h2></div><div class="grid grid-cols-2 gap-4"><div class="bg-gray-50 p-3 rounded-xl text-center"><p class="text-xs text-gray-400">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô</p><h3 class="font-bold text-gray-700" id="saleYest">...</h3></div><div class="bg-gray-50 p-3 rounded-xl text-center"><p class="text-xs text-gray-400">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p><h3 class="font-bold text-gray-700" id="saleMonth">...</h3></div></div></div></div></div>
    <div id="historyModal" class="fixed inset-0 bg-black/60 hidden z-[200] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl h-[80vh] flex flex-col animate-pop"><div class="bg-gray-800 p-4 text-white flex justify-between items-center"><h3 class="font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 400 ‡∏ö‡∏¥‡∏•)</h3><button onclick="closeModal('historyModal')"><i class="fas fa-times"></i></button></div><div class="flex-1 overflow-y-auto p-4"><table class="w-full text-left border-collapse">
                <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="p-3 w-20">‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <th class="p-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                        <th class="p-3 text-right w-24">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                    </tr>
                </thead>
                <tbody id="historyList" class="text-sm divide-y divide-gray-100">
                    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </tbody>
            </table></table></div></div></div>
    <div id="billDetailModal" class="fixed inset-0 bg-black/80 hidden z-[200] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg lg:max-w-xl overflow-hidden animate-pop relative max-h-[90vh] h-full flex flex-col"> 
            <div id="billDetailContent" class="flex flex-col flex-1 h-full"> 
                </div>
        </div>
    </div>

    <div id="floatingNumpad" class="hidden fixed top-[40%] right-10 z-[300] bg-white/80 backdrop-blur-md border border-white/40 shadow-2xl rounded-2xl overflow-hidden flex flex-col w-64 transition-opacity duration-300 resize hover:resize" style="min-width: 220px; max-width: 400px;">
    
    <div id="numpadHeader" class="bg-gradient-to-r from-gray-800 to-gray-900 text-white p-2 cursor-move flex justify-between items-center shrink-0 select-none">
        <div class="flex items-center gap-2">
            <i class="fas fa-calculator text-xs text-blue-400"></i>
            <span class="text-xs font-bold tracking-wide">‡πÅ‡∏õ‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</span>
        </div>
        <button onclick="toggleFloatingNumpad()" 
                onmousedown="event.stopPropagation()" 
                ontouchstart="event.stopPropagation()" 
                class="text-gray-400 hover:text-white transition p-2"> <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="p-2 grid grid-cols-3 gap-2 flex-1 overflow-auto bg-white/50">
        <button onclick="numpadPress('7', this)" class="h-12 bg-white shadow-sm rounded-xl font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:shadow-md transition active:scale-95">7</button>
        <button onclick="numpadPress('8', this)" class="h-12 bg-white shadow-sm rounded-xl font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:shadow-md transition active:scale-95">8</button>
        <button onclick="numpadPress('9', this)" class="h-12 bg-white shadow-sm rounded-xl font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:shadow-md transition active:scale-95">9</button>
        
        <button onclick="numpadPress('4', this)" class="h-12 bg-white shadow-sm rounded-xl font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:shadow-md transition active:scale-95">4</button>
        <button onclick="numpadPress('5', this)" class="h-12 bg-white shadow-sm rounded-xl font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:shadow-md transition active:scale-95">5</button>
        <button onclick="numpadPress('6', this)" class="h-12 bg-white shadow-sm rounded-xl font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:shadow-md transition active:scale-95">6</button>
        
        <button onclick="numpadPress('1', this)" class="h-12 bg-white shadow-sm rounded-xl font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:shadow-md transition active:scale-95">1</button>
        <button onclick="numpadPress('2', this)" class="h-12 bg-white shadow-sm rounded-xl font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:shadow-md transition active:scale-95">2</button>
        <button onclick="numpadPress('3', this)" class="h-12 bg-white shadow-sm rounded-xl font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:shadow-md transition active:scale-95">3</button>
        
        <button onclick="numpadAction('del')" class="h-12 bg-red-100 shadow-sm rounded-xl font-bold text-lg text-red-600 hover:bg-red-200 hover:shadow-md transition active:scale-95"><i class="fas fa-backspace"></i></button>
        
        <button onclick="numpadPress('0', this)" class="h-12 bg-white shadow-sm rounded-xl font-bold text-xl text-gray-700 hover:bg-blue-50 hover:text-blue-600 hover:shadow-md transition active:scale-95">0</button>
        
        <button onclick="numpadAction('enter')" class="h-12 bg-green-500 shadow-lg shadow-green-200 rounded-xl font-bold text-lg text-white hover:bg-green-600 transition active:scale-95">Enter</button>
    </div>

    <div class="p-2 pt-0">
        <button onclick="handleCheckoutClick()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition active:scale-95 flex items-center justify-center gap-2">
            <i class="fas fa-cash-register"></i> ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô
        </button>
    </div>
    
    <div class="absolute bottom-0 right-0 w-3 h-3 cursor-nwse-resize bg-gray-300 rounded-tl opacity-50"></div>
</div>

<div id="exportModal" class="fixed inset-0 bg-black/60 hidden z-[200] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop">
            <div class="bg-red-600 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-file-pdf mr-2"></i>‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF</h3>
                <button onclick="closeModal('exportModal')" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                    <select id="exportType" class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-red-500 outline-none font-bold text-gray-700">
                        <option value="DailySales">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (DailySales)</option>
                        <option value="Bill">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Bill)</option>
                        <option value="MonthlySales">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Monthly Report)</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-600 text-xs font-bold mb-1">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="exportStartDate" class="w-full border-2 border-gray-200 rounded-xl p-2 outline-none focus:border-red-500 text-sm">
                    </div>
                    <div>
                        <label class="block text-gray-600 text-xs font-bold mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="exportEndDate" class="w-full border-2 border-gray-200 rounded-xl p-2 outline-none focus:border-red-500 text-sm">
                    </div>
                </div>

                <button onclick="executeExportPDF()" id="btnDoExport" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl shadow-lg mt-2 flex justify-center items-center gap-2 transition transform active:scale-95">
                    <span class="btn-text">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</span> <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
    </div>

    <style>.label{display:block;font-size:.75rem;font-weight:700;color:#6b7280;text-transform:uppercase;margin-bottom:.25rem}.input-box{width:100%;border:2px solid #e5e7eb;border-radius:.75rem;padding:.75rem;outline:none;transition:border-color .2s}.input-box:focus{border-color:#3b82f6}</style>

    <script>
        // ‡πÉ‡∏™‡πà URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Web App Deployment ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        const API_URL = "https://script.google.com/macros/s/AKfycbzClWrrmVDTe20bma_TOd1kRDW9rsQAFRp_jOovxcQG3CO5e47PJ5tjWVZHjEovQkYQsQ/exec"; 
        
        // -------------------------------------------------------------
        // üî¥üî¥ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß üî¥üî¥
        // -------------------------------------------------------------
        // ID ‡πÄ‡∏î‡∏¥‡∏°‡∏ú‡∏¥‡∏î ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô: 1jx5XVDpGo5MAkykNbJ08eJgW5zTVVXmV
        const QR_FOLDER_ID = "1jx5XVDpGo5MAkykNbJ08eJgW5zTVVXmV"; 
        // -------------------------------------------------------------
        
        const mockMenuData = [
            { id: "M001", name: "‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå‡∏™‡∏¥‡∏á‡∏´‡πå", price: 65, category: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", image: "" },
            { id: "M002", name: "‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå‡∏•‡∏µ‡πÇ‡∏≠", price: 60, category: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", image: "" },
            { id: "M003", name: "‡πÄ‡∏•‡∏¢‡πå (‡∏´‡πà‡∏≠‡πÉ‡∏´‡∏ç‡πà)", price: 30, category: "‡∏Ç‡∏ô‡∏°/‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á", image: "" },
            { id: "M004", name: "‡∏Ñ‡∏≤‡∏£‡∏≤‡∏ö‡∏≤‡∏ß‡πÅ‡∏î‡∏á", price: 10, category: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", image: "" },
            { id: "M005", name: "‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤‡∏ó‡∏¥‡∏û‡∏£‡∏™", price: 35, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á", image: "" },
            { id: "M006", name: "‡πÑ‡∏Ç‡πà‡πÑ‡∏Å‡πà (‡πÄ‡∏ö‡∏≠‡∏£‡πå 2)", price: 4, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î", image: "" },
            { id: "M007", name: "‡∏ú‡∏á‡∏ã‡∏±‡∏Å‡∏ü‡∏≠‡∏Å‡∏ö‡∏£‡∏µ‡∏™", price: 20, category: "‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô", image: "" }
        ];

        let menuData = [];
        let masterData = [];
        let cart = [];
        let currentOrders = [];
        let currentPayOrder = null;
        let historyBills = [];
        let lastOrderCount = -1; 
        
        
        const categories = ['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°', '‡∏Ç‡∏ô‡∏°/‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', '‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î', '‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î'];
        
        let isCustomerMode = false;
        let customerTable = "";
        let isQuickPayMode = false; 
        let notifiedOrders = new Set();
        let isStoreOpen = true; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô
        let myLastOrders = [];  // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á

        function speak(text) { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); utterance.lang = 'th-TH'; utterance.rate = 1.0; window.speechSynthesis.speak(utterance); } }
        function playNotificationSound() { const beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"); beep.play().catch(e=>console.log("Audio blocked", e)); }
        
        function holdBill() {
            if(cart.length === 0) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•', 'warning'); return; }
            let heldBills = JSON.parse(localStorage.getItem('heldBills') || "[]");
            const newBill = { id: Date.now(), timestamp: new Date().toISOString(), items: cart, total: cart.reduce((sum, i) => sum + (i.price * i.qty), 0) };
            heldBills.push(newBill);
            localStorage.setItem('heldBills', JSON.stringify(heldBills));
            cart = []; renderCart();
            showToast('‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (' + heldBills.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)', 'success');
            speak("‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
        }

        function openRecallModal() {
            const heldBills = JSON.parse(localStorage.getItem('heldBills') || "[]");
            if (heldBills.length === 0) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ', 'warning'); return; }
            const listContainer = document.getElementById('heldBillsList');
            listContainer.innerHTML = heldBills.map((bill, index) => {
                const timeStr = new Date(bill.timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                return `<div class="bg-white border border-gray-200 rounded-xl p-3 shadow-sm hover:shadow-md transition flex justify-between items-center animate-fade-in"><div class="flex-1 cursor-pointer" onclick="recallBill(${index})"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded">${timeStr}</span><span class="font-bold text-gray-700">${bill.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></div><div class="text-sm text-gray-500 mt-1">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° <span class="text-blue-600 font-bold">${bill.total.toLocaleString()} ‡∏ø</span></div></div><button onclick="deleteHeldBill(${index})" class="w-8 h-8 rounded-full bg-red-50 text-red-500 hover:bg-red-100 flex items-center justify-center ml-2"><i class="fas fa-trash-alt text-xs"></i></button></div>`;
            }).join('');
            document.getElementById('recallModal').classList.remove('hidden');
        }

        function recallBill(index) {
            let heldBills = JSON.parse(localStorage.getItem('heldBills') || "[]");
            if (cart.length > 0) { if(!confirm("‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏´‡∏°?")) return; }
            cart = heldBills[index].items;
            heldBills.splice(index, 1); localStorage.setItem('heldBills', JSON.stringify(heldBills));
            closeModal('recallModal'); renderCart(); showToast('‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ö‡∏¥‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success'); speak("‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
        }

        function deleteHeldBill(index) {
            if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) return;
            let heldBills = JSON.parse(localStorage.getItem('heldBills') || "[]");
            heldBills.splice(index, 1); localStorage.setItem('heldBills', JSON.stringify(heldBills));
            if (heldBills.length === 0) { closeModal('recallModal'); showToast('‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success'); } else { openRecallModal(); }
        }

        function renderCategoryBar() {
            const bar = document.getElementById('categoryBar');
            bar.innerHTML = `<button onclick="filterMenu('All')" class="cat-btn bg-blue-600 text-white px-5 py-2 rounded-full shadow-md text-sm font-bold transition transform hover:scale-105 border border-blue-700 shrink-0">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>` + categories.map(c => `<button onclick="filterMenu('${c}')" class="cat-btn bg-white text-gray-600 hover:bg-blue-50 hover:text-blue-600 px-5 py-2 rounded-full shadow-sm text-sm font-medium transition border border-gray-200 shrink-0">${c}</button>`).join('');
        }

        function populateCategorySelects() {
            const opts = categories.map(c => `<option>${c}</option>`).join('');
            const mCat = document.getElementById('mCategory'); const eCat = document.getElementById('eCategory');
            if(mCat) mCat.innerHTML = opts; if(eCat) eCat.innerHTML = opts;
        }

        function initDateTime() {
            const updateTime = () => { const now = new Date(); document.getElementById('dateTimeDisplay').innerText = `${now.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' })} ${now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}`; };
            updateTime(); setInterval(updateTime, 1000);
        }

        function getDriveUrl(input) {
            if (!input) return '';
            let id = input;
            if (input.includes('drive.google.com/thumbnail')) return input;
            if (input.includes('http') || input.includes('google.com')) { const match = input.match(/[-\w]{25,}/); if (match) id = match[0]; }
            return `https://drive.google.com/thumbnail?id=${id}&sz=w800`;
        }

        function initBankQR() {
            const savedQR = localStorage.getItem('bankQRID');
            const promptPayID = localStorage.getItem('promptPayID');
            const amount = currentPayOrder ? currentPayOrder.totalPrice : 0;
            const imgEl = document.getElementById('bankQRImage');
            const labelEl = document.getElementById('ppLabel'); 

            if (!imgEl) return; 

            // üî¥ 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö PromptPay ID ‡∏Å‡πà‡∏≠‡∏ô (‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤)
            if (promptPayID) {
                const payload = generatePayload(promptPayID, amount);
                imgEl.src = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${payload}`;
                if (labelEl) labelEl.innerText = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå: ${promptPayID}`; 
                
            // üü¢ 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ PromptPay ID ‡πÅ‡∏ï‡πà‡∏°‡∏µ Bank QR ID
            } else if (savedQR) {
                const url = getDriveUrl(savedQR);
                imgEl.src = url + "&t=" + new Date().getTime();
                if (labelEl) labelEl.innerText = "‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô (‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)";
                
            // 3. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á
            } else {
                imgEl.src = "https://placehold.co/400x400?text=Set+PromptPay";
                if (labelEl) labelEl.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå";
            }
        }
        
        function handleQRClick() {
            const hasPP = localStorage.getItem('promptPayID');
            const hasBankQR = localStorage.getItem('bankQRID');
            if (hasPP) { openPromptPayModal(); } else if (hasBankQR) { openManageQRModal(true); } else { openManageQRModal(false); }
        }

        function openPromptPayModal() {
            const current = localStorage.getItem('promptPayID') || '';
            document.getElementById('ppInput').value = current;
            document.getElementById('promptPayModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('ppInput').focus(), 300);
        }

        function savePromptPayID() {
            const newID = document.getElementById('ppInput').value;
            if (newID) {
                // ... ‡πÇ‡∏Ñ‡πâ‡∏î validation ‡πÄ‡∏î‡∏¥‡∏° ...
                localStorage.setItem('promptPayID', cleanID); 
                localStorage.removeItem('bankQRID'); // üî¥ ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡πÉ‡∏´‡πâ ID ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏≤‡∏¢
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PromptPay ‡πÅ‡∏•‡πâ‡∏ß', 'success'); initBankQR(); closeModal('promptPayModal');
            } else { clearPromptPayID(); }
        }

        function savePromptPayID() {
            const newID = document.getElementById('ppInput').value;
            if (newID) {
                const cleanID = newID.trim().replace(/[^0-9]/g, '');
                if (cleanID.length === 10 || cleanID.length === 13) {
                    localStorage.setItem('promptPayID', cleanID); 
                    
                    // ‚úÖ ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏•‡∏ö bankQRID ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ ID ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà
                    // localStorage.removeItem('bankQRID'); // ‚ùå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                    
                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PromptPay ‡πÅ‡∏•‡πâ‡∏ß', 'success'); 
                    initBankQR(); 
                    closeModal('promptPayModal');
                } else { alert("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 10 ‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ 13 ‡∏´‡∏•‡∏±‡∏Å"); }
            } else { clearPromptPayID(); }
        }

        function clearPromptPayID() {
            localStorage.removeItem('promptPayID'); document.getElementById('ppInput').value = '';
            showToast('‡∏•‡∏ö PromptPay ‡πÅ‡∏•‡πâ‡∏ß', 'success'); initBankQR(); closeModal('promptPayModal');
        }

        function checkAndUseOriginalQR() {
            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ ID ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (ID ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á PromptPay)
            const savedQR = localStorage.getItem('bankQRID');
            
            if (savedQR) {
                // 2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏° -> ‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö PromptPay ID ‡∏ó‡∏¥‡πâ‡∏á
                localStorage.removeItem('promptPayID');
                
                // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ Bank QR ID ‡πÅ‡∏ó‡∏ô PromptPay ID ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                initBankQR();
                
                showToast('‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ QR Code ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                
                const imgEl = document.getElementById('bankQRImage');
                if(imgEl) {
                    imgEl.classList.add('opacity-50');
                    setTimeout(() => imgEl.classList.remove('opacity-50'), 300);
                }
            } else {
                // 4. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Local Storage ‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ QR Code ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô)', 'warning');
                speak("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡πà‡∏∞");
            }
        }

        function openManageQRModal(hasFile) {
            const modal = document.getElementById('manageQRModal');
            const statusText = document.getElementById('mqrStatusText');
            const statusIcon = document.getElementById('mqrStatusIcon');
            const btnDelete = document.getElementById('btnDeleteQR');
            if (hasFile) {
                statusText.innerText = "‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"; statusText.classList.replace('text-gray-500', 'text-green-600');
                statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>'; btnDelete.classList.remove('hidden');
            } else {
                statusText.innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå"; statusText.classList.replace('text-green-600', 'text-gray-500');
                statusIcon.innerHTML = '<i class="fas fa-image"></i>'; btnDelete.classList.add('hidden');
            }
            modal.classList.remove('hidden');
        }

        function deleteServerQR() {
            if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
            setLoading('btnDeleteQR', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...');
            const currentFileId = localStorage.getItem('bankQRID');
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "deleteQR", folderId: QR_FOLDER_ID, fileId: currentFileId }) })
            .then(res => res.json()).then(data => {
                if(data.result === 'success') {
                    localStorage.removeItem('bankQRID'); initBankQR(); openManageQRModal(false); showToast('‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                } else { alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + data.error); }
            }).catch(err => { alert('Error: ' + err); }).finally(() => { setLoading('btnDeleteQR', false, '‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°'); });
        }

        function crc16(data) {
            let crc = 0xFFFF;
            for (let i = 0; i < data.length; i++) {
                let x = ((crc >> 8) ^ data.charCodeAt(i)) & 0xFF; x ^= x >> 4; crc = ((crc << 8) ^ (x << 12) ^ (x << 5) ^ x) & 0xFFFF;
            }
            return ('0000' + crc.toString(16).toUpperCase()).slice(-4);
        }

        function generatePayload(mobileNumber, amount) {
            const target = mobileNumber.replace(/[^0-9]/g, '');
            let targetFormatted = target;
            if (target.length === 10 && target.startsWith('0')) { targetFormatted = '66' + target.substring(1); }
            const merchantIdTag = (targetFormatted.length >= 13) ? '02' : '01'; 
            const merchantInfoValue = '0016A000000677010111' + merchantIdTag + ('00'+targetFormatted.length).slice(-2) + targetFormatted;
            const merchantInfo = '29' + ('00'+merchantInfoValue.length).slice(-2) + merchantInfoValue;
            const country = '5802TH'; const currency = '5303764'; 
            let amountTag = '';
            if (amount > 0) { const amtStr = parseFloat(amount).toFixed(2); amountTag = '54' + ('00'+amtStr.length).slice(-2) + amtStr; }
            const version = '000201'; const type = amount > 0 ? '010212' : '010211'; 
            const rawData = version + type + merchantInfo + country + currency + amountTag + '6304';
            return rawData + crc16(rawData);
        }

        window.onload = () => {
            checkMode(); initStoreStatus(); fetchMenu(); renderCategoryBar(); populateCategorySelects(); startOrderPolling(); initGlobalShortcuts(); initQuickAddShortcuts(); initDateTime();
        };

        function initGlobalShortcuts() {
            document.addEventListener('keydown', function(event) {
                
                // üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô -> ‡πÉ‡∏´‡πâ Global ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                // ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÜ (handleSearchKeydown) ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏á
                if (event.target.id === 'searchInput' || event.target.id === 'inputReceived') {
                    return; 
                }

                const key = event.key;
                const code = event.code;

                // -----------------------------------------------------------
                // üî¥ 1. ‡∏õ‡∏∏‡πà‡∏° + (Add)
                // -----------------------------------------------------------
                if (key === '+' || code === 'NumpadAdd' || key === 'Add' ||  event.keyCode === 107) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    const paymentModal = document.getElementById('paymentModal');
                    if (!paymentModal.classList.contains('hidden')) {
                        closeModal('paymentModal');
                    } else {
                        handleCheckoutClick();
                    }
                    return false;
                }
                
                // -----------------------------------------------------------
                // üî¥ 2. ‡∏õ‡∏∏‡πà‡∏° . (Decimal)
                // -----------------------------------------------------------
                if (key === '.' || code === 'NumpadDecimal' || key === 'Decimal' || key === 'Separator' || code === 'Period' || event.keyCode === 110 || event.keyCode === 190) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    const paymentModal = document.getElementById('paymentModal');
                    if (!paymentModal.classList.contains('hidden')) {
                        closeModal('paymentModal');
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                        const searchInput = document.getElementById('searchInput');
                        if(searchInput) {
                            searchInput.focus(); 
                            searchInput.value = ''; 
                        }
                    }
                    return false;
                }

            }, true);
        }

        function initQuickAddShortcuts() {
             const mPrice = document.getElementById('mPrice');
             mPrice.addEventListener('keydown', function(event) {
                 if (event.key === 'Enter') {
                     event.preventDefault();
                     const mName = document.getElementById('mName');
                     const mCode = document.getElementById('mCode');
                     if(mName.value.trim() === "") { mName.value = "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ " + (mCode.value || "‡πÉ‡∏´‡∏°‡πà"); }
                     const priceVal = mPrice.value; const codeVal = mCode.value;
                     if(priceVal && codeVal) {
                         setLoading('btnSaveMenu', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'); 
                         const payload = { action: "addMenu", id: codeVal, name: mName.value, price: priceVal, category: document.getElementById('mCategory').value, spicy: "-", image: "", mimeType: "", fileName: "" };
                         sendAddMenu(payload);
                     } else { document.getElementById('btnSaveMenu').click(); }
                 }
             });
        }

        function startOrderPolling() { updateKitchenBadge().finally(() => { setTimeout(startOrderPolling, 3000); }); }

        function checkMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode'); const table = urlParams.get('table');
            if (mode === 'customer') {
                isCustomerMode = true; customerTable = table || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
                document.getElementById('adminToolbar').classList.add('hidden');
                document.getElementById('customerToolbar').classList.remove('hidden');
                document.getElementById('customerTableDisplay').innerText = customerTable;
                const tableInput = document.getElementById('tableNo');
                if(tableInput) { tableInput.value = customerTable; tableInput.readOnly = true; tableInput.classList.add('bg-gray-100', 'cursor-not-allowed'); }
            }
        }

        function openQRModal() { 
            document.getElementById('qrModal').classList.remove('hidden');
            const baseUrl = window.location.href.split('?')[0];
            const randomId = Math.floor(Math.random() * 10000); 
            const fullUrl = `${baseUrl}?mode=customer&table=${randomId}`;
            const qrApi = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(fullUrl)}`;
            document.getElementById('qrImage').src = qrApi; document.getElementById('qrLink').href = fullUrl; document.getElementById('qrLink').innerText = fullUrl;
        }

        function fetchMenu() {
            document.getElementById('loadingMenu').classList.remove('hidden');
            document.getElementById('noResults').classList.add('hidden');
            
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getMenu" }) }) // ‡∏î‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤ Menu
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    menuData = data.data; 
                    filterMenu('All'); // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                    
                    // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ---
                    fetchMasterList(); 
                } 
            })
            // ... (code error handling ‡πÄ‡∏î‡∏¥‡∏°) ...
            .finally(() => document.getElementById('loadingMenu').classList.add('hidden'));
        }

        function fetchMasterList() {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô masterData (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á)
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getMasterList" }) })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    masterData = data.data;
                    console.log("‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: " + masterData.length + " ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
                }
            })
            .catch(err => console.error("‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err));
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Enter (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î)
function processSearchEnter() {
    const searchInput = document.getElementById('searchInput');
    const val = searchInput.value;
    const trimVal = val.trim();

    if(trimVal) { 
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 1-4 ‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÄ‡∏ä‡πà‡∏ô 20, 50, 100)
        // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πà -> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏£‡∏≤‡∏Ñ‡∏≤)
        if (/^[0-9]{1,4}$/.test(trimVal)) { 
            addManualItem(parseInt(trimVal)); 
        } else { 
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£, ‡∏°‡∏µ‡∏à‡∏∏‡∏î, ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å) -> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î
            scanBarcode(trimVal); 
        } 
    } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter -> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏ö‡∏ô‡∏™‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (cart.length > 0) { updateQty(0, 1); } 
    }
}
        function handleSearchKeydown(event) {
    const searchInput = document.getElementById('searchInput');
    const paymentModal = document.getElementById('paymentModal');

    // 1. ‡∏õ‡∏∏‡πà‡∏° + (Add)
    if (event.key === '+' || event.code === 'NumpadAdd' || event.key === 'Add' || event.keyCode === 107) {
        event.preventDefault(); 
        if (paymentModal && !paymentModal.classList.contains('hidden')) {
            closeModal('paymentModal');
            setTimeout(() => searchInput.focus(), 100); 
        } else {
            searchInput.blur(); 
            handleCheckoutClick();
        }
        return;
    }

    // 2. ‡∏õ‡∏∏‡πà‡∏° . (Decimal)
    if (event.key === '.' || event.code === 'NumpadDecimal' || event.keyCode === 110 || event.keyCode === 190) {
        event.preventDefault(); 
        if (paymentModal && !paymentModal.classList.contains('hidden')) {
            closeModal('paymentModal');
            setTimeout(() => searchInput.focus(), 100);
        } else {
            searchInput.value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
        }
        return;
    }

    // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Enter (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á)
    if (event.key === 'Enter') {
        event.preventDefault(); 
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ (processSearchEnter)
        processSearchEnter(); 
    }
    
    // 4. Backspace (‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)
    if (searchInput.value === '' && event.key === 'Backspace') { 
        if (cart.length > 0 && cart[0].qty > 1) { updateQty(0, -1); } 
        return; 
    }
}
        
        function checkPaymentEnter(e) { 
            // ------------------------------------------------------------------
            // üî¥ 1. ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏° + (Add)
            // ------------------------------------------------------------------
            if (e.key === '+' || e.code === 'NumpadAdd' || e.key === 'Add') {
                e.preventDefault();
                return;
            }

            // ------------------------------------------------------------------
            // üî¥ 2. ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏° . (Decimal)
            // ------------------------------------------------------------------
            if (e.key === '.' || e.code === 'NumpadDecimal' || e.key === 'Decimal') {
                e.preventDefault();
                return;
            }

            // ------------------------------------------------------------------
            // üî¥ 3. ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç 0 (Zero) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î
            // ------------------------------------------------------------------
            if (e.key === '0' || e.code === 'Numpad0') {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå 0)
                if (e.target.value === '') {
                    e.preventDefault();
                    return;
                }
            }

            // ------------------------------------------------------------------
            // ‚úÖ Logic ‡πÄ‡∏î‡∏¥‡∏°: ‡∏Å‡∏≤‡∏£‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
            // ------------------------------------------------------------------
            if(e.key === 'Enter') { 
                e.preventDefault(); 
                
                const inputVal = Number(document.getElementById('inputReceived').value);
                
                // ‡∏ñ‡πâ‡∏≤‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ -> ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ‡πÄ‡∏õ‡πä‡∏∞ ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡πÄ‡∏•‡∏¢
                if (inputVal === 0) {
                    setExactMoney();  
                    confirmPayment(); 
                    return;
                }

                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß)
                if(!document.getElementById('btnConfirmPay').disabled) { 
                    confirmPayment(); 
                } else { 
                    playNotificationSound(); // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
                } 
            } 
        }

        function addManualItem(price) {
            const manualItem = { id: "MANUAL-" + Date.now(), name: "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", price: price, category: "‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î", image: "", isHidden: true };
            addItemToCart(manualItem, "-"); document.getElementById('searchInput').value = ''; showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${price} ‡∏ö‡∏≤‡∏ó ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        }

        function scanBarcode(code) {
            // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏õ‡πá‡∏ô String ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
            const cleanCode = String(code).trim();
            const lowerCode = cleanCode.toLowerCase();

            // 1. ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å ID (‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î) ‡πÉ‡∏ô masterData ‡∏Å‡πà‡∏≠‡∏ô (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏Å‡∏ß‡πà‡∏≤)
            let item = masterData.find(m => String(m.id).trim() === cleanCode);
            
            // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô master ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡πÉ‡∏ô menuData (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤ master)
            if (!item) {
                item = menuData.find(m => String(m.id).trim() === cleanCode);
            }

            // 3. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ID ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" (‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡πä‡∏∞‡πÜ)
            if (!item) {
                item = masterData.find(m => m.name.toLowerCase() === lowerCode) || 
                       menuData.find(m => m.name.toLowerCase() === lowerCode);
            }

            // --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ---
            if(item) {
                // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏à‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏•‡∏¢
                addItemToCart(item, "-"); 
                document.getElementById('searchInput').value = ''; 
                showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${item.name} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
            } else {
                // ‚ùå ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÜ: ‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                speak("‡πÑ‡∏°‡πà‡∏°‡∏µ");
                playNotificationSound(); 
                openQuickAddModal(cleanCode);
            }
        }
        
        function openQuickAddModal(barcode) {
             openAddMenuModal(); document.getElementById('mCode').value = barcode; document.getElementById('mName').value = ""; document.getElementById('mPrice').value = ""; setTimeout(() => { document.getElementById('mPrice').focus(); }, 300);
        }

        function searchMenu() { filterMenu('All'); }
        function clearSearch() { document.getElementById('searchInput').value = ''; searchMenu(); }

        function getCategoryEmoji(category) {
            const map = { '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°': 'ü•§', '‡∏Ç‡∏ô‡∏°/‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á': 'üç™', '‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô': 'üè†', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á': 'üßÇ', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î': 'ü•©', '‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î': 'üõçÔ∏è' };
            return map[category] || 'üì¶';
        }

        function filterMenu(category) {
            // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            let rawInput = document.getElementById('searchInput').value.toLowerCase().trim();
            
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏Å‡∏ö‡∏≤‡∏ó (Clear)
            const clearBtn = document.getElementById('clearSearchBtn');
            if(rawInput) clearBtn.classList.remove('hidden'); else clearBtn.classList.add('hidden');

            // --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ (1-9999) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ---
            let searchText = rawInput;
            const isPrice = /^[0-9]{1,4}$/.test(rawInput) && parseInt(rawInput) > 0;
            
            if (isPrice) { searchText = ""; } 

            // --- 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏ß‡∏° 2 ‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤) ---
            let dataSource = [];
            
            if (searchText !== "") {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Map ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏ï‡∏±‡∏ß‡∏ã‡πâ‡∏≥ (‡πÉ‡∏ä‡πâ ID ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå)
                const combined = new Map();
                
                // 1. ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Master) ‡∏•‡∏á‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
                if (masterData.length > 0) {
                    masterData.forEach(m => { if(m.id) combined.set(String(m.id), m); });
                }
                
                // 2. ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Menu (‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å) ‡∏ó‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô Menu ‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢)
                menuData.forEach(m => { if(m.id) combined.set(String(m.id), m); });
                
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                dataSource = Array.from(combined.values());
                
                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ menuData ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                if (dataSource.length === 0) dataSource = menuData;
                
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤ Menu ‡∏õ‡∏Å‡∏ï‡∏¥
                dataSource = menuData;
            }

            // --- 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ---
            if (category !== 'All' || searchText === '') {
                document.querySelectorAll('.cat-btn').forEach(btn => {
                    const isActive = (btn.innerText === category) || (category === 'All' && btn.innerText === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' && searchText === '');
                    btn.className = isActive ? "cat-btn bg-blue-600 text-white px-6 py-2 rounded-full shadow-lg shadow-blue-200 text-sm font-bold transition transform scale-105 border border-blue-500 shrink-0" : "cat-btn bg-white text-gray-500 hover:bg-gray-50 hover:text-blue-600 px-6 py-2 rounded-full shadow-sm text-sm font-medium transition border border-gray-100 shrink-0";
                });
            }

            // --- 3. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
            let filtered = dataSource;
            if (!searchText) { filtered = filtered.filter(m => !m.isHidden); }
            if (category !== 'All') { filtered = filtered.filter(m => m.category === category); }
            
            if (searchText) {
                 filtered = filtered.filter(m => 
                    m.name.toLowerCase().includes(searchText) || 
                    (m.id && String(m.id).toLowerCase().includes(searchText))
                 );
                 if(category === 'All') { document.querySelectorAll('.cat-btn').forEach(btn => btn.className = "cat-btn bg-white text-gray-600 hover:bg-blue-50 hover:text-blue-600 px-5 py-2 rounded-full shadow-sm text-sm font-medium transition border border-gray-200 shrink-0"); }
            } else if (category === 'All') { 
                filtered.sort((a, b) => categories.indexOf(a.category) - categories.indexOf(b.category)); 
            }

            // --- 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Grid) ---
            const grid = document.getElementById('menuGrid'); 
            const noResults = document.getElementById('noResults');
            
            if (filtered.length === 0) {
                grid.classList.add('hidden'); noResults.classList.remove('hidden');
            } else {
                grid.classList.remove('hidden'); noResults.classList.add('hidden');
                
                grid.innerHTML = filtered.map((item) => {
                    const editBtnHtml = isCustomerMode ? '' : `<button onclick="handleEditClick('${item.id}', event)" class="absolute top-2 right-2 bg-white/80 hover:bg-white text-gray-400 hover:text-orange-500 w-8 h-8 rounded-full shadow-sm backdrop-blur-sm z-10 flex items-center justify-center transition-all duration-200"><i class="fas fa-pencil-alt text-xs"></i></button>`;
                    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ---
                    const imageUrl = getDriveUrl(item.image);
                    const hasImage = imageUrl && imageUrl.length > 10;
                    let imageHtml;

                    if (hasImage) {
                        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏£‡∏π‡∏õ
                        imageHtml = `<img src="${imageUrl}" class="w-full h-full object-contain p-2 transition duration-500 group-hover:scale-110" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                                    <div class="hidden w-full h-full bg-gray-50 flex flex-col items-center justify-center select-none text-blue-200">
                                        <i class="fas fa-box-open text-4xl mb-2 opacity-50"></i>
                                        <div class="text-4xl">${getCategoryEmoji(item.category)}</div>
                                    </div>`;
                    } else {
                        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç HTML ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡∏´‡∏•‡∏∏‡∏î‡∏Å‡∏£‡∏≠‡∏ö)
                        const emoji = getCategoryEmoji(item.category);
                        imageHtml = `<div class="w-full h-full bg-gray-50 flex flex-col items-center justify-center select-none text-blue-200 group-hover:bg-blue-50 transition-colors">
                                        <i class="fas fa-box-open text-3xl sm:text-4xl mb-2 opacity-30 group-hover:opacity-50 transition-opacity"></i>
                                        <div class="text-3xl sm:text-4xl filter drop-shadow-sm group-hover:scale-110 transition-transform duration-300">${emoji}</div>
                                    </div>`;
                    }

                    return `
                    <div class="bg-white rounded-3xl shadow-[0_2px_10px_rgba(0,0,0,0.03)] hover:shadow-[0_10px_25px_rgba(0,0,0,0.08)] transition-all duration-300 cursor-pointer overflow-hidden border border-gray-100 group relative transform hover:-translate-y-1" onclick="handleAddToCart('${item.id}')">
                        ${editBtnHtml}
                        <div class="w-full aspect-[16/9] bg-white relative overflow-hidden flex items-center justify-center p-2">
                            ${imageHtml}
                        </div>
                        <div class="p-4 pt-3 flex flex-col justify-between min-h-[110px]">
                            <h3 class="font-bold text-gray-700 text-sm sm:text-base leading-snug line-clamp-2 mb-2 h-10 group-hover:text-blue-700 transition-colors">
                                ${item.name}
                            </h3>
                            <div class="flex justify-between items-end mt-1">
                                <div class="flex flex-col">
                                     <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-[-2px]">‡∏£‡∏≤‡∏Ñ‡∏≤</span>
                                     <div class="flex items-baseline gap-1">
                                        <span class="text-3xl font-extrabold text-gray-800 tracking-tight leading-none group-hover:text-blue-600 transition-colors">${item.price}</span>
                                        <span class="text-xs text-gray-400 font-bold">‡∏ø</span>
                                     </div>
                                </div>
                                <div class="w-10 h-10 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-all shadow-sm group-hover:shadow-lg active:scale-90">
                                    <i class="fas fa-plus text-sm font-bold"></i>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å (‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á Script) ---
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å ID (‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ô menuData ‡πÅ‡∏•‡∏∞ masterData) ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        function handleAddToCart(itemId) {
            // ‡∏´‡∏≤‡πÉ‡∏ô masterData ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏≤‡πÉ‡∏ô menuData
            let item = masterData.find(m => m.id == itemId) || menuData.find(m => m.id == itemId);
            if (item) {
                addItemToCart(item, "-"); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            } else {
                console.error("Item not found:", itemId);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)
        function handleEditClick(itemId, e) {
            e.stopPropagation();
            // ‡∏´‡∏≤ item ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á 2 ‡πÅ‡∏´‡∏•‡πà‡∏á
            let item = masterData.find(m => m.id == itemId) || menuData.find(m => m.id == itemId);
            if (item) {
                document.getElementById('editMenuModal').classList.remove('hidden'); 
                document.getElementById('eId').value = item.id; 
                document.getElementById('eName').value = item.name; 
                document.getElementById('ePrice').value = item.price; 
                document.getElementById('eCategory').value = item.category;
            }
        }

        function toggleCart(show) {
            const panel = document.getElementById('cartPanel'); const mobileBar = document.getElementById('mobileBottomBar');
            if (show) { panel.classList.remove('hidden'); panel.classList.add('flex', 'fixed', 'inset-0', 'z-50'); mobileBar.classList.add('translate-y-[150%]'); } 
            else { if(window.innerWidth < 1024) { panel.classList.add('hidden'); panel.classList.remove('flex', 'fixed', 'inset-0', 'z-50'); if(cart.length > 0) mobileBar.classList.remove('translate-y-[150%]'); } }
        }

        function addToCart(index) { const item = menuData[index]; addItemToCart(item, "-"); }

        function addItemToCart(item, spicy) {
            const existingIndex = cart.findIndex(c => c.id === item.id);
            if (existingIndex !== -1) {
                const existingItem = cart[existingIndex]; existingItem.qty++; cart.splice(existingIndex, 1); cart.unshift(existingItem); speak(existingItem.qty.toString());
            } else { cart.unshift({ ...item, qty: 1, spicy: '-' }); speak(item.price + " ‡∏ö‡∏≤‡∏ó"); }
            renderCart(); if(window.navigator.vibrate) window.navigator.vibrate(50);
        }

        function renderCart() {
    const container = document.getElementById('cartItems'); 
    const totalEl = document.getElementById('totalPrice'); 
    
    // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ï‡∏±‡∏ß
    const btnMobile = document.getElementById('btnOrderMobile');
    const btnDesktop = document.getElementById('btnOrderDesktop'); 
    
    const countEl = document.getElementById('cartCountDesktop'); 
    const mobileBar = document.getElementById('mobileBottomBar'); 
    const mobileCount = document.getElementById('mobileCartCount'); 
    const mobileTotal = document.getElementById('mobileCartTotal');
    const miniTotal = document.getElementById('miniTotalDisplay'); // ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠
    
    // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á ---
    if(cart.length === 0) {
        container.innerHTML = '<div class="h-full flex flex-col items-center justify-center text-gray-400 opacity-60"><i class="fas fa-cash-register text-6xl mb-4"></i><p>‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î QR ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</p></div>';
        
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        totalEl.innerText = "0 ‡∏ø"; 
        countEl.innerText = "0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"; 
        mobileBar.classList.add('translate-y-[150%]'); 
        if(miniTotal) miniTotal.innerText = "0 ‡∏ø";

        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏° Desktop
        if(btnDesktop) {
             // üî¥ ‡∏•‡∏ö row-span-2 ‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô h-full ‡πÄ‡∏õ‡πá‡∏ô h-12
             btnDesktop.className = "h-12 bg-gradient-to-b from-gray-400 to-gray-500 text-white font-bold text-lg rounded-lg shadow-sm border-b-4 border-gray-600 transition-all flex flex-col items-center justify-center gap-1 cursor-not-allowed";
             btnDesktop.disabled = true;
             btnDesktop.innerHTML = '<span class="text-xs font-normal opacity-80">‡∏ß‡πà‡∏≤‡∏á</span>';
        }

        // ‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î QR ‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÜ ‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå)
        if(btnMobile) {
            btnMobile.innerHTML = '<span>QR ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</span> <i class="fas fa-qrcode"></i>';
            btnMobile.className = "w-full bg-gradient-to-r from-green-600 to-green-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition flex justify-center items-center gap-2";
        }
        
        return;
    }
    
    // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ---
    
   // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤) ---
    let btnClassDesktop = "";
    let btnHtmlDesktop = "";
    let btnHtmlMobile = "";
    let btnClassMobile = "";

    if (isCustomerMode) {
        // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        
        // ‡∏õ‡∏∏‡πà‡∏° Desktop (‡∏ã‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
        btnClassDesktop = "hidden"; // ‡∏õ‡∏Å‡∏ï‡∏¥‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏°‡∏Ø ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏™‡πà‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Mobile ‡∏Å‡πá‡πÑ‡∏î‡πâ

        // ‡∏õ‡∏∏‡πà‡∏° Mobile (‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠)
        btnHtmlMobile = '<span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span> <i class="fas fa-check-circle"></i>';
        btnClassMobile = "w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3.5 rounded-xl shadow-lg transition transform active:scale-95 flex justify-center items-center gap-2";

    } else {
        // ‡πÇ‡∏´‡∏°‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        btnClassDesktop = "h-12 bg-gradient-to-b from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold text-lg rounded-lg shadow-md border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition-all flex flex-col items-center justify-center gap-1";
        
        btnHtmlDesktop = '<span class="text-xs font-normal opacity-80"></span><i class="fas fa-check-circle text-2xl"></i>';

        btnHtmlMobile = '<span>‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô</span> <i class="fas fa-arrow-right"></i>';
        btnClassMobile = "w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3.5 rounded-xl shadow-lg transition transform active:scale-95 flex justify-center items-center gap-2";
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° Desktop
    if(btnDesktop) {
        btnDesktop.disabled = false;
        btnDesktop.className = btnClassDesktop;
        btnDesktop.innerHTML = btnHtmlDesktop;
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° Mobile
    if(btnMobile) {
        btnMobile.innerHTML = btnHtmlMobile;
        btnMobile.className = btnClassMobile;
    }

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    let total = 0; let count = 0;
    container.innerHTML = cart.map((item, idx) => {
        total += item.price * item.qty; count += item.qty;
        return `<div class="flex justify-between items-start bg-white p-3 rounded-xl border border-gray-100 shadow-sm mb-2 animate-fade-in"><div class="flex-1"><h4 class="font-bold text-gray-800 leading-tight">${item.name}</h4><div class="text-xs text-gray-500 mt-1 flex gap-2"><span>${item.price}.-</span></div></div><div class="flex flex-col items-end gap-2"><div class="font-bold text-blue-600">${item.price * item.qty}</div><div class="flex items-center bg-gray-100 rounded-lg p-0.5 gap-1"><button onclick="removeFromCart(${idx})" class="w-7 h-7 flex items-center justify-center text-red-500 hover:bg-red-100 rounded-md transition"><i class="fas fa-trash-alt text-xs"></i></button><div class="w-px h-4 bg-gray-300 mx-1"></div><button onclick="updateQty(${idx}, -1)" class="w-7 h-7 flex items-center justify-center text-gray-500 hover:bg-white hover:shadow rounded-md transition">-</button><span class="w-6 text-center font-bold text-sm">${item.qty}</span><button onclick="updateQty(${idx}, 1)" class="w-7 h-7 flex items-center justify-center text-green-600 hover:bg-white hover:shadow rounded-md transition">+</button></div></div></div>`;
    }).join('');
    
    const totalTxt = total.toLocaleString() + " ‡∏ø";
    totalEl.innerText = totalTxt; 
    countEl.innerText = count + " ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"; 
    
    mobileCount.innerText = count; 
    mobileTotal.innerText = totalTxt;
    if(miniTotal) miniTotal.innerText = totalTxt;
    
    const isDrawerOpen = !document.getElementById('cartPanel').classList.contains('hidden');
    if (!isDrawerOpen && window.innerWidth < 1024) { mobileBar.classList.remove('translate-y-[150%]'); }
}

        function updateQty(idx, change) { cart[idx].qty += change; if(cart[idx].qty > 0) { speak(cart[idx].qty.toString()); } if (cart[idx].qty <= 0) cart.splice(idx, 1); renderCart(); }
        function removeFromCart(idx) { cart.splice(idx, 1); renderCart(); }

        function handleCheckoutClick() { 
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á -> ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ QR ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤) ‡∏´‡∏£‡∏∑‡∏≠ QR ‡∏™‡∏±‡πà‡∏á (‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà Logic)
            if (cart.length === 0) {
                quickCheckout(); 
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            if (isCustomerMode) {
                // --- ‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á" ---
                isQuickPayMode = false; 
                openConfirmOrderModal(); 
            } else {
                // --- ‡πÇ‡∏´‡∏°‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á "‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô" ---
                quickCheckout(); 
            } 
        }
        
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ function quickCheckout() ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡πâ‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ
function quickCheckout() {
    isQuickPayMode = true;
    const total = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
    currentPayOrder = { orderId: null, totalPrice: total };
    
    const tableContainer = document.getElementById('quickPayTableNoContainer');
    if (tableContainer) tableContainer.classList.add('hidden'); 
    
    try { initBankQR(); } catch(e) { console.log("QR Init Error", e); }
    
    const modal = document.getElementById('paymentModal');
    if (modal) modal.classList.remove('hidden'); 

    // üî¥ [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ö‡∏•‡∏≠‡πÅ‡∏ú‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
    const leftPanel = document.getElementById('leftPanel');
    if(leftPanel) leftPanel.classList.add('blur-sm', 'opacity-50', 'pointer-events-none');
    // -------------------------------------------------------------

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
    const modalTotal = document.getElementById('modalTotalPay');
    if(modalTotal) modalTotal.innerText = total.toLocaleString();
    
    // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
    const modalChangeBox = document.getElementById('modalChangeBox');
    if(modalChangeBox) {
        modalChangeBox.classList.add('opacity-0', 'translate-y-2'); 
        modalChangeBox.innerHTML = `‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: <span id="modalChangePay" class="text-green-600 text-5xl font-extrabold ml-2 drop-shadow-sm animate-heartbeat">0</span> <span class="ml-1 text-sm">‡∏ø</span>`;
    }

    const inputRec = document.getElementById('inputReceived');
    if (inputRec) {
        inputRec.value = ''; 
        setTimeout(() => { inputRec.focus(); }, 100);
    }
    
    const totalPriceEl = document.getElementById('totalPrice');
    const changeWrapper = document.getElementById('changeWrapper');
    if (totalPriceEl) {
        totalPriceEl.classList.remove('text-4xl', 'translate-y-[-10px]');
        totalPriceEl.classList.add('text-7xl');
    }
    if (changeWrapper) {
        changeWrapper.classList.add('hidden', 'opacity-0', 'translate-y-4');
        changeWrapper.classList.remove('flex', 'opacity-100', 'translate-y-0');
    }
    
    const btnConfirm = document.getElementById('btnConfirmPay');
    if (btnConfirm) {
        // 1. ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô false (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÑ‡∏î‡πâ)
        btnConfirm.disabled = false; 
        
        // 2. üî¥ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ .remove (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏™‡∏µ‡∏à‡∏≤‡∏á‡∏≠‡∏≠‡∏Å) 
        // (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô .add ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö)
        btnConfirm.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    if (total > 0) { speak("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° " + total + " ‡∏ö‡∏≤‡∏ó"); }
}

        // --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠ + ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà) ---
        function openConfirmOrderModal() {
            document.getElementById('confirmOrderModal').classList.remove('hidden');
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°)
            document.getElementById('summaryList').innerHTML = cart.map(i => `<div class="flex justify-between border-b border-gray-200 border-dashed py-2 last:border-0"><span class="text-gray-700 text-sm">${i.name} x${i.qty}</span><span class="font-bold text-gray-800">${i.price*i.qty}</span></div>`).join('') + `<div class="flex justify-between font-bold mt-3 pt-3 border-t text-blue-600 text-lg"><span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span><span>${document.getElementById('totalPrice').innerText}</span></div>`;
            
            // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á Element
            const typeSelect = document.getElementById('orderType');
            const typeDiv = typeSelect.parentElement; 
            const addressSection = document.getElementById('addressSection');
            const tableDiv = document.getElementById('tableNo').parentElement; 
            const tableInput = document.getElementById('tableNo');

            if (isCustomerMode) {
                // --- ‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ---
                typeSelect.value = "‡∏™‡πà‡∏á‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà";
                typeDiv.classList.add('hidden');
                tableDiv.classList.add('hidden'); 
                addressSection.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô Address
                
                // üî¥ FIX: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏° Name, Phone, Address ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô tableInput.value
                const cName = localStorage.getItem('customerName') || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
                const cPhone = localStorage.getItem('customerPhone') || '-';
                const savedHouse = localStorage.getItem('customerAddrHouse') || '';
                const savedSoi = localStorage.getItem('customerAddrSoi') || '';
                
                const addressStr = `[‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà: ${savedHouse} ${savedSoi ? '‡∏ã.' + savedSoi : ''}]`;
                
                // üü¢ NEW: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏•‡∏á‡πÉ‡∏ô TableNo ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ Sheet ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Bill Detail
                tableInput.value = `${cName} (${cPhone}) ${addressStr}`;
                
                // Pre-fill hidden address fields as a fail-safe
                document.getElementById('addrHouseNo').value = savedHouse;
                document.getElementById('addrSoi').value = savedSoi;

            } else {
                // ‡πÇ‡∏´‡∏°‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏Å‡∏ï‡∏¥
                typeDiv.classList.remove('hidden');
                tableDiv.classList.remove('hidden'); 
                toggleAddressFields(); 
                
                tableDiv.querySelector('label').innerText = "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà";
                tableInput.placeholder = "‡πÄ‡∏ä‡πà‡∏ô 1 ‡∏´‡∏£‡∏∑‡∏≠ A";
            }
        }

        // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ---
        function toggleAddressFields() {
            const type = document.getElementById('orderType').value; 
            const addrSection = document.getElementById('addressSection');
            if (type === '‡∏™‡πà‡∏á‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà') { addrSection.classList.remove('hidden'); } else { addrSection.classList.add('hidden'); }
        }

        function submitOrder() {
            setLoading('btnSubmitOrder', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
            const total = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100 ‡∏ö‡∏≤‡∏ó (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°)
            if (isCustomerMode && total < 100) { /* ... */ return; }

            if (isCustomerMode) { speak("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° " + total.toLocaleString() + " ‡∏ö‡∏≤‡∏ó"); }
            
            const orderType = document.getElementById('orderType').value;
            let noteText = document.getElementById('orderNote').value.trim(); 
            let finalTableNo = document.getElementById('tableNo').value; 
            
            if (orderType === '‡∏™‡πà‡∏á‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà') {
                const houseNo = document.getElementById('addrHouseNo').value.trim(); 
                const soi = document.getElementById('addrSoi').value.trim();
                
                // Fail-safe validation
                if (isCustomerMode && (!houseNo || !soi)) { 
                     showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏∞', '<i class="fas fa-map-marked-alt text-red-500"></i>');
                     setLoading('btnSubmitOrder', false, '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); 
                     return; 
                }
            }

            const payload = { 
                action: "saveOrder", 
                tableNo: finalTableNo || "‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô", 
                orderType: orderType, 
                cartItems: cart.map(i => ({ name: i.name, qty: i.qty, price: i.price, spicy: "-" })), 
                totalPrice: total, 
                note: noteText 
            };
            
             fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(res => res.json()).then(data => {
                if(data.result === 'success') {
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    myLastOrders = { items: [...cart], total: total, note: noteText, timestamp: new Date().toISOString() }; 
                    
                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success'); 
                    if (isCustomerMode) { setTimeout(() => speak("‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞"), 1500); } else { speak("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞"); }
                    
                    cart = []; renderCart(); toggleCart(false); 
                    
                    // üü¢ FIX 1: ‡∏¢‡πâ‡∏≤‡∏¢ closeModal ‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                    closeModal('confirmOrderModal'); 
                    
                    if(!isCustomerMode) document.getElementById('tableNo').value = '';
                    document.getElementById('orderNote').value = ''; 
                    document.getElementById('addrHouseNo').value = '';
                    document.getElementById('addrSoi').value = '';
                    
                    if(isCustomerMode) openMyRecentOrder();
                    updateKitchenBadge();
                    
                } else if (data.error === 'STORE_CLOSED') {
                    document.getElementById('storeClosedModal').classList.remove('hidden');
                    isStoreOpen = false; updateStoreUI();
                    speak("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
                    closeModal('confirmOrderModal'); 
                    
                } else { 
                    showCustomAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + data.error, '<i class="fas fa-exclamation-circle text-red-500"></i>'); 
                }
            }).catch(err => showCustomAlert('Connection Error', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì')).finally(() => setLoading('btnSubmitOrder', false, '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'));
        }

        // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ß (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤) ---
        function updateKitchenBadge() { 
            return fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getOrders" }) })
            .then(res => res.json())
            .then(data => { 
                if (data.result === 'success') { 
                    
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô (Auto Lock)
                    if (data.isStoreOpen !== undefined) {
                        isStoreOpen = data.isStoreOpen;
                        updateStoreUI(); 
                        if (isCustomerMode && !isStoreOpen) {
                            document.getElementById('storeClosedModal').classList.remove('hidden');
                        } else if (isCustomerMode && isStoreOpen) {
                            document.getElementById('storeClosedModal').classList.add('hidden');
                        }
                    }

                    const waitingOrders = data.data.filter(o => o.status !== 'Served'); 
                    const waitingCount = waitingOrders.length; 
                    const badge = document.getElementById('kitchenBadge'); 
                    
                    if (waitingCount > 0) { badge.innerText = waitingCount; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } 
                    
                    if (!isCustomerMode) {
                        const isKitchenModalOpen = !document.getElementById('kitchenModal').classList.contains('hidden');
                        
                        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏¥‡∏á Notification (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô)
                        if (lastOrderCount !== -1 && waitingCount > lastOrderCount) { 
                            playNotificationSound(); 
                            showToast('‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤!', 'warning'); 
                        }
                        
                        // 2. ‡∏´‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                        if (isKitchenModalOpen && waitingCount !== lastOrderCount) { 
                            currentOrders = data.data; 
                            renderKitchen(currentOrders); 
                        }
                    }
                    
                    lastOrderCount = waitingCount; 
                    
                    // üî¥ FIX: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                    if (isCustomerMode) { 
                        document.getElementById('queueCountDisplay').innerText = waitingCount; 
                        
                        // üü¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠ Identity ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 ‡∏™‡πà‡∏ß‡∏ô (‡∏ä‡∏∑‡πà‡∏≠ + ‡πÄ‡∏ö‡∏≠‡∏£‡πå + ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Sheet
                        const cName = localStorage.getItem('customerName') || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
                        const cPhone = localStorage.getItem('customerPhone') || '-';
                        const savedHouse = localStorage.getItem('customerAddrHouse') || '';
                        const savedSoi = localStorage.getItem('customerAddrSoi') || '';
                        
                        // Recreate the exact address string format saved on the server
                        const addressStr = `[‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà: ${savedHouse} ${savedSoi ? '‡∏ã.' + savedSoi : ''}]`;
                        
                        // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Sheet/Orders/Table No ‡πÄ‡∏õ‡πä‡∏∞‡πÜ
                        const myIdentity = `${cName} (${cPhone}) ${addressStr}`; 
                        
                        // ‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏≤‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
                        const myOrders = data.data.filter(o => o.tableNo === myIdentity);
                        
                        myOrders.forEach(order => {
                            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô Served ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
                            if (order.status === 'Served' && !notifiedOrders.has(order.orderId)) {
                                document.getElementById('deliveryNotificationModal').classList.remove('hidden');
                                playNotificationSound();
                                speak("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏∞");
                                notifiedOrders.add(order.orderId); 
                            }
                        });
                    }
                } 
            }).catch(e=>{}); 
        }
        function openKitchenModal() { document.getElementById('kitchenModal').classList.remove('hidden'); fetchOrders(); }
        function fetchOrders() { const grid = document.getElementById('kitchenGrid'); grid.innerHTML = '<div class="col-span-full text-center py-20"><i class="fas fa-circle-notch fa-spin text-4xl text-orange-500"></i><p class="mt-2 text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</p></div>'; fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getOrders" }) }).then(res => res.json()).then(data => { if (data.result === 'success') { currentOrders = data.data; renderKitchen(currentOrders); updateKitchenBadge(); } else { grid.innerHTML = `<div class="col-span-full text-center text-red-500">Error: ${data.error}</div>`; } }); }
        function renderKitchen(orders) { 
            const grid = document.getElementById('kitchenGrid'); 
            grid.innerHTML = ''; 
            
            if(!orders || orders.length === 0) { 
                grid.innerHTML = '<div class="col-span-full flex flex-col items-center justify-center text-gray-300 py-20 animate-fade-in"><i class="fas fa-clipboard-check text-6xl mb-4"></i><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á</p></div>'; 
                return; 
            } 
            
            grid.innerHTML = orders.map(order => { 
                const isServed = order.status === 'Served'; 
                const isTakeAway = order.orderType === '‡∏™‡πà‡∏á‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà'; 
                
                const cardBorder = isServed ? 'border-green-400' : (isTakeAway ? 'border-orange-400' : 'border-blue-400');
                const headerBg = isServed ? 'bg-green-500' : (isTakeAway ? 'bg-orange-500' : 'bg-blue-600');
                const bgClass = isServed ? 'bg-green-50' : 'bg-white';
                
                const timeDiff = Math.floor((new Date() - new Date(order.timestamp)) / 60000);
                let timeAgoText = timeDiff < 1 ? '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà' : `${timeDiff} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
                if(timeDiff > 15 && !isServed) timeAgoText = `<span class="text-red-500 font-bold animate-pulse"><i class="fas fa-exclamation-circle"></i> ${timeAgoText}</span>`;

                return `
                <div class="${bgClass} border-2 ${cardBorder} rounded-2xl shadow-lg relative flex flex-col animate-slide-up overflow-hidden">
                    
                    <div class="${headerBg} p-3 text-white flex justify-between items-center shadow-md">
                        <div class="flex items-center gap-3">
                            <div class="bg-white/20 px-3 py-1 rounded-lg text-center min-w-[50px]">
                                <div class="text-[10px] font-bold opacity-80">‡∏Ñ‡∏¥‡∏ß/‡πÇ‡∏ï‡πä‡∏∞</div>
                                <div class="text-2xl font-extrabold leading-none">${order.tableNo}</div>
                            </div>
                            <span class="text-sm font-bold bg-black/20 px-2 py-0.5 rounded-md border border-white/10">${order.orderType}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-mono font-bold text-lg leading-none">${new Date(order.timestamp).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}</div>
                            <div class="text-[10px] font-medium mt-0.5 opacity-90">${timeAgoText}</div>
                        </div>
                    </div>

                    <div class="p-4 flex-1 flex flex-col gap-3">
                        ${order.note ? `<div class="bg-yellow-100 border-l-4 border-yellow-400 text-yellow-900 text-xs p-2 rounded-r font-bold"><i class="fas fa-comment-dots"></i> ${order.note}</div>` : ''}

                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <div class="flex text-[10px] text-gray-500 font-bold bg-gray-100 px-3 py-2 border-b border-gray-200 uppercase tracking-wide">
                                <div class="flex-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                                <div class="w-14 text-right">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡∏∞</div>
                                <div class="w-12 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
                                <div class="w-16 text-right">‡∏£‡∏ß‡∏°</div>
                            </div>
                            
                            <div class="divide-y divide-gray-100 max-h-[250px] overflow-y-auto custom-scrollbar">
                                ${(order.items || []).map(i => `
                                    <div class="flex items-center px-3 py-2.5 hover:bg-gray-50 transition">
                                        <div class="flex-1 font-bold text-gray-700 text-sm pr-2 leading-tight">
                                            ${i.name}
                                        </div>
                                        <div class="w-14 text-right text-xs text-gray-400 font-mono">
                                            ${i.price}
                                        </div>
                                        <div class="w-12 text-center">
                                            <span class="text-lg font-extrabold text-gray-800">${i.qty}</span>
                                        </div>
                                        <div class="w-16 text-right font-bold text-blue-600 text-sm">
                                            ${(i.price * i.qty).toLocaleString()}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="bg-gray-50 px-3 py-2 border-t border-gray-200 flex justify-between items-center">
                                <span class="text-xs font-bold text-gray-500">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                                <span class="text-lg font-extrabold text-blue-600">${order.totalPrice.toLocaleString()} ‡∏ø</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-3 bg-gray-50 border-t border-gray-200 flex gap-2">
                        ${!isServed ? `
                            <button onclick="markServed('${order.orderId}', this)" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-xl font-bold text-base shadow transition transform active:scale-95">
                                <i class="fas fa-check-circle"></i> ‡∏à‡∏±‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
                            </button>` 
                        :   `<div class="flex-1 text-center text-green-600 font-bold py-2.5 bg-green-100 rounded-xl border border-green-200">
                                <i class="fas fa-check-double"></i> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
                            </div>`
                        }
                        <button onclick="openPayment('${order.orderId}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2.5 rounded-xl font-bold text-base shadow transition transform active:scale-95">
                             ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                        </button>
                    </div>
                </div>`; 
            }).join(''); 
        }
        function markServed(orderId, btn) { const originalContent = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>'; fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "updateOrderStatus", orderId: orderId, status: "Served" }) }).then(() => { fetchOrders(); showToast('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'success'); }).catch(() => { btn.disabled = false; btn.innerHTML = originalContent; }); }
        
        function openPayment(orderId) { 
            // 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
            currentPayOrder = currentOrders.find(o => String(o.orderId) === String(orderId)); 
            
            if(!currentPayOrder) {
                console.error("Order not found:", orderId);
                showCustomAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ');
                return; 
            } 

            // 2. ‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ + ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß
            cart = JSON.parse(JSON.stringify(currentPayOrder.items)); 
            renderCart(); 
            toggleCart(true);
            closeModal('kitchenModal');

            // 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
            isQuickPayMode = false; 
            document.getElementById('quickPayTableNoContainer').classList.add('hidden');
            
            initBankQR();
            document.getElementById('paymentModal').classList.remove('hidden'); 
            
            const leftPanel = document.getElementById('leftPanel');
            if(leftPanel) leftPanel.classList.add('blur-sm', 'opacity-50', 'pointer-events-none');

            const totalEl = document.getElementById('modalTotalPay');
            if(totalEl) {
                totalEl.innerText = currentPayOrder.totalPrice.toLocaleString(); 
            }

            const inputRec = document.getElementById('inputReceived');
            if(inputRec) {
                inputRec.value = ''; 
                setTimeout(() => { inputRec.focus(); }, 300); 
            }
            
            const modalChangeBox = document.getElementById('modalChangeBox');
            if(modalChangeBox) {
                modalChangeBox.classList.add('opacity-0', 'translate-y-2');
                const changeTxt = document.getElementById('modalChangePay');
                if(changeTxt) changeTxt.innerText = "0";
            }
            
            // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏≠‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î btnConfirmPay.disabled = true ‡∏≠‡∏≠‡∏Å
            // ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Class ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏à‡∏≤‡∏á‡πÜ ‡∏≠‡∏≠‡∏Å
            const btnConfirm = document.getElementById('btnConfirmPay');
            if(btnConfirm) {
                btnConfirm.disabled = false; // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î
                btnConfirm.classList.remove('opacity-50', 'cursor-not-allowed'); // ‡∏•‡∏ö‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡∏≠‡∏Å
            }
            
            speak("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° " + currentPayOrder.totalPrice + " ‡∏ö‡∏≤‡∏ó"); 
            setTimeout(() => { document.getElementById('inputReceived').focus(); }, 100);
        }
        
        function addMoney(amount) { const input = document.getElementById('inputReceived'); input.value = Number(input.value) + amount; calcChange(); }
        function setExactMoney() { document.getElementById('inputReceived').value = currentPayOrder.totalPrice; calcChange(); }
        function clearMoney() { document.getElementById('inputReceived').value = ''; calcChange(); }
        
        let ttsTimer = null;

        function calcChange() { 
            const total = currentPayOrder.totalPrice; 
            const inputEl = document.getElementById('inputReceived');
            const received = Number(inputEl.value); 
            const change = received - total; 
            
            const btn = document.getElementById('btnConfirmPay'); 
            const modalChangeBox = document.getElementById('modalChangeBox');

            // --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≤‡∏î/‡πÄ‡∏Å‡∏¥‡∏ô ---
            if(received >= total && total > 0) {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô
                if(modalChangeBox) {
                    modalChangeBox.classList.remove('opacity-0', 'translate-y-2');
                    modalChangeBox.innerHTML = `‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: <span class="text-green-600 text-5xl font-extrabold ml-2 drop-shadow-sm animate-heartbeat">${change.toLocaleString()}</span> <span class="ml-1 text-sm">‡∏ø</span>`;
                }
                
                // ‡∏û‡∏π‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô
                if(change >= 0) { 
                    clearTimeout(ttsTimer);
                    ttsTimer = setTimeout(() => { speak("‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô " + received + " ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô " + change + " ‡∏ö‡∏≤‡∏ó"); }, 800);
                }

            } else { 
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏õ‡πá‡∏ô 0
                if(modalChangeBox && received > 0) {
                     // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö -> ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏ß‡πà‡∏≤‡∏Ç‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà
                     const missing = Math.abs(change);
                     modalChangeBox.classList.remove('opacity-0', 'translate-y-2');
                     modalChangeBox.innerHTML = `‡∏Ç‡∏≤‡∏î: <span class="text-red-500 text-4xl font-extrabold ml-2 animate-heartbeat">${missing.toLocaleString()}</span> <span class="ml-1 text-sm">‡∏ø</span>`;
                } else if (modalChangeBox) {
                     // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ -> ‡∏ã‡πà‡∏≠‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô
                     modalChangeBox.classList.add('opacity-0', 'translate-y-2');
                }
            } 
            
            if(btn) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ Textbox ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            if(received >= total) {
                inputEl.classList.replace('border-blue-500', 'border-green-500');
                inputEl.classList.replace('text-blue-600', 'text-green-600');
            } else {
                inputEl.classList.replace('border-green-500', 'border-blue-500');
                inputEl.classList.replace('text-green-600', 'text-blue-600');
            }
        }
        
        function confirmPayment() { 
            const inputRec = document.getElementById('inputReceived');
            // ‡πÉ‡∏ä‡πâ let ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ
            let received = Number(inputRec.value); 
            
            if (!currentPayOrder) {
                showCustomAlert('Error', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                return;
            }

            const total = currentPayOrder.totalPrice; 

            // ‚úÖ‚úÖ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏° Logic ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ]
            // 1. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏õ‡πá‡∏ô 0) -> ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏à‡πà‡∏≤‡∏¢‡∏û‡∏≠‡∏î‡∏µ
            if (received === 0) {
                received = total;
                inputRec.value = total; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ
            }

            // 2. ‡∏ñ‡πâ‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° -> ‡∏´‡πâ‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            if (received < total) {
                showToast('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', 'warning');
                playNotificationSound();
                // ‡∏™‡∏±‡πà‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                inputRec.classList.add('animate-pulse', 'bg-red-100');
                setTimeout(() => inputRec.classList.remove('animate-pulse', 'bg-red-100'), 500);
                return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            }
            // ==========================================

            const orderId = currentPayOrder.orderId;
            
            closeModal('paymentModal'); 
            const leftPanel = document.getElementById('leftPanel');
            if(leftPanel) leftPanel.classList.remove('blur-sm', 'opacity-50', 'pointer-events-none'); 
            
            speak("‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞");

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å
            const totalPriceEl = document.getElementById('totalPrice');
            const changeWrapper = document.getElementById('changeWrapper');

            if(totalPriceEl) {
                totalPriceEl.classList.add('text-7xl');
                totalPriceEl.classList.remove('text-4xl', 'translate-y-[-5px]');
            }
            if(changeWrapper) {
                changeWrapper.classList.add('hidden', 'opacity-0', 'translate-y-4');
                changeWrapper.classList.remove('flex', 'opacity-100', 'translate-y-0');
            }

            if(inputRec) inputRec.value = ''; 

            const modalChangeBox = document.getElementById('modalChangeBox');
            if(modalChangeBox) {
                modalChangeBox.classList.add('opacity-0', 'translate-y-2');
                const modalChange = document.getElementById('modalChangePay');
                if(modalChange) modalChange.innerText = "0";
            }
            
            let itemsToSave = [];
            
            if (isQuickPayMode) { 
                 itemsToSave = cart.map(i => ({ name: i.name, qty: i.qty, price: i.price })); 
                 const quickPayInput = document.getElementById('quickPayTableNo');
                 let customName = (quickPayInput ? quickPayInput.value : "").trim(); 
                 if(!customName) customName = "Walk-in"; 
                 
                 cart = []; 
                 renderCart(); 
                 toggleCart(false); 

                 const payload = { 
                     action: "processPayment", 
                     tableNo: customName, 
                     finalPrice: total, 
                     received: received, 
                     change: received - total,
                     directItems: itemsToSave
                 };
                 sendPaymentRequest(payload, true);

            } else {
                // ‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡∏Ñ‡∏£‡∏±‡∏ß
                cart = [];          
                renderCart();       
                toggleCart(false);  
                
                const payload = { 
                    action: "processPayment", 
                    orderId: orderId,           
                    tableNo: currentPayOrder.tableNo, 
                    orderType: currentPayOrder.orderType,
                    items: currentPayOrder.items, 
                    finalPrice: total, 
                    received: received, 
                    change: received - total 
                };
                sendPaymentRequest(payload, false);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏¢‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô)
        function sendPaymentRequest(payload, isQuickPay) {
            fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(data => { 
                if(data.result === 'success') { 
                    showToast('‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); 
                    
                    if (!isQuickPay) {
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡∏Ñ‡πâ‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
                        fetchOrders(); 
                    }
                } else {
                    showCustomAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + data.error);
                }
            })
            .catch(err => {
                showCustomAlert('Connection Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
                console.error(err);
            });
        }
        
        function openEditMenu(index, e) { e.stopPropagation(); const item = menuData[index]; document.getElementById('editMenuModal').classList.remove('hidden'); document.getElementById('eId').value = item.id; document.getElementById('eName').value = item.name; document.getElementById('ePrice').value = item.price; document.getElementById('eCategory').value = item.category; }
        function openAddMenuModal() { document.getElementById('addModal').classList.remove('hidden'); }
        function openSalesModal() { document.getElementById('salesModal').classList.remove('hidden'); document.getElementById('saleToday').innerText = '...'; fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getSalesStats" }) }).then(r=>r.json()).then(d => { document.getElementById('saleToday').innerText = d.today.toLocaleString(); document.getElementById('saleYest').innerText = d.yesterday.toLocaleString(); document.getElementById('saleMonth').innerText = d.month.toLocaleString(); }); }
        function openHistoryModal() { 
            document.getElementById('historyModal').classList.remove('hidden'); 
            
            const list = document.getElementById('historyList');
            list.innerHTML = '<tr><td colspan="3" class="text-center p-10 text-gray-400"><i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</td></tr>'; 
            
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getHistory" }) })
            .then(r => r.json())
            .then(d => { 
                if(d.result === 'success') { 
                    historyBills = d.data; 

                    if(historyBills.length === 0) {
                        list.innerHTML = '<tr><td colspan="3" class="text-center p-10 text-gray-300">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</td></tr>';
                        return;
                    }

                    // üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)
                    list.innerHTML = historyBills.map((b, index) => {
                        let dateStr = "-";
                        let timeStr = "-";
                        try {
                            const d = new Date(b.date);
                            // ‡πÅ‡∏¢‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô 28/11/68)
                            dateStr = d.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit' });
                            // ‡πÅ‡∏¢‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô 12:30)
                            timeStr = d.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                        } catch(e) {}

                        return `
                        <tr onclick="openBillDetail(${index})" class="hover:bg-blue-50 transition duration-150 cursor-pointer group border-b border-gray-100 last:border-0">
                            <td class="p-3 font-mono align-top pt-3 group-hover:text-blue-600">
                                <div class="text-[10px] text-gray-400 font-bold leading-none mb-1">${dateStr}</div>
                                <div class="text-sm font-bold text-gray-700">${timeStr}</div>
                            </td>
                            <td class="p-3 text-gray-700 align-top pt-3">
                                <span class="line-clamp-1 leading-relaxed font-medium group-hover:text-blue-800">${b.itemSummary}</span>
                                <span class="text-[10px] text-gray-400 block mt-0.5 group-hover:text-blue-400">ID: ${b.billId}</span>
                            </td>
                            <td class="p-3 text-right font-bold text-gray-800 align-top pt-3 whitespace-nowrap text-base group-hover:text-blue-600">
                                ${parseFloat(b.total).toLocaleString()}
                            </td>
                        </tr>`; 
                    }).join(''); 
                } else {
                    list.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-red-400">Error: ${d.error}</td></tr>`;
                }
            })
            .catch(err => {
                console.error(err);
                list.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-red-400">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</td></tr>';
            }); 
        }
        
        function openBillDetail(index) {
            const bill = historyBills[index];
            if (!bill) return;
            
            // Format time and date
            const d = new Date(bill.date);
            const dateStr = d.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit' });
            const timeStr = d.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            
            // Logic ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å Name, Phone, Address ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå TableNo
            const tableNo = bill.table || 'N/A';
            const customerMatch = tableNo.match(/(.*)\s*\((.*?)\)\s*(\[‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà:\s*.*\])?/);
            const customerName = customerMatch ? customerMatch[1].trim() : tableNo;
            const customerPhone = customerMatch && customerMatch[2] ? customerMatch[2].trim() : '';
            const customerAddress = customerMatch && customerMatch[3] ? customerMatch[3] : '';

            const content = document.getElementById('billDetailContent');
            
            const itemsHtml = bill.items.map(item => `
                <div class="flex justify-between items-start text-sm border-b border-dashed border-gray-200 py-2">
                    <div class="flex-1 pr-2">
                        <div class="font-medium text-gray-800">${item.name}</div>
                        <div class="text-xs text-gray-500">${item.price.toLocaleString()} x ${item.qty}</div>
                    </div>
                    <div class="w-16 text-right font-bold text-gray-800">${(item.price * item.qty).toLocaleString()}</div>
                </div>
            `).join('');

            content.innerHTML = `
                <div class="p-4 pt-6 bg-white border-b border-gray-200 flex-shrink-0">
                    <div class="text-center pb-3 border-b border-dashed border-gray-300">
                        <h3 class="text-2xl font-extrabold text-gray-800 mb-1">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
                        <p class="text-xs text-gray-500 mb-2">‡∏ö‡∏¥‡∏• ID: ${bill.billId}</p>
                    </div>

                    <div class="pt-4 pb-2 text-xs space-y-1">
                        <div class="flex justify-between">
                            <span class="text-gray-500">‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤:</span>
                            <span class="font-bold text-gray-700">${dateStr} ${timeStr}</span>
                        </div>
                        <div class="font-bold text-gray-700 pt-2 border-t border-dashed">
                            <i class="fas fa-user-tag mr-2 text-blue-600"></i> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${customerName} ${customerPhone ? `(${customerPhone})` : ''}
                        </div>
                        ${customerAddress ? `
                            <div class="text-gray-500 text-xs">
                               <i class="fas fa-map-marker-alt text-red-500 mr-1"></i> ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${customerAddress.replace(/\[‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà:\s*|\]/g, '').trim()}
                            </div>
                        ` : ''}
                        ${bill.note ? `<div class="text-gray-500 pt-2 border-t border-dashed">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${bill.note}</div>` : ''}
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto custom-scrollbar bg-white px-4 border-b border-gray-200"> 
                    <div class="pt-2 pb-2 space-y-1">
                        ${itemsHtml}
                    </div>
                </div>

                <div class="p-4 flex-shrink-0 border-t border-gray-200 bg-white">
                    <div class="pb-3 space-y-2 border-b border-gray-300">
                        <div class="flex justify-between font-bold text-lg">
                            <span class="text-gray-700">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span>
                            <span class="text-2xl font-extrabold text-blue-600">${bill.total.toLocaleString()} ‡∏ø</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</span>
                            <span class="font-bold text-gray-700">${parseFloat(bill.receive || bill.total).toLocaleString()} ‡∏ø</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</span>
                            <span class="font-bold text-green-600">${parseFloat(bill.change || 0).toLocaleString()} ‡∏ø</span>
                        </div>
                    </div>

                    <div class="mt-4 flex gap-2 items-center">
                        
                        <button onclick="printReceiptFromIndex(${index})" 
                                id="btnPrintBill" 
                                class="bg-blue-600 hover:bg-blue-700 text-white w-1/4 py-2 rounded-xl text-sm font-bold transition shadow-md">
                            <i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå
                        </button>
                        
                        <button onclick="confirmDeleteBill('${bill.billId}')" 
                                id="btnDeleteBill" 
                                class="bg-red-600 hover:bg-red-700 text-white w-1/4 py-2 rounded-xl text-sm font-bold transition shadow-md">
                            <i class="fas fa-trash-alt"></i> ‡∏•‡∏ö
                        </button>
                        
                        <button onclick="closeModal('billDetailModal')" 
                                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-xl font-bold transition">
                            ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('billDetailModal').classList.remove('hidden');
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏ö‡∏¥‡∏• ---
        function confirmDeleteBill(billId) {
            document.getElementById('deleteBillIdTarget').value = billId;
            document.getElementById('deleteBillModal').classList.remove('hidden');
        }

        function executeDeleteBill() {
            const billId = document.getElementById('deleteBillIdTarget').value;
            setLoading('btnConfirmDeleteBill', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...');
            
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "deleteBill", billId: billId }) })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    showToast('‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    closeModal('deleteBillModal');
                    closeModal('billDetailModal');
                    openHistoryModal(); // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà
                    openSalesModal();   // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà)
                } else {
                    showCustomAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡πÑ‡∏î‡πâ: ' + data.error, '<i class="fas fa-exclamation-circle text-red-500"></i>');
                }
            })
            .catch(err => showCustomAlert('Connection Error', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï'))
            .finally(() => setLoading('btnConfirmDeleteBill', false, '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö'));
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (58mm) ---
        function printReceipt(bill) {
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            let items = bill.items;
            if (typeof items === 'string') { try { items = JSON.parse(items); } catch(e) { items = []; } }
            
            let itemsHtml = items.map(i => `
                <tr>
                    <td style="text-align: left; padding: 2px 0;">${i.name}<br><span style="font-size: 10px; color: #666;">x${i.qty}</span></td>
                    <td style="text-align: right; vertical-align: top; padding: 2px 0;">${(i.price * i.qty).toLocaleString()}</td>
                </tr>
            `).join('');

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå
            const printWindow = window.open('', '', 'width=300,height=600');
            
            // HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à 58mm
            const receiptHtml = `
                <html>
                <head>
                    <title>Print Receipt</title>
                    <style>
                        body { font-family: 'Courier New', monospace; margin: 0; padding: 10px; width: 58mm; color: #000; font-size: 12px; }
                        .header { text-align: center; margin-bottom: 10px; }
                        .store-name { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
                        .divider { border-top: 1px dashed #000; margin: 5px 0; }
                        table { width: 100%; border-collapse: collapse; }
                        .total-section { margin-top: 10px; font-weight: bold; font-size: 14px; }
                        .footer { text-align: center; margin-top: 15px; font-size: 10px; }
                        @media print {
                            @page { margin: 0; size: 58mm auto; }
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="store-name">‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏û‡∏¥‡∏ô ‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏≥</div>
                        <div>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
                    </div>
                    
                    <div class="divider"></div>
                    <div style="font-size: 10px;">
                        <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(bill.date).toLocaleString('th-TH')}</div>
                        <div>Bill ID: ${bill.billId}</div>
                        <div>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${bill.table} (${bill.type})</div>
                    </div>
                    <div class="divider"></div>

                    <table>
                        ${itemsHtml}
                    </table>

                    <div class="divider"></div>

                    <table>
                        <tr class="total-section">
                            <td style="text-align: left;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td>
                            <td style="text-align: right;">${parseFloat(bill.total).toLocaleString()}</td>
                        </tr>
                        <tr style="font-size: 11px;">
                            <td style="text-align: left;">‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</td>
                            <td style="text-align: right;">${parseFloat(bill.receive || bill.total).toLocaleString()}</td>
                        </tr>
                        <tr style="font-size: 11px;">
                            <td style="text-align: left;">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</td>
                            <td style="text-align: right;">${parseFloat(bill.change || 0).toLocaleString()}</td>
                        </tr>
                    </table>

                    <div class="footer">
                        ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞<br>
                        Powered by ICE KANJANAWAT POS
                    </div>

                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 100);
                        }
                    <\/script>
                <\/body>
                <\/html>
            `;

            printWindow.document.write(receiptHtml);
            printWindow.document.close();
        }
        
        function printReceiptFromIndex(index) {
            const bill = historyBills[index];
            if(bill) {
                printReceipt(bill);
            } else {
                showCustomAlert('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•');
            }
        }



        document.getElementById('editMenuForm').addEventListener('submit', function(e) { e.preventDefault(); setLoading('btnEditSave', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'); const payload = { action: "editMenu", id: document.getElementById('eId').value, name: document.getElementById('eName').value, price: document.getElementById('ePrice').value, category: document.getElementById('eCategory').value, spicy: "-" }; fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r=>r.json()).then(d=>{ if(d.result==='success') { showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); closeModal('editMenuModal'); fetchMenu(); } }).finally(()=>setLoading('btnEditSave', false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å')); });
        
        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = event => { const img = new Image(); img.src = event.target.result; img.onload = () => { const canvas = document.createElement('canvas'); let width = img.width; let height = img.height; if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } else { if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; } } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', quality)); }; img.onerror = error => reject(error); }; reader.onerror = error => reject(error);
            });
        }
        document.getElementById('addMenuForm').addEventListener('submit', function(e) { 
            e.preventDefault(); 
            const fileInput = document.getElementById('mFile'); const file = fileInput.files[0]; const mCode = document.getElementById('mCode').value.trim();
            if (file) {
                 setLoading('btnSaveMenu', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ...'); 
                 compressImage(file, 800, 0.7).then(compressedBase64 => {
                    setLoading('btnSaveMenu', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...'); 
                    const base64Data = compressedBase64.split(',')[1];
                    const payload = { action: "addMenu", name: document.getElementById('mName').value, price: document.getElementById('mPrice').value, category: document.getElementById('mCategory').value, spicy: "-", image: base64Data, mimeType: "image/jpeg", fileName: file.name.replace(/\.[^/.]+$/, "") + ".jpg" };
                    if (mCode) { payload.id = mCode; }
                    sendAddMenu(payload);
                } ).catch(err => { console.error(err); setLoading('btnSaveMenu', false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'); showCustomAlert('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ'); });
            } else {
                 setLoading('btnSaveMenu', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'); 
                 const payload = { action: "addMenu", name: document.getElementById('mName').value, price: document.getElementById('mPrice').value, category: document.getElementById('mCategory').value, spicy: "-", image: "", mimeType: "", fileName: "" };
                 if (mCode) { payload.id = mCode; }
                 sendAddMenu(payload);
            }
        });

        function uploadBankQRFile(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0]; const reader = new FileReader();
                const imgEl = document.getElementById('bankQRImage'); const originalSrc = imgEl.src; imgEl.style.opacity = '0.5';
                reader.onload = function(e) {
                      const base64Preview = e.target.result; imgEl.src = base64Preview;
                      compressImage(file, 600, 0.7).then(compressedBase64 => {
                          const base64Data = compressedBase64.split(',')[1];
                          const payload = { action: "uploadBankQR", image: base64Data, mimeType: "image/jpeg", folderId: QR_FOLDER_ID };
                          fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r => r.json()).then(d => {
                              if(d.result === 'success') {
                                  localStorage.setItem('bankQRID', d.fileId); localStorage.removeItem('promptPayID');
                                  showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î QR Code ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); initBankQR(); closeModal('manageQRModal');
                             } else { throw new Error(d.error); }
                          }).catch(err => { imgEl.src = originalSrc; showCustomAlert('Error', '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err); }).finally(() => { imgEl.style.opacity = '1'; });
                      });
                }; reader.readAsDataURL(file);
            }
        }

        function sendAddMenu(payload) {
             fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
             .then(r => r.json())
             .then(d => { 
                 if(d.result === 'success') { 
                     
                     // ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏±‡∏ö‡∏¢‡∏±‡∏î‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏•‡∏¢
                     const newItem = {
                         id: d.id || payload.id,      // ‡πÉ‡∏ä‡πâ ID ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏à‡∏≤‡∏Å Server ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏õ
                         name: payload.name,
                         price: parseFloat(payload.price),
                         category: payload.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
                         image: '',                   // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ
                         spicy: '-'
                     };
                     
                     addItemToCart(newItem, "-"); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

                     document.getElementById('searchInput').value = '';
                     
                     showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success'); 
                     closeModal('addModal'); 
                     fetchMenu(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ
                     document.getElementById('addMenuForm').reset(); 

                 } else { 
                     showCustomAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + d.error, '<i class="fas fa-exclamation-circle text-red-500"></i>'); 
                 } 
             })
             .catch(err => { 
                 showCustomAlert('Connection Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ'); 
             })
             .finally(() => setLoading('btnSaveMenu', false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å')); 
        }
        
        function confirmDeleteMenu() { setLoading('btnDeleteMenu', true, '‡∏•‡∏ö...'); fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "deleteMenu", id: document.getElementById('eId').value }) }).then(r=>r.json()).then(d=>{ if(d.result === 'success') { showToast('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success'); closeModal('editMenuModal'); fetchMenu(); } else { showCustomAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + d.error, '<i class="fas fa-exclamation-circle text-red-500"></i>'); } }).catch(err => showCustomAlert('Connection Error', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì')).finally(()=>setLoading('btnDeleteMenu', false, '‡∏•‡∏ö')); }
        function deleteMenu() { openConfirmActionModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ', '<i class="fas fa-trash-alt"></i>', confirmDeleteMenu); }
        function openConfirmActionModal(title, msg, iconHtml, confirmHandler) { document.getElementById('confirmActionTitle').innerText = title; document.getElementById('confirmActionMsg').innerText = msg; document.getElementById('confirmActionIcon').innerHTML = iconHtml; const confirmBtn = document.getElementById('btnConfirmAction'); confirmBtn.onclick = () => { closeModal('confirmActionModal'); confirmHandler(); }; document.getElementById('confirmActionModal').classList.remove('hidden'); }
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ function closeModal(id) ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡πâ‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ
        function closeModal(id) { 
            document.getElementById(id).classList.add('hidden'); 
            
            // üî¥ [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏•‡∏≠
            if (id === 'paymentModal') {
                const leftPanel = document.getElementById('leftPanel');
                if(leftPanel) leftPanel.classList.remove('blur-sm', 'opacity-50', 'pointer-events-none');
            }
            // -------------------------------------------------------------
        }
        function showToast(msg, type='success') { const toast = document.getElementById('toast'); const iconContainer = toast.querySelector('div:first-child'); const icon = iconContainer.querySelector('i'); if (type === 'warning') { toast.classList.remove('border-green-500'); toast.classList.add('border-yellow-500'); iconContainer.classList.replace('bg-green-100', 'bg-yellow-100'); icon.classList.replace('text-green-600', 'text-yellow-600'); icon.className = 'fas fa-bell'; } else { toast.classList.add('border-green-500'); toast.classList.remove('border-yellow-500'); iconContainer.classList.replace('bg-yellow-100', 'bg-green-100'); icon.classList.replace('text-yellow-600', 'text-green-600'); icon.className = 'fas fa-check'; } document.getElementById('toastMsg').innerText = msg; toast.style.transform = 'translateX(0)'; setTimeout(() => { toast.style.transform = 'translateX(150%)'; }, 3000); }
        function showCustomAlert(title, msg, icon='<i class="fas fa-info-circle text-blue-500"></i>') { document.getElementById('alertTitle').innerText = title; document.getElementById('alertMsg').innerText = msg; document.getElementById('alertIcon').innerHTML = icon; document.getElementById('customAlert').classList.remove('hidden'); }
        function closeCustomAlert() { document.getElementById('customAlert').classList.add('hidden'); }
        function setLoading(btnId, isLoading, text) { const btn = document.getElementById(btnId); let span = btn.querySelector('.btn-text'); let icon = btn.querySelector('i.fas'); if (!span && btnId === 'btnDeleteMenu') { if (btn.innerHTML.indexOf('<span class="btn-text">') === -1) { const originalText = btn.innerText; btn.innerHTML = `<span class="btn-text">${originalText}</span> <i class="fas fa-trash-alt"></i>`; } span = btn.querySelector('.btn-text'); icon = btn.querySelector('i.fas'); } else if (!span && btnId !== 'btnDeleteMenu') { if (btn.innerHTML.indexOf('<span class="btn-text">') === -1) { const originalText = btn.innerText; btn.innerHTML = `<span class="btn-text">${originalText}</span> <i class="fas fa-save"></i>`; } span = btn.querySelector('.btn-text'); icon = btn.querySelector('i.fas'); } if(isLoading) { btn.disabled = true; btn.classList.add('opacity-75', 'cursor-not-allowed'); if(span && !span.dataset.originalText) { span.dataset.originalText = span.innerText; } if(span) span.innerText = text; if(icon && !icon.dataset.originalClass) { icon.dataset.originalClass = icon.dataset.originalClass; } if(icon) { icon.className = "fas fa-circle-notch fa-spin"; } } else { btn.disabled = false; btn.classList.remove('opacity-75', 'cursor-not-allowed'); if(span && span.dataset.originalText) { span.innerText = span.dataset.originalText; delete span.dataset.originalText; span.removeAttribute('data-original-text'); } if(icon && icon.dataset.originalClass) { icon.className = icon.dataset.originalClass; delete icon.dataset.originalClass; icon.removeAttribute('data-original-class'); } } }

        function initStoreStatus() {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getStoreStatus" }) })
            .then(r => r.json())
            .then(d => {
                if (d.result === 'success') {
                    isStoreOpen = d.isOpen;
                    updateStoreUI();
                    
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î -> ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô
                    if (isCustomerMode && !isStoreOpen) {
                        document.getElementById('storeClosedModal').classList.remove('hidden');
                    }
                }
            });
        }

        function toggleStoreStatus() {
            if (isCustomerMode) return; // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
            
            const newStatus = !isStoreOpen;
            // Optimistic UI Update (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏£‡πá‡∏ß)
            isStoreOpen = newStatus;
            updateStoreUI();
            
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "setStoreStatus", isOpen: newStatus }) })
            .then(r => r.json())
            .then(d => {
                if (d.result !== 'success') {
                    // ‡∏ñ‡πâ‡∏≤‡∏û‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
                    isStoreOpen = !newStatus;
                    updateStoreUI();
                    showToast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'warning');
                } else {
                    showToast(isStoreOpen ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß' : '‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß', 'success');
                }
            });
        }

        function updateStoreUI() {
            const bg = document.getElementById('storeToggleBg');
            const dot = document.getElementById('storeToggleDot');
            const text = document.getElementById('storeStatusText');
            
            if (isStoreOpen) {
                // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î: ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß, ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤
                bg.className = "w-10 h-5 rounded-full relative transition-colors duration-300 shadow-inner flex items-center bg-green-500";
                dot.style.transform = "translateX(20px)"; // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤
                text.innerText = "‡πÄ‡∏õ‡∏¥‡∏î";
            } else {
                // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏¥‡∏î: ‡∏™‡∏µ‡πÅ‡∏î‡∏á, ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ã‡πâ‡∏≤‡∏¢
                bg.className = "w-10 h-5 rounded-full relative transition-colors duration-300 shadow-inner flex items-center bg-red-500";
                dot.style.transform = "translateX(0px)"; // ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢
                text.innerText = "‡∏õ‡∏¥‡∏î";
            }
        }

        function openMyRecentOrder() {
            const modal = document.getElementById('myOrderModal');
            const content = document.getElementById('myOrderContent');
            
            // üü¢ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (Object) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (myLastOrders && myLastOrders.items && myLastOrders.items.length > 0) { 
                const total = myLastOrders.total;
                const orderNote = myLastOrders.note || ''; // ‡∏î‡∏∂‡∏á Note ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏°‡∏≤
                
                // üî¥ FIX 2: ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏≤‡∏Å Note ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Regex
                let addressString = "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
                let remainingNote = orderNote;
                const addressMatch = orderNote.match(/\[‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà:\s*(.*?)\]/); // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö [‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà: ...]
                
                if (addressMatch && addressMatch[1]) {
                    addressString = addressMatch[1]; // ‡πÄ‡∏ä‡πà‡∏ô 99/9 ‡∏ã.15
                    remainingNote = orderNote.replace(addressMatch[0], '').trim(); // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏∑‡∏≠‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏£‡∏¥‡∏á‡πÜ
                }
                
                // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å LocalStorage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•)
                const cName = localStorage.getItem('customerName') || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
                const cPhone = localStorage.getItem('customerPhone') || '-';

                let html = `
                    <div class="text-center mb-6">
                        <h3 class="text-xl font-extrabold text-blue-600 mb-1">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h3>
                        <p class="text-xs text-gray-500">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-xl mb-4 border border-gray-200 shadow-inner">
                        <div class="font-bold text-sm text-gray-700 mb-2 border-b pb-2 border-dashed">
                           <i class="fas fa-user-tag mr-2 text-blue-600"></i> ‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á: ${cName} 
                           <span class="text-xs text-gray-500">(${cPhone})</span>
                        </div>
                        
                        <div class="text-sm text-gray-600">
                           <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>
                           ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á: <span class="font-bold">${addressString}</span>
                        </div>

                        ${remainingNote ? 
                            `<div class="text-xs text-gray-500 mt-2 pt-2 border-t border-dashed">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${remainingNote}</div>` 
                            : ''
                        }

                        <div class="text-xs text-gray-500 mt-2 pt-2 border-t">
                           ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡πà‡∏á: ${new Date(myLastOrders.timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}
                        </div>
                    </div>

                    <div class="space-y-3">
                `;

                myLastOrders.items.forEach(item => { // ‡πÉ‡∏ä‡πâ myLastOrders.items ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Loop
                    const itemTotal = item.price * item.qty;
                    html += `
                        <div class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
                            <div>
                                <h4 class="font-bold text-gray-700">${item.name}</h4>
                                <div class="text-xs text-gray-500">${item.price} x ${item.qty}</div>
                            </div>
                            <div class="font-bold text-blue-600">${itemTotal.toLocaleString()} ‡∏ø</div>
                        </div>
                    `;
                });
                
                html += `</div>
                    <div class="mt-4 pt-4 border-t border-dashed border-gray-300 flex justify-between items-center">
                        <span class="text-gray-600 font-bold">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        <span class="text-2xl font-bold text-blue-600">${total.toLocaleString()} ‡∏ø</span>
                    </div>
                    <div class="mt-6 text-center">
                        <p class="text-green-600 font-bold text-sm mb-2"><i class="fas fa-check-circle"></i> ‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß</p>
                        <button onclick="closeModal('myOrderModal')" class="bg-gray-800 text-white w-full py-3 rounded-xl font-bold hover:bg-gray-900 transition">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
                    </div>
                `;
                content.innerHTML = html;
            } else {
                 content.innerHTML = '<div class="text-center py-10"><i class="fas fa-shopping-basket text-4xl text-gray-300 mb-2"></i><p class="text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p></div>';
            }
            modal.classList.remove('hidden');
        }

       // ==========================================
        // üîê LOGIN SYSTEM (UPDATED)
        // ==========================================
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Login ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Login ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á Login)
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Login ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)
        function checkLoginStatus() {
            const loginScreen = document.getElementById('loginScreen');
            
            // 1. üü¢ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const urlParams = new URLSearchParams(window.location.search);
            const isCustomer = urlParams.get('mode') === 'customer';
            
            if (isCustomer || (typeof isCustomerMode !== 'undefined' && isCustomerMode)) {
                loginScreen.classList.add('hidden');
                
                // üëá ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?
                checkCustomerIdentity(); 
                
                initStoreStatus(); 
                return; 
            }

            // 2. üîê ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (Admin) ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ Login ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
            // const isLoggedIn = 'true'; // ‚¨ÖÔ∏è üö® ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
            const isLoggedIn = localStorage.getItem('isLoggedIn'); //‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            if (isLoggedIn === 'true') {
                loginScreen.classList.add('hidden');
                initStoreStatus(); 
            } else {
                loginScreen.classList.remove('hidden');
            }
        }

        // --- üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ---
        // --- üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà) ---
        function checkCustomerIdentity() {
            const savedName = localStorage.getItem('customerName');
            const savedPhone = localStorage.getItem('customerPhone');
            // üü¢ ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤
            const savedHouseNo = localStorage.getItem('customerAddrHouse');
            const savedSoi = localStorage.getItem('customerAddrSoi');
            
            if (!savedName || !savedPhone || !savedHouseNo || !savedSoi) { // üü¢ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á Modal ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å
                document.getElementById('customerIdentityModal').classList.remove('hidden');
                
                // Pre-fill address fields if they were previously saved
                if (savedHouseNo) document.getElementById('custIdHouseNo').value = savedHouseNo;
                if (savedSoi) document.getElementById('custIdSoi').value = savedSoi;

            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô (Customer Toolbar)
                document.getElementById('customerTableDisplay').innerText = savedName;
            }
        }

        // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà)
        document.getElementById('customerIdentityForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('custIdName').value.trim();
            const phone = document.getElementById('custIdPhone').value.trim();
            // üü¢ ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
            const houseNo = document.getElementById('custIdHouseNo').value.trim();
            const soi = document.getElementById('custIdSoi').value.trim();
            
            if(!name || !phone || !houseNo || !soi) { // üü¢ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
                return;
            }
            if(phone.length < 9 || isNaN(phone)) {
                showToast('‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'warning');
                return;
            }
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
            localStorage.setItem('customerName', name);
            localStorage.setItem('customerPhone', phone);
            // üü¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
            localStorage.setItem('customerAddrHouse', houseNo);
            localStorage.setItem('customerAddrSoi', soi);
            
            // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            document.getElementById('customerIdentityModal').classList.add('hidden');
            document.getElementById('customerTableDisplay').innerText = name;
            showToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ${name}`, 'success');
            speak("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏∞");
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á Login
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // ‡∏ã‡πà‡∏≠‡∏ô Error ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            const errorBox = document.getElementById('loginErrorBox');
            errorBox.classList.add('hidden');
            
            const phone = document.getElementById('loginPhone').value.trim();
            const pass = document.getElementById('loginPass').value.trim();
            
            setLoading('btnLogin', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...');
            
            fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: "login", phone: phone, password: pass }) 
            })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {

                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                    // Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('userPhone', phone);
                    
                    showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    
                    // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Login
                    const screen = document.getElementById('loginScreen');
                    screen.style.opacity = '0';
                    setTimeout(() => {
                        screen.classList.add('hidden');
                        initStoreStatus(); 
                    }, 500);
                    
                } else {
                    // üî¥ ‡πÅ‡∏™‡∏î‡∏á Error ‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏î‡∏á ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Login
                    document.getElementById('loginErrorMsg').innerText = data.error || '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                    errorBox.classList.remove('hidden');
                    
                    // ‡∏™‡∏±‡πà‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á Login ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
                    const card = document.querySelector('#loginScreen > div');
                    card.classList.add('animate-pulse');
                    setTimeout(() => card.classList.remove('animate-pulse'), 500);
                }
            })
            .catch(err => {
                // ‡πÅ‡∏™‡∏î‡∏á Error ‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏î‡∏á
                document.getElementById('loginErrorMsg').innerText = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ';
                errorBox.classList.remove('hidden');
            })
            .finally(() => {
                setLoading('btnLogin', false, '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
            });
        });

        // üî¥ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Logout (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Modal ‡∏™‡∏ß‡∏¢‡πÜ)
        function logout() {
            document.getElementById('logoutModal').classList.remove('hidden');
        }

        // üî¥ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Logout (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á)
        function confirmLogout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userPhone');
            location.reload(); 
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Updated) ---
        function openChangePassModal() {
            // ‡∏î‡∏∂‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡πÅ‡∏ï‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
            const currentPhone = localStorage.getItem('userPhone') || '';
            document.getElementById('changePassPhone').value = currentPhone;
            
            document.getElementById('newPasswordInput').value = '';
            document.getElementById('changePassModal').classList.remove('hidden');
            
            // ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
            setTimeout(() => document.getElementById('changePassPhone').focus(), 300);
        }

        function submitChangePassword() {
            // üî¥ ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å LocalStorage ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            const phoneVal = document.getElementById('changePassPhone').value.trim();
            const newPass = document.getElementById('newPasswordInput').value.trim();
            
            if (!phoneVal) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"); return; }
            if (!newPass) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà"); return; }

            setLoading('btnSubmitChangePass', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
            
            fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: "changePassword", phone: phoneVal, newPassword: newPass }) 
            })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    showToast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                    closeModal('changePassModal');
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏≠‡∏∑‡πà‡∏ô)
                    localStorage.setItem('userPhone', phoneVal);
                } else {
                    alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + data.error);
                }
            })
            .catch(err => { alert('Error: ' + err); })
            .finally(() => { setLoading('btnSubmitChangePass', false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà'); });
        }

        // ==========================================
        // üõ°Ô∏è SECURITY: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
        // ==========================================
        function setupPasswordRestrictions() {
            const passwordFields = ['loginPass', 'newPasswordInput'];
            
            passwordFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', function(e) {
                        // Regex: ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏ä‡πà‡∏ß‡∏á Unicode ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (\u0E00-\u0E7F)
                        const thaiRegex = /[\u0E00-\u0E7F]/g;
                        
                        if (thaiRegex.test(this.value)) {
                            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡πÑ‡∏ó‡∏¢ ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                            this.value = this.value.replace(thaiRegex, '');
                            
                            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ö‡∏≤‡πÜ (‡∏™‡∏±‡πà‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô Toast)
                            showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'warning');
                            
                            // ‡∏ó‡∏≥‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏™‡∏±‡πà‡∏ô‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á input
                            this.classList.add('border-red-500', 'animate-pulse');
                            setTimeout(() => {
                                this.classList.remove('border-red-500', 'animate-pulse');
                            }, 500);
                        }
                    });
                }
            });
        }

        function makeDraggable(draggableElement, dragHandle) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

    // üî¥ 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Mouse ‡πÅ‡∏•‡∏∞ Touch
    if (dragHandle) {
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Mouse
        dragHandle.onmousedown = dragMouseDown;
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Touch
        dragHandle.ontouchstart = dragMouseDown; // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    } else {
        draggableElement.onmousedown = dragMouseDown;
        draggableElement.ontouchstart = dragMouseDown;
    }

    function dragMouseDown(e) {
        e = e || window.event;
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (Scroll)
        e.preventDefault(); 
        
        // üî¥ 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Touch Event ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        let clientX = e.clientX;
        let clientY = e.clientY;

        if (e.touches && e.touches.length) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        }

        // ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå/‡∏ô‡∏¥‡πâ‡∏ß
        pos3 = clientX;
        pos4 = clientY;
        
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
        
        // üî¥ 3. ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå Touchmove ‡πÅ‡∏•‡∏∞ Touchend
        document.ontouchend = closeDragElement;
        document.ontouchmove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        
        // üî¥ 4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Touch Event ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        let clientX = e.clientX;
        let clientY = e.clientY;

        if (e.touches && e.touches.length) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå/‡∏ô‡∏¥‡πâ‡∏ß
        pos1 = pos3 - clientX;
        pos2 = pos4 - clientY;
        pos3 = clientX;
        pos4 = clientY;
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Modal Card
        draggableElement.style.top = (draggableElement.offsetTop - pos2) + "px";
        draggableElement.style.left = (draggableElement.offsetLeft - pos1) + "px";
    }

    function closeDragElement() {
        // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå/‡∏ô‡∏¥‡πâ‡∏ß
        document.onmouseup = null;
        document.onmousemove = null;
        
        // üî¥ 5. ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå Touch
        document.ontouchend = null;
        document.ontouchmove = null;
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π 3 ‡∏à‡∏∏‡∏î
function togglePaymentMenu() {
    const menu = document.getElementById('paymentSettingsMenu');
    if (menu) {
        // ‡∏™‡∏•‡∏±‡∏ö class hidden ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô
        if (menu.classList.contains('hidden')) {
            menu.classList.remove('hidden');
        } else {
            menu.classList.add('hidden');
        }
    }
}

// --- FLOATING NUMPAD LOGIC ---

// 1. ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Numpad
function toggleFloatingNumpad() {
    const pad = document.getElementById('floatingNumpad');
    if (pad.classList.contains('hidden')) {
        pad.classList.remove('hidden');
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á (reuse ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
        const header = document.getElementById('numpadHeader');
        makeDraggable(pad, header); 
    } else {
        pad.classList.add('hidden');
    }
}

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô numpadPress ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö btnElement ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
function numpadPress(num, btnElement) {
    playNotificationSound(); 

    // --- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Ñ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏õ‡∏∏‡πà‡∏° (Animation) ---
    if (btnElement) {
        // ‡∏•‡∏ö class ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô (‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏£‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πâ‡∏≤‡∏á)
        btnElement.classList.remove('active:scale-95'); 
        btnElement.classList.add('btn-pop');
        
        // ‡∏£‡∏≠ 150ms ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
        setTimeout(() => {
            btnElement.classList.remove('btn-pop');
            btnElement.classList.add('active:scale-95');
        }, 150);
    }
    // ----------------------------------------
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤ "‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô" ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°?
    const paymentModal = document.getElementById('paymentModal');
    const isPaymentOpen = !paymentModal.classList.contains('hidden');

    let targetInput;

    if (isPaymentOpen) {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô -> ‡∏¢‡∏¥‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
        targetInput = document.getElementById('inputReceived');
    } else {
        // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ -> ‡∏¢‡∏¥‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏™‡πÅ‡∏Å‡∏ô
        targetInput = document.getElementById('searchInput');
        targetInput.focus(); 
    }

    if (targetInput) {
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
        targetInput.value += num;
        // Trigger Event ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô
        targetInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
}

// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô numpadAction ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡πâ‡∏™‡πà‡∏ß‡∏ô action === 'enter' ‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö

function numpadAction(action) {
    const paymentModal = document.getElementById('paymentModal');
    const isPaymentOpen = !paymentModal.classList.contains('hidden');
    
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏™ del)
    let targetInput = isPaymentOpen ? document.getElementById('inputReceived') : document.getElementById('searchInput');

    if (action === 'del') {
        // ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡∏î
        targetInput.value = targetInput.value.slice(0, -1);
        
        // Trigger Event ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô)
        targetInput.dispatchEvent(new Event('input', { bubbles: true }));
        targetInput.focus();
    } 
    else if (action === 'enter') {
        if (isPaymentOpen) {
            // ‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà -> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
            confirmPayment();
        } else {
            // üî¥ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ dispatchEvent ‡πÅ‡∏•‡πâ‡∏ß)
            processSearchEnter();
        }
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏õ‡πâ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏∞‡∏ö‡∏ö (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Ç‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)
function toggleSystemKeyboard() {
    const input = document.getElementById('searchInput');
    const btn = document.getElementById('btnToggleKey');
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    if (input.getAttribute('inputmode') === 'none') {
        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏õ‡πâ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏∞‡∏ö‡∏ö
        input.setAttribute('inputmode', 'text');
        btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600'); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
        btn.classList.remove('bg-white', 'text-gray-400', 'border-gray-200');
        input.placeholder = "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...";
        input.focus();
    } else {
        // ‡∏õ‡∏¥‡∏î‡πÅ‡∏õ‡πâ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏∞‡∏ö‡∏ö (‡πÉ‡∏ä‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå/‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏à‡∏≠)
        input.setAttribute('inputmode', 'none');
        btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
        btn.classList.add('bg-white', 'text-gray-400', 'border-gray-200');
        input.placeholder = "‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î...";
        input.blur(); // ‡∏´‡∏∏‡∏ö‡πÅ‡∏õ‡πâ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏•‡∏á
    }
}

// ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠/‡∏Ç‡∏¢‡∏≤‡∏¢ Numpad
let isEmbeddedNumpadOpen = true;

function toggleEmbeddedNumpad() {
    const panel = document.getElementById('embeddedNumpadPanel');
    const keys = document.getElementById('embeddedKeys');
    const miniBar = document.getElementById('minimizedBar');
    
    isEmbeddedNumpadOpen = !isEmbeddedNumpadOpen;
    
    if (isEmbeddedNumpadOpen) {
        // ‡πÄ‡∏õ‡∏¥‡∏î (‡∏Ç‡∏¢‡∏≤‡∏¢)
        keys.classList.remove('hidden');
        miniBar.classList.add('hidden');
        // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Ñ‡∏™‡πÑ‡∏•‡∏î‡πå (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô‡πÜ ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ max-height ‡πÅ‡∏ï‡πà‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î)
    } else {
        // ‡∏õ‡∏¥‡∏î (‡∏¢‡πà‡∏≠)
        keys.classList.add('hidden');
        miniBar.classList.remove('hidden');
    }
}

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô function renderCart)
const originalRenderCart = renderCart;
renderCart = function() {
    originalRenderCart(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡πá‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const totalEl = document.getElementById('totalPrice');
    const miniTotal = document.getElementById('miniTotalDisplay');
    if(totalEl && miniTotal) {
        miniTotal.innerText = totalEl.innerText;
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° Desktop ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏ï‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏° Mobile
    const btnMobile = document.getElementById('btnOrderMobile'); // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏° (Mobile)
    const btnDesktop = document.getElementById('btnOrderDesktop'); // ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (Desktop Enter)
    
    if(btnMobile && btnDesktop) {
        
    }
};


// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export PDF ---
        function openExportModal() {
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('exportStartDate').value = today;
            document.getElementById('exportEndDate').value = today;
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function executeExportPDF() {
            const type = document.getElementById('exportType').value;
            const start = document.getElementById('exportStartDate').value;
            const end = document.getElementById('exportEndDate').value;

            if (!start || !end) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');
                return;
            }

            setLoading('btnDoExport', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...');

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: "exportPDF",
                    reportType: type,
                    startDate: start,
                    endDate: end
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.result === 'success') {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Link ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Base64
                    const link = document.createElement('a');
                    link.href = "data:application/pdf;base64," + data.base64;
                    link.download = `Report_${type}_${start}_${end}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showToast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                    closeModal('exportModal');
                } else {
                    showCustomAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + data.error);
                }
            })
            .catch(err => {
                console.error(err);
                showCustomAlert('Connection Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
            })
            .finally(() => {
                setLoading('btnDoExport', false, '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF');
            });
        }


// ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener: ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π
document.addEventListener('click', function(event) {
    const menu = document.getElementById('paymentSettingsMenu');
    const btn = document.querySelector('button[onclick="togglePaymentMenu()"]');
    
    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏° 3 ‡∏à‡∏∏‡∏î -> ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π
    if (menu && !menu.classList.contains('hidden')) {
        if (!menu.contains(event.target) && !btn.contains(event.target)) {
            menu.classList.add('hidden');
        }
    }
});


        
        /// Window Load
        const originalOnload = window.onload;
        window.onload = () => {
            checkLoginStatus(); 
            initStoreStatus(); // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô
            
            // üëá ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
            setupPasswordRestrictions(); // ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏ó‡∏¢
            
            // üî¥ NEW: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Make Draggable
            const modal = document.getElementById("draggableModal");
            const header = document.getElementById("modalHeader");
            if (modal && header) {
                makeDraggable(modal, header);
            }
            // ------------------------------------
            
            if (originalOnload) originalOnload();
        };



        
    </script>
</body>

</html>
